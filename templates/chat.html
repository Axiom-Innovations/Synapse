<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synapse | Axiom</title>

    <!-- External Libraries -->
    <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <!-- Twemoji for emoji rendering -->
    <script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js" crossorigin="anonymous"></script>


    <!-- Favicon and Fonts -->
    <link rel="icon" href="/static/images/logo-primary.png" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">

    <!-- Icon Libraries -->
    <link rel="stylesheet" href="https://cdn.lineicons.com/3.0/lineicons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Theme Initialization -->
    <script>
        // Set theme based on localStorage or system preference to avoid FOUC
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>

    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Ubuntu', 'sans-serif'],
                    },
                    colors: { // Custom color palettes matching Jinja variables
                        primary: { 50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc', 400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 800: '#075985', 900: '#0c4a6e', 950: '#082f49' },
                        secondary: { 50: '#f5f3ff', 100: '#ede9fe', 200: '#ddd6fe', 300: '#c4b5fd', 400: '#a78bfa', 500: '#8b5cf6', 600: '#7c3aed', 700: '#6d28d9', 800: '#5b21b6', 900: '#4c1d95', 950: '#2e1065' },
                        nature: { 50: '#f0fdf4', 100: '#dcfce7', 200: '#bbf7d0', 300: '#86efac', 400: '#4ade80', 500: '#22c55e', 600: '#16a34a', 700: '#15803d', 800: '#166534', 900: '#14532d', 950: '#052e16' },
                        nature_second: { 50: '#f0fdfa', 100: '#ccfbf1', 200: '#99f6e4', 300: '#5eead4', 400: '#2dd4bf', 500: '#14b8a6', 600: '#0d9488', 700: '#0f766e', 800: '#115e59', 900: '#134e4a', 950: '#042f2e' },
                        vibrant: { 50: '#faf5ff', 100: '#f3e8ff', 200: '#e9d5ff', 300: '#d8b4fe', 400: '#c084fc', 500: '#a855f7', 600: '#9333ea', 700: '#7e22ce', 800: '#6b21a8', 900: '#581c87', 950: '#3b0764' },
                        vibrant_second: { 50: '#fdf2f8', 100: '#fce7f3', 200: '#fbcfe8', 300: '#f9a8d4', 400: '#f472b6', 500: '#ec4899', 600: '#db2777', 700: '#be185d', 800: '#9d174d', 900: '#831843', 950: '#500724' },
                        sunset: { 50: '#fffbeb', 100: '#fef3c7', 200: '#fde68a', 300: '#fcd34d', 400: '#fbbf24', 500: '#f59e0b', 600: '#d97706', 700: '#b45309', 800: '#92400e', 900: '#78350f', 950: '#451a03' },
                        sunset_second: { 50: '#fef2f2', 100: '#fee2e2', 200: '#fecaca', 300: '#fca5a5', 400: '#f87171', 500: '#ef4444', 600: '#dc2626', 700: '#b91c1c', 800: '#991b1b', 900: '#7f1d1d', 950: '#450a0a' }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-slow': 'bounce 2s infinite',
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'slide-down': 'slideDown 0.3s ease-out',
                        'scale': 'scale 0.3s ease-out',
                        'spin-slow': 'spin 3s linear infinite',
                        'float': 'float 3s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        slideDown: { '0%': { transform: 'translateY(-10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        scale: { '0%': { transform: 'scale(0.95)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                    }
                }
            }
        }
    </script>

    <!-- Custom CSS Styles -->
    <style>
        /* Base body styles */
        body {
            font-family: "Ubuntu", sans-serif;
            background-color: rgba(245, 245, 245, 0.89); /* Default light background */
        }
        html, body {
            height: 100%;
            overflow: hidden; /* Prevent body scroll */
        }
        .dark body {
             background-color: #1f2937; /* Default dark background */
        }

        /* Responsive adjustments */
        @media screen and (max-width: 768px) {
            body {
                overflow: scroll; /* Allow scrolling on smaller screens */
            }
            #chat-box {
              padding-bottom: 7rem; /* More padding at bottom on mobile for input */
            }
        }

        /* Chat Area Background Styling */
        #chat-area-container {
            position: relative;
        }
        #chat-area-container::before {
            content: "";
            position: absolute;
            inset: 0;
            background-color: rgba(255,255,255,0.65); /* Light mode tint */
            background-image: url('/static/images/chat-bg.png');
            background-position: center;
            background-repeat: repeat;
            background-size: contain; /* Or 'cover' or specific size */
            z-index: 0;
            pointer-events: none;
            transition: background-color 0.3s ease, filter 0.3s ease;
            filter: brightness(1.0); /* Light mode brightness */
        }
        .dark #chat-area-container::before {
            background-color: rgba(17,24,39,0.75); /* Dark mode tint */
            filter: brightness(0.2); /* Dark mode brightness */
        }

        /* Ensure scrollable chat box is above the background */
        #chat-box {
            position: relative;
            z-index: 1;
            background: transparent !important; /* Make chatbox transparent */
        }
        #no-chat-message {
            position: relative;
            z-index: 1; /* Also above background */
        }


        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #0ea5e9; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #0284c7; }
        * { scrollbar-width: thin; scrollbar-color: #0ea5e9 transparent; }


        /* Simple Fade-in Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }


        /* Glassmorphism (Optional - Applied via JS/Tailwind perhaps?) */
        .glass {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        .dark .glass {
            background: rgba(17, 24, 39, 0.75);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }


        /* Emoji Picker Specific Styles */
        #emoji-picker { width: 300px; }
        #emoji-picker-tabs { display: flex; overflow-x: auto; }
        #emoji-picker-tabs button {
            padding: 0.5rem 1rem; border: none; background-color: transparent; cursor: pointer;
            color: #6b7280; border-bottom: 2px solid transparent;
        }
        .dark #emoji-picker-tabs button { color: #9ca3af; }
        #emoji-picker-tabs button.active { color: #0ea5e9; border-bottom-color: #0ea5e9; font-weight: 500; }

        .emoji-category-panel {
            padding: 0.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(24px, 1fr));
            gap: 0.5rem; width: 100%; /* Fit container */ max-height: 200px; overflow-y: auto;
        }
        .emoji-category-panel button {
            border: none; background-color: transparent; cursor: pointer;
            font-size: 1.2rem; padding: 0; line-height: 1;
        }

        #panel-search-results {
            padding: 0.5rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(24px, 1fr));
            gap: 0.5rem;
            width: 100%;
            max-height: 200px; /* Same height as category panels */
            overflow-y: auto;
        }

        #emoji-suggestion-popup {
    max-width: 80%; /* Prevent it getting too wide */
    bottom: 100%;  /* Start positioning above the input bar */
    margin-bottom: 4px; /* Small gap */
    /* Hide scrollbar */
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none;  /* IE and Edge */
}
#emoji-suggestion-popup::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Opera */
    height: 0;
    width: 0;
}

#emoji-suggestion-popup button {
    background: none;
    border: none;
    padding: 4px 6px;
    font-size: 1.4rem; /* Make emojis reasonably sized */
    cursor: pointer;
    border-radius: 4px;
    transition: background-color 0.1s ease;
    line-height: 1; /* Ensure proper vertical alignment */
}

#emoji-suggestion-popup button:hover {
    background-color: rgba(0, 0, 0, 0.1); /* Subtle hover */
}
.dark #emoji-suggestion-popup button:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

/* Jumbo Emoji Styling */
.jumbo-emoji-message {
    background-color: transparent !important; /* Override Tailwind bg */
    box-shadow: none !important;             /* Remove shadow */
    padding-top: 0 !important;              /* Adjust padding if needed */
    padding-bottom: 0 !important;
}

/* Style for the text content within the jumbo bubble */
.jumbo-emoji-message .message-content-display {
    font-size: 2.8rem; /* Adjust size as desired ( Tailwind ~text-5xl) */
    line-height: 1.2;  /* Adjust line height for better spacing */
}

/* Optional: Adjust timestamp position/style for jumbo emojis */
.jumbo-emoji-message .text-xs {
    /* Maybe make timestamp slightly smaller or position differently? */
    /* Example: Push it further down slightly */
    /* margin-top: 0.5rem;  */
    /* For now, we keep default styling */
}
        /* Sidebar Active Tab Styling */
        .active-tab {
            background-color: rgba(14, 165, 233, 0.1); /* primary-500 with opacity */
            color: #0ea5e9; /* primary-500 */
            font-weight: 600;
        }

    /* --- Desktop Emoji Picker Enhancements --- */
    @media (min-width: 768px) { /* Apply styles for medium screens and up */

/* Make the picker popup wider */
#emoji-picker {
    width: 400px; /* Increased from 300px - Adjust as desired */
}

/* Make the emoji buttons (font size) bigger inside panels */
.emoji-category-panel button,
#panel-search-results button { /* Target buttons in categories AND search */
    font-size: 1.5rem; /* Increased from 1.2rem - Adjust as desired */
    /* Optional: Add a little padding for easier clicking */
     /* padding: 0.1em; */
}

/* Adjust the grid layout to accommodate bigger emojis */
.emoji-category-panel,
#panel-search-results {
    /* Increase the minimum column size */
    grid-template-columns: repeat(auto-fit, minmax(36px, 1fr)); /* Increased from 24px - Adjust as needed */
    /* Optional: Adjust gap if needed */
    /* gap: 0.6rem; */
}
}
/* --- End Desktop Emoji Picker Enhancements --- */
        /* Desktop Container Styling (Non-Mobile) */

        {% if not on_phone %}
        @media (min-width: 768px) {
            body {
                display: flex; /* Use flexbox for centering */
                align-items: center;
                justify-content: center;
            }
            #app-container {
                border: 1px solid rgba(0,0,0,0.05); /* Subtle border */
                width: 100%;
                height: 100%;
                max-width: 96%; /* Limit max width */
                max-height: 96%; /* Limit max height */
                border-radius: 1rem; /* md:rounded-2xl */
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* md:shadow-xl */
                overflow: hidden; /* Important for border-radius */
                margin: auto; /* Center in viewport */
            }
            .dark #app-container {
                 border: 1px solid rgba(255, 255, 255, 0.1); /* Dark mode border */
            }
        }
        {% endif %}
    </style>
</head>
<body class="transition-colors duration-300">
<!-- ADD THIS SECTION -->
<!-- Login Overlay -->
<div id="login-overlay" class="fixed inset-0 bg-gray-800 bg-opacity-95 flex items-center justify-center z-50">
    <form id="chat-login-form" class="bg-white dark:bg-gray-700 p-8 rounded-lg shadow-xl w-full max-w-sm">
        <h2 class="text-2xl font-bold mb-6 text-center text-gray-800 dark:text-gray-200">Synapse Chat Login</h2>
        <div id="login-error-message" class="text-red-500 text-sm mb-4 text-center" style="display: none;"></div>
        <div class="mb-4">
            <label for="login-username" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Username or Email</label>
            <input type="text" id="login-username" name="username" required autocomplete="username" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-600 dark:text-white">
        </div>
        <div class="mb-6">
            <label for="login-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
            <input type="password" id="login-password" name="password" required autocomplete="current-password" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-600 dark:text-white">
        </div>
        <button type="submit" id="login-submit-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">
            Login
        </button>
         <!-- Optional: Link to main app registration -->
         <!-- <p class="text-xs text-center mt-4 text-gray-500 dark:text-gray-400">Need an account? <a href="https://your-main-app-domain.com/register" target="_blank" class="text-blue-500 hover:underline">Register</a></p> -->
    </form>
</div>
<!-- END OF ADDED SECTION -->
<div id="chat-container" class="hidden">
{% if on_phone %}
    <!-- Mobile Layout: Sidebar and Chat Area are siblings, JS toggles visibility -->
    <div class="h-screen flex flex-col md:flex-row"> <!-- Ensure full height -->
        <!-- Sidebar -->
        <aside class="w-full md:w-1/4 bg-white dark:bg-gray-800 border-r dark:border-gray-700 overflow-y-auto flex flex-col shadow-md relative transition-transform duration-300 ease-in-out">
            <!-- Sidebar Header -->
            <div class="flex items-center justify-between px-4 py-3 border-b dark:border-gray-700">
                <div>
                    <h1 class="text-lg font-bold text-gray-800 dark:text-white">Synapse</h1>
                    <p class="text-xs text-gray-500 dark:text-gray-400">By Axiom Innovations</p>
                </div>
                <div>
                    <img id="current-user-profile-image" src="/static/images/default.png" alt="Settings"
                         onclick="window.location.href='/settings'"
                         class="w-8 h-8 rounded-full object-cover cursor-pointer hover:opacity-80 transition" />
                </div>
            </div>

            <!-- Sidebar Tabs -->
            <div class="flex justify-around border-b dark:border-gray-700 text-gray-600 dark:text-gray-300 text-sm font-medium" id="sidebar-tabs">
                <button id="tab-chats" class="flex-1 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 transition active-tab">Chats</button>
                <button id="tab-connect" class="flex-1 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 transition">Connect</button>
                <button id="tab-more" class="flex-1 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 transition">More</button>
            </div>

            <!-- User List / Content Area -->
            <div id="user-list" class="flex-1 overflow-y-auto">
                <!-- User list loaded dynamically -->
            </div>

            <!-- Floating Action Button (Mobile/Tablet Specific) -->
            <button id="switchToConnectBtn"
                    class="fixed bottom-6 right-6 bg-primary-500 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center text-3xl hover:bg-primary-600 transition duration-300 z-10 md:hidden"
                    title="Find people to connect">
                +
            </button>
        </aside>

        <!-- Chat Area (Initially hidden on mobile, shown when a chat is selected) -->
        <div id="chat-area-container" class="hidden flex-1 flex-col bg-gray-50 dark:bg-gray-900 relative">
            <!-- Chat Header (Fixed position on mobile) -->
            <div id="chat-header" class="hidden p-4 bg-white dark:bg-gray-800 border-b dark:border-gray-700 w-full fixed top-0 left-0 z-20 flex items-center shadow-sm">
                <!-- Mobile Back Button -->
                <button id="backToUsers" class="block md:hidden p-2 mr-2 text-gray-500 hover:text-gray-600 dark:text-gray-400 dark:hover:text-gray-300">
                    <i class="fa fa-arrow-left"></i>
                </button>

                <!-- User Pic and Info -->
                <img id="chat-user-pic" src="" class="w-10 h-10 mr-3 rounded-full object-cover flex-shrink-0" alt="Chat User" />
                <div class="flex-grow min-w-0">
                    <h2 id="chat-username" class="text-lg font-semibold text-gray-800 dark:text-gray-200 cursor-pointer truncate">Select a user</h2>
                    <p id="chat-user-status" class="text-sm text-gray-500 dark:text-gray-400 cursor-pointer truncate">Status: ---</p>
                </div>

                <!-- Header Options -->
                <div class="ml-auto relative flex items-center space-x-2 flex-shrink-0">
                    <button id="pingUserButton"
                            class="hidden p-2 text-yellow-500 hover:text-yellow-600 dark:text-yellow-400 dark:hover:text-yellow-300 transition-colors duration-200"
                            title="Ping user" aria-label="Ping user">
                        <i class="fas fa-bell text-xl"></i>
                    </button>
                    <button id="darkModeToggle" class="p-2 text-gray-500 hover:text-gray-600 dark:text-gray-400 dark:hover:text-gray-300 transition-colors duration-200">
                        <i class="lni lni-sun text-xl dark:hidden"></i>
                        <i class="lni lni-night hidden dark:block text-xl"></i>
                    </button>
                    <button id="optionsDropdownButton" class="p-2 text-gray-500 hover:text-gray-600 dark:text-gray-400 dark:hover:text-gray-300 transition-colors duration-200">
                        <i class="fas fa-ellipsis text-xl"></i>
                    </button>
                    <!-- Options Dropdown Menu -->
                    <div id="optionsDropdown" class="hidden absolute right-0 top-full mt-2 w-48 bg-white dark:bg-gray-700 rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none z-30">
                        <div class="py-1">
                            <a href="#" onclick="openUserInfoModal(); closeOptionsDropdown();" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600">View Profile</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600">Block User</a>
                            <a href="#" class="block px-4 py-2 text-sm text-red-700 dark:text-red-300 hover:bg-gray-100 dark:hover:bg-gray-600">Report User</a>
                        </div>
                    </div>
                    <!-- ADD THIS BUTTON -->
                    <button id="logout-button" style="display:none; position: fixed; top: 10px; right: 10px; z-index: 60;" class="bg-red-500 hover:bg-red-700 text-white px-3 py-1 rounded shadow-md text-sm font-medium">Logout</button>
                </div>
            </div>

            <!-- Chat Message Box -->
            <div id="chat-box" class="flex-1 overflow-y-auto p-4 pt-20 pb-28 space-y-4">
                <!-- "No chat selected" placeholder (centered) -->
                 <div id="no-chat-message" class="flex flex-col items-center justify-center h-full text-center text-gray-600 dark:text-gray-400">
                     <i class="fas fa-comments text-5xl mb-4 text-primary-500 animate-pulse-slow"></i>
                     <h2 class="text-xl font-semibold mb-2">No chat selected</h2>
                     <p class="text-sm max-w-xs">Select a chat or use <span class="font-semibold text-primary-500">Connect</span> 💬</p>
                 </div>
                <!-- Messages loaded dynamically -->
            </div>

            <!-- Chat Input Bar (Fixed position on mobile) -->
            <div id="chat-input-bar" class="hidden p-4 bg-white dark:bg-gray-800 flex items-center space-x-2 border-t dark:border-gray-700 shadow-sm fixed bottom-0 left-0 w-full z-20">
                <input type="file" id="media-input" accept="image/*, video/*" class="hidden" />
                <button onclick="document.getElementById('media-input').click()" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200 flex-shrink-0" title="Attach media">
                    <i class="fas fa-paperclip text-gray-500 dark:text-gray-400"></i>
                </button>
                <div class="relative flex-1">
                    <input id="message-input" class="border rounded-full py-3 px-5 focus:ring-primary-500 focus:border-primary-500 bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm w-full" placeholder="Type a message..." />
                    <button id="emoji-button" type="button" class="absolute inset-y-0 right-3 flex items-center text-gray-500 hover:text-gray-600 dark:text-gray-400 dark:hover:text-gray-300" title="Insert emoji">
                        <i class="far fa-smile text-xl"></i>
                    </button>
                    <!-- Emoji Picker Popup -->
                    <div id="emoji-picker" class="hidden absolute bottom-full mb-2 right-0 z-30 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg">
                        <div id="emoji-picker-tabs" role="tablist">
                            <button id="tab-smileys" class="emoji-tab-button active" role="tab">Smileys</button>
                            <button id="tab-animals" class="emoji-tab-button" role="tab">Nature</button>
                            <button id="tab-food" class="emoji-tab-button" role="tab">Food</button>
                            <button id="tab-activity" class="emoji-tab-button" role="tab">Activity</button>
                            <button id="tab-travel" class="emoji-tab-button" role="tab">Travel</button>
                            <button id="tab-objects" class="emoji-tab-button" role="tab">Objects</button>
                            <button id="tab-symbols" class="emoji-tab-button" role="tab">Symbols</button>
                            <button id="tab-flags" class="emoji-tab-button" role="tab">Flags</button>
                        </div>
                        <div id="emoji-picker-panels">
                            <div id="panel-smileys" class="emoji-category-panel" role="tabpanel"></div>
                            <div id="panel-animals" class="emoji-category-panel hidden" role="tabpanel"></div>
                            <div id="panel-food" class="emoji-category-panel hidden" role="tabpanel"></div>
                            <div id="panel-activity" class="emoji-category-panel hidden" role="tabpanel"></div>
                            <div id="panel-travel" class="emoji-category-panel hidden" role="tabpanel"></div>
                            <div id="panel-objects" class="emoji-category-panel hidden" role="tabpanel"></div>
                            <div id="panel-symbols" class="emoji-category-panel hidden" role="tabpanel"></div>
                            <div id="panel-flags" class="emoji-category-panel hidden" role="tabpanel"></div>
                        </div>
                    </div>
                </div>
                <button id="send-btn" class="px-4 py-2 bg-primary-500 text-white rounded-full hover:bg-primary-600 focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50 transition-colors duration-200 font-semibold flex-shrink-0" title="Send message">
                    <i class="lni lni-telegram-original text-xl"></i>
                </button>
            </div>
        </div>
    </div>

{% else %}
    <!-- Desktop Layout: Contained within #app-container -->
    <div id="app-container" class="flex transition-colors duration-300">
        <!-- Sidebar -->
        <aside class="w-1/4 bg-white dark:bg-gray-800 border-r dark:border-gray-700 overflow-y-auto flex flex-col shadow-md relative">
            <!-- Sidebar Header -->
            <div class="flex items-center justify-between px-4 py-3 border-b dark:border-gray-700">
                <div>
                    <h1 class="text-lg font-bold text-gray-800 dark:text-white">Synapse</h1>
                    <p class="text-xs text-gray-500 dark:text-gray-400">By Axiom Innovations</p>
                </div>
                <div>
                    <img src="{{current_user.profile_image}}" alt="Settings"
                         onclick="window.location.href='/settings'"
                         class="w-8 h-8 rounded-full object-cover cursor-pointer hover:opacity-80 transition" />
                </div>
            </div>

            <!-- Sidebar Tabs -->
            <div class="flex justify-around border-b dark:border-gray-700 text-gray-600 dark:text-gray-300 text-sm font-medium" id="sidebar-tabs">
                <button id="tab-chats" class="flex-1 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 transition active-tab">Chats</button>
                <button id="tab-connect" class="flex-1 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 transition">Connect</button>
                <button id="tab-more" class="flex-1 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 transition">More</button>
            </div>

            <!-- User List / Content Area -->
            <div id="user-list" class="flex-1 overflow-y-auto">
                <!-- User list loaded dynamically -->
            </div>

            <!-- Floating Action Button (Desktop Specific - inside sidebar) -->
            <button id="switchToConnectBtn"
                    class="absolute bottom-4 right-4 bg-primary-500 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center text-3xl hover:bg-primary-600 transition duration-300 z-10"
                    title="Find people to connect">
                +
            </button>
        </aside>

        <!-- Chat Area -->
        <div id="chat-area-container" class="flex-1 flex flex-col bg-gray-50 dark:bg-gray-900 relative">
            <!-- Chat Header (Absolute position within chat area) -->
            <div id="chat-header" class="hidden p-4 bg-white dark:bg-gray-800 border-b dark:border-gray-700 w-full absolute top-0 left-0 z-20 flex items-center shadow-sm">
                <!-- Back button hidden on desktop -->
                <button id="backToUsers" class="hidden p-2 mr-2 text-gray-500">
                    <i class="fa fa-arrow-left"></i>
                </button>

                <!-- User Pic and Info -->
                <img id="chat-user-pic" src="" class="w-10 h-10 mr-3 rounded-full object-cover flex-shrink-0" alt="Chat User" />
                <div class="flex-grow min-w-0">
                    <h2 id="chat-username" class="text-xl font-semibold text-gray-800 dark:text-gray-200 cursor-pointer truncate">Select a user</h2>
                    <p id="chat-user-status" class="text-sm text-gray-500 dark:text-gray-400 cursor-pointer truncate">Status: ---</p>
                </div>

                <!-- Header Options -->
                <div class="ml-auto relative flex items-center space-x-2 flex-shrink-0">
                    <button id="pingUserButton"
                            class="hidden p-2 text-yellow-500 hover:text-yellow-600 dark:text-yellow-400 dark:hover:text-yellow-300 transition-colors duration-200"
                            title="Ping user" aria-label="Ping user">
                        <i class="fas fa-bell text-xl"></i>
                    </button>
                    <button id="darkModeToggle" class="p-2 text-gray-500 hover:text-gray-600 dark:text-gray-400 dark:hover:text-gray-300 transition-colors duration-200">
                        <i class="lni lni-sun text-xl dark:hidden"></i>
                        <i class="lni lni-night hidden dark:block text-xl"></i>
                    </button>
                    <button id="optionsDropdownButton" class="p-2 text-gray-500 hover:text-gray-600 dark:text-gray-400 dark:hover:text-gray-300 transition-colors duration-200">
                        <i class="fas fa-ellipsis text-xl"></i>
                    </button>
                    <!-- Options Dropdown Menu -->
                    <div id="optionsDropdown" class="hidden absolute right-0 top-full mt-2 w-48 bg-white dark:bg-gray-700 rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none z-30">
                        <div class="py-1">
                             <a href="#" onclick="openUserInfoModal(); closeOptionsDropdown();" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600">View Profile</a>
                             <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600">Block User</a>
                             <a href="#" class="block px-4 py-2 text-sm text-red-700 dark:text-red-300 hover:bg-gray-100 dark:hover:bg-gray-600">Report User</a>
                        </div>
                    </div>
                    <!-- ADD THIS BUTTON -->
<button id="logout-button" style="display:none; position: fixed; top: 10px; right: 10px; z-index: 60;" class="bg-red-500 hover:bg-red-700 text-white px-3 py-1 rounded shadow-md text-sm font-medium">Logout</button>
                </div>
            </div>

            <!-- Chat Message Box -->
            <div id="chat-box" class="flex-1 overflow-y-auto pt-24 pb-28 px-4 space-y-4"> <!-- Adjust padding for header/input -->
                <!-- "No chat selected" placeholder (centered) -->
                <div id="no-chat-message" class="flex flex-col items-center justify-center h-full text-center text-gray-600 dark:text-gray-400">
                    <i class="fas fa-comments text-5xl mb-4 text-primary-500 animate-pulse-slow"></i>
                    <h2 class="text-xl font-semibold mb-2">No chat selected</h2>
                    <p class="text-sm max-w-sm">Pick someone from the left, or use <span class="font-semibold text-primary-500">Connect</span> 💬</p>
                </div>
                 <!-- Messages loaded dynamically -->
            </div>

            <!-- (Inside the main chat area container, maybe after #chat-input-bar) -->
            <div id="emoji-suggestion-popup" class="hidden absolute z-30 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg px-2 py-1 overflow-x-auto whitespace-nowrap" style="height: 50px;">
                <!-- Emoji suggestions will be added here dynamically -->
            </div>
            <!-- Chat Input Bar (Absolute position within chat area) -->
            <div id="chat-input-bar" class="hidden p-4 bg-white dark:bg-gray-800 flex items-center space-x-2 border-t dark:border-gray-700 shadow-sm absolute bottom-0 left-0 w-full z-20">
                <input type="file" id="media-input" accept="image/*, video/*" class="hidden" />
                <button onclick="document.getElementById('media-input').click()" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200 flex-shrink-0" title="Attach media">
                    <i class="fas fa-paperclip text-gray-500 dark:text-gray-400"></i>
                </button>
                <div class="relative flex-1">
                    <input id="message-input" class="border rounded-full py-3 px-5 focus:ring-primary-500 focus:border-primary-500 bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm w-full" placeholder="Type a message..." />
                    <button id="emoji-button" type="button" class="absolute inset-y-0 right-3 flex items-center text-gray-500 hover:text-gray-600 dark:text-gray-400 dark:hover:text-gray-300" title="Insert emoji">
                        <i class="far fa-smile text-xl"></i>
                    </button>
                     <!-- Emoji Picker Popup -->
                     <div id="emoji-picker" class="hidden absolute bottom-full mb-2 right-0 z-30 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg">
                         <div id="emoji-picker-tabs" role="tablist">
                            <button id="tab-smileys" class="emoji-tab-button active" role="tab">
                                <i class="far fa-smile"></i>
                            </button>
                            <button id="tab-animals" class="emoji-tab-button" role="tab">
                                <i class="fas fa-paw"></i>
                            </button>
                            <button id="tab-food" class="emoji-tab-button" role="tab">
                                <i class="fas fa-utensils"></i>
                            </button>
                            <button id="tab-activity" class="emoji-tab-button" role="tab">
                                <i class="fas fa-futbol"></i>
                            </button>
                            <button id="tab-travel" class="emoji-tab-button" role="tab">
                                <i class="fas fa-plane"></i>
                            </button>
                            <button id="tab-objects" class="emoji-tab-button" role="tab">
                                <i class="fas fa-lightbulb"></i>
                            </button>
                            <button id="tab-symbols" class="emoji-tab-button" role="tab">
                                <i class="fas fa-star"></i>
                            </button>
                            <button id="tab-flags" class="emoji-tab-button" role="tab">
                                <i class="fas fa-flag"></i>
                            </button>
                         </div>
                         <!-- Search Input -->
                         <div class="p-2 dark:border-gray-600">
                             <input type="text" id="emoji-search-input" placeholder="Search emojis..." class="w-full px-2 py-1 dark:border-gray-500 rounded-lg bg-gray-50 dark:bg-gray-600 text-sm focus:ring-primary-500 focus:border-primary-500">
                         </div>
                         <!-- Emoji Panels -->
                         <div id="emoji-picker-panels">
                            <div id="panel-smileys" class="emoji-category-panel" role="tabpanel"></div>
                            <div id="panel-animals" class="emoji-category-panel hidden" role="tabpanel"></div>
                            <div id="panel-food" class="emoji-category-panel hidden" role="tabpanel"></div>
                            <div id="panel-activity" class="emoji-category-panel hidden" role="tabpanel"></div>
                            <div id="panel-travel" class="emoji-category-panel hidden" role="tabpanel"></div>
                            <div id="panel-objects" class="emoji-category-panel hidden" role="tabpanel"></div>
                            <div id="panel-symbols" class="emoji-category-panel hidden" role="tabpanel"></div>
                            <div id="panel-flags" class="emoji-category-panel hidden" role="tabpanel"></div>
                            
                            <!-- Search Results Panel -->
                            <div id="panel-search-results" class="emoji-category-panel hidden" role="tabpanel">
                                 <!-- Search results populated here -->
                                 <p id="emoji-no-results" class="text-xs text-gray-500 dark:text-gray-400 text-center col-span-full hidden">No emojis found.</p>
                            </div>
                         </div>
                     </div>
                </div>
                <button id="send-btn" class="px-4 py-2 bg-primary-500 text-white rounded-full hover:bg-primary-600 focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50 transition-colors duration-200 font-semibold flex-shrink-0" title="Send message">
                    <i class="lni lni-telegram-original text-xl"></i>
                </button>
            </div>

        </div>
    </div>
{% endif %}
</div>
<!-- Modals (Common to both layouts, placed outside main layout structure) -->

<!-- User Info Modal -->
<div id="user-info-modal" class="hidden fixed z-40 inset-0 overflow-y-auto" aria-labelledby="user-info-modal-title" role="dialog" aria-modal="true">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <!-- Modal Overlay -->
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 dark:bg-black dark:bg-opacity-60 transition-opacity" aria-hidden="true" onclick="closeUserInfoModal()"></div>
        <!-- Centering Trick -->
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">​</span>
        <!-- Modal Panel -->
        <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <!-- Content dynamically loaded here -->
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-200" id="user-info-modal-title">
                            User Information
                        </h3>
                        <div class="mt-4" id="user-info-modal-content">
                            <!-- User details will be injected here by JS -->
                            <p class="text-sm text-gray-500">Loading user data...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button id="user-info-profile-button" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary-600 text-base font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:ml-3 sm:w-auto sm:text-sm" disabled>
                    View Full Profile
                </button>
                <button id="modal-close-btn" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>


<!-- Media Preview Modal -->
<div id="media-preview-modal" class="hidden fixed inset-0 z-50 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 transition-opacity duration-300 ease-out" aria-labelledby="media-preview-title" role="dialog" aria-modal="true">
    <div id="media-preview-dialog" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl overflow-hidden max-w-lg w-full transform transition-all duration-300 ease-out scale-95 opacity-0">
        <div class="px-4 pt-4 pb-2 sm:px-6 sm:pt-5">
            <h3 id="media-preview-title" class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">Send Media</h3>
        </div>
        <div class="px-4 py-2 sm:p-6 bg-gray-100 dark:bg-gray-700 flex justify-center items-center min-h-[200px] max-h-[60vh]">
            <img id="media-preview-image" src="" alt="Media preview" class="hidden max-w-full max-h-[55vh] object-contain">
            <video id="media-preview-video" src="" class="hidden max-w-full max-h-[55vh]" controls></video>
            <div id="media-preview-error" class="hidden text-red-500 text-center">
                <i class="fas fa-exclamation-triangle text-3xl mb-2"></i>
                <p>Could not preview this file.</p>
            </div>
        </div>
        <div class="px-4 py-3 sm:px-6 bg-white dark:bg-gray-800 space-y-3">
            <input type="text" id="media-preview-caption" placeholder="Add a caption..." class="border rounded-md py-2 px-3 bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm w-full focus:ring-primary-500 focus:border-primary-500">
            <div class="flex justify-end space-x-3">
                <button id="media-preview-cancel" type="button" class="inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white dark:bg-gray-600 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 sm:text-sm">Cancel</button>
                <button id="media-preview-send" type="button" class="inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary-500 text-base font-medium text-white hover:bg-primary-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:text-sm">
                    Send <i class="lni lni-telegram-original text-xl ml-2"></i>
                </button>
            </div>
        </div>
    </div>
</div>


<!-- Media Viewer Modal -->
<div id="media-viewer-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-85 flex items-center justify-center p-4 transition-opacity duration-200 ease-out" aria-labelledby="media-viewer-title" role="dialog" aria-modal="true">
    <div class="relative max-w-4xl max-h-[90vh] w-full h-full flex items-center justify-center">
        <button id="media-viewer-close" class="absolute -top-2 -right-2 md:top-2 md:right-2 z-10 bg-gray-800 bg-opacity-50 text-white rounded-full p-2 leading-none hover:bg-opacity-75 focus:outline-none" aria-label="Close media viewer">
            <i class="fas fa-times text-xl"></i>
        </button>
        <img id="media-viewer-image" src="" alt="Media Viewer" class="hidden object-contain max-w-full max-h-full">
        <video id="media-viewer-video" src="" class="hidden max-w-full max-h-full" controls controlsList="nodownload"></video>
        <div id="media-viewer-loading" class="hidden text-white">
            <i class="fas fa-spinner fa-spin text-4xl"></i>
        </div>
    </div>
</div>


<!-- Message Options Dropdown -->
<div id="message-options-dropdown"
     class="hidden absolute z-30 w-48 bg-white dark:bg-gray-700 rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none"
     data-message-id="">
    <div class="py-1" role="none">
        <button data-action="reply" class="message-option-button block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600" role="menuitem">
            <i class="fas fa-reply mr-2 w-4 text-center"></i>Reply
        </button>
        <button data-action="copy" class="message-option-button block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600" role="menuitem">
            <i class="fas fa-copy mr-2 w-4 text-center"></i>Copy Text
        </button>
        <hr class="border-gray-200 dark:border-gray-600 my-1">
        <button data-action="delete-me" class="message-option-button block w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-600" role="menuitem">
            <i class="fas fa-trash-alt mr-2 w-4 text-center"></i>Delete for Me
        </button>
        <button data-action="delete-everyone" class="message-option-button block w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-600" role="menuitem" style="display: none;">
            <i class="fas fa-globe-americas mr-2 w-4 text-center"></i>Delete for Everyone
        </button>
    </div>
</div>


<!-- Audio Elements -->
<audio id="notification-sound" src="/static/audio/msg.wav" preload="auto"></audio>
<audio id="ping-sound" src="/static/audio/msg.wav" preload="auto"></audio>

<!-- Main Application Script -->
<script>
    // --- DOM Element References ---
    const getElement = (id) => document.getElementById(id);
    const querySelector = (selector) => document.querySelector(selector);
    const querySelectorAll = (selector) => document.querySelectorAll(selector);

    let userListContainer = null;
    let chatBox = null;
    let chatHeader = null;
    let chatInputBar = null;
    let messageInput = null;
    let sendButton = null;
    let chatUsernameElement = null;
    let chatUserPicElement = null;
    let chatUserStatusElement = null;
    let noChatMessageElement = null;
    let backToUsersButton = null;
    let darkModeToggle = null;
    let optionsDropdownButton = null;
    let optionsDropdown = null;
    let userInfoModal = null;
    let userInfoModalContent = null;
    let modalCloseBtn = null;
    let emojiButton = null;
    let emojiPicker = null;
    let mediaInput = null;
    let mediaPreviewModal = null;
    let mediaPreviewDialog = null;
    let mediaPreviewImage = null;
    let mediaPreviewVideo = null;
    let mediaPreviewError = null;
    let mediaPreviewCaption = null;
    let mediaPreviewSend = null;
    let mediaPreviewCancel = null;
    let mediaViewerModal = null;
    let mediaViewerImage = null;
    let mediaViewerVideo = null;
    let mediaViewerCloseBtn = null;
    let mediaViewerLoading = null;
    let messageOptionsDropdown = null;
    let notificationSound = null;
    let pingSound = null;
    let pingUserButton = null;
    let floatingConnectButton = null;
    let emojiSearchInput = null;
    let emojiSearchResultsPanel = null;
    let emojiNoResults = null;
    let emojiSuggestionPopup = null;


    // --- Configuration & Constants ---
    const STATUS_CHECK_INTERVAL_MS = 30000; // Interval for active chat status checks
    const ALL_USERS_CHECK_INTERVAL_MS = 60000; // Interval for background user list status checks
    const TYPING_TIMER_LENGTH = 1500; // ms before sending 'stop_typing' event
    const CHAT_PREVIEW_POLL_INTERVAL_MS = 4000; // Interval for polling chat previews in sidebar
    const DEFAULT_AVATAR = '/static/images/default.png'; // Path to default avatar
    const MAX_FILE_SIZE_MB = 10; // Max upload size in MB
    const MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_MB * 1024 * 1024;
    const EMOJI_SEARCH_DEBOUNCE_MS = 250; // Debounce delay


    // --- State Variables ---
    const currentUserId = {{ current_user.id }};
    const userColorScheme = '{{ current_user.color_scheme }}'; // User's preferred color scheme
    let receiverId = null; // ID of the user currently being chatted with
    let currentReceiverUser = null; // Full data object of the current chat partner
    let lastMessageDate = null; // Tracks the date of the last message for adding separators
    let activeChatStatusInterval = null; // Interval ID for polling the active chat partner's status
    let allUsersStatusInterval = null; // Interval ID for polling status of users in the sidebar list
    let chatPreviewPollInterval = null; // Interval ID for polling sidebar chat previews
    let typingTimer = null; // Timeout ID for the typing indicator
    let isTyping = false; // Flag indicating if the current user is typing
    let originalStatusHTML = ''; // Stores the chat header status before showing 'typing...'
    let currentOpenDropdownMessageId = null; // ID of the message whose options dropdown is open
    let isInitialLoadComplete = false; // Flag to track if initial setup and data load is done
    let currentPreviewFile = null; // Reference to the file being previewed before upload
    let currentPreviewUrl = null; // Object URL for the media preview
    let pingButtonCooldownTimer = null; // Timeout ID for the ping button cooldown
    let emojiSearchDebounceTimer = null; // Timeout ID for emojiSearch
    let isSuggestionPopupVisible = false;
    let currentSuggestionKeyword = ''; // Track the keyword being suggested for


    // --- Emoji Data (MOVED TO GLOBAL SCOPE) ---
    const emojiCategories = {
        smileys: [ /* ... all smiley emojis ... */ '❤️','😀','😃','😄','😁','😆','🥹','😅','😂','🤣','🥲','🙂','😊','😇','🙂','🙃','😉','😌', '😍','🥰','😘','😗','😙','😚','😋','😛','😝','😜','🤪','🤨','🧐','🤓','😎','🥸','🤩', '🥳','🙂‍↕️','😏','😒','🙂‍↔️','😞','😔','😟','😕','🙁','☹️','😣','😖','😫','😩','🥺', '😢','😭','😤','😠','😡','🤬','🤯','😳','🥵','🥶','🫡','🫢','🤭','🫣','🤔','🤗','😓', '😥','😰','😨','😱','😶‍🌫️','🤫','🫠','🤥','😶','🫥','😐','🫤','😑','🫨','😬','🙄', '😯','🤐','😵‍💫','😵','😮‍💨','😪','🤤','😴','🥱','😲','😮','😧','😦','🥴','🤢','🤮', '🤧','😷','🤒','🤕','🤑','🤠','😈','👿','👹','😸','😺','🎃','🤖','👾','👽','☠️','💀', '👻','💩','🤡','👺','😹','😻','😼','😽','🙀','😿','😾','🫶','🤲','👐','🙌','👏','🤝', '👍','👎','👊','✊','🤛','🤜','🫷','🫸','🤞','✌️','🫰','🤟','🤘','👌','🤌','🤏','🫳', '🫴','👈','👉','👆','👇','☝️','✋','🤚','🖐️','🖖','👋','🤙','🫲','🫱','💪','🦾','🖕', '✍️','🙏','🫵','🦶','🦵','🦿','💄','💋','👄','🫦','🦷','👅','👀','🫀','🫁','🧠','🗣️', '👤','👥','🫂','👁️','👣','🤰','🫄','🫃','🤱','👩‍🍼','🧑‍🍼','👨‍🍼','💁‍♀️','💁','💁‍♂️', '🙅‍♀️','🙅','🙅‍♂️','🙆‍♀️','🙆‍♂️','🙋‍♀️','🙋‍♂️','🤦‍♀️','🤦‍♂️','🤷‍♂️','🤷‍♀️','👩‍❤️‍👨','💑'],
        animals: [ /* ... all animal emojis ... */ '🐶', '🐱', '🐭', '🐹', '🐰', '🦊', '🐻', '🐼', '🐨', '🐯', '🦁', '🐮', '🐷', '🐸', '🐒', '🐔', '🐧', '🐦', '🦉', '🦋', '🐛', '🐜', '🐝', '🐞', '🐟', '🐠', '🐡', '🐢', '🐳', '🐬', '🐙', '🐚', '🦀', '🦞', '🦐', '🦑','🦖','🦕','🦒','🦓','🐘','🦏','🦍','🦧','🐪','🐫','🐿️','🦔','🦦','🦇','🐺'],
        food: [ /* ... all food emojis ... */ '🍕', '🍔', '🍟', '🌭', '🥪', '🌮', '🌯', '🥙', '🧆', '🥚', '🍳', '🍿', '🧈', '🥨', '🥐', '🍞', '🥖', '🫓', '🥞', '🧇', '🧀', '🍖', '🍗', '🥩', '🥓', '🌭', '🍔', '🍟', '🍕', '🥪', '🌮', '🌯', '🫔', '🥙', '🧆', '🥚', '🍳', '🥘', '🍲', '🥣', '🥗', '🥙', '🧆', '🫕', '🥫', '🍣', '🍱', '🍘', '🍙', '🍚', '🍛', '🍜', '🍝', '🍠', '🍢', '🍡', '🍧', '🍨', '🍦', '🥧', '🍰', '🎂', '🍮', '🍭', '🍬', '🍫', '🍿', '🍩', '🍪', '🌰', '🥜', '🍯', '🥛', '🍼', '☕', '🍵', '🍶', '🍺', '🍻', '🍷', '🥂', '🥃', '🍸', '🍹', '🧉', '🥤', '🧃', '🧉', '🧊','🥝','🥥','🍇','🍈','🍉','🍊','🍋','🍌','🍍','🥭','🍎','🍏','🍐','🍑','🍒','🍓'],
        activity: [ /* ... all activity emojis ... */ '⚽', '🏀', '🏈', '⚾', '🎾', '🏐', '🏓', '🏸', '🏒', '🏑', '🏏', '🎿', '🏂', '⛷️', '⛸️', '🎣', '🎽', '🥋', '🥊', '🥅', '⛳', '🏹', '🎯', '🥌', '🎱', '🪁', '🪀', '🛝', '🛹', '🛴', '🚲', '🛵', '🛶', '⛵', '🛥️', '🛳️', '⛴️', '🚢', '✈️', '🛬', '🚀', '🛸', '🛰️', '🌠', '🌌', '🌃', '🌉', '🌆', '🌇', '🌅', '🌄', '☀️', '🌤️', '🌥️', '🌦️', '🌧️', '⛈️', '🌩️', '🌨️', '❄️', '☃️', '🌬️', '💨', '🌫️', '☔', '☂️', '🌈', '⚡', '🔥', '💧', '🌊', '💧', '🌊', '🌫️', '☔', '☂️', '🌈', '⚡', '🔥', '💧', '🌊', '🌲', '🌳', '🌴', '🌵', '🌱', '🌿', '☘️', '🍀', '🎍', '🪴', '🍁', '🍂', '🍃', '🌾', '🌺', '🌻', '🌹', '🥀', '🌷', '🌸', '🌼', '💐', '🍄'],
        travel: [ /* ... all travel emojis ... */ '🚀', '🚗', '🚕', '🚙', '🚌', '🚎', '🚓', '🚑', '🚒', '🚐', '🚚', '🚛', '🚜', '🏎️', '🏍️', '🛵', '🚲', '🛴', '🛹', '🚏', '🛣️', '🛤️', '⛽', '🚨', '🚥', '🚦', '🚧', '🛑', '⚓', '🛕', '🏘️', '🏠', '🏡', '🏢', '🏣', '🏥', '🏦', '🏨', '🏩', '💒', '🏫', '🏬', '🏭', '🏯', '🏰', '🏕️', '⛺', '🛖', '🏛️', '🧱', '🪵', '🪨', '🗿', '🛣️', '🛤️', '🛤️', '🌉', '🌃', '🏙️', '🌆', '🌇', '🌅', '🌄', '🌃', '🌉', '🏙️', '🌆', '🌇', '🌅', '🌄', '🌌', '🌠', '🎇', '🎆', '🌃', '🌉', '🏙️', '🌆', '🌇', '🌅', '🌄', '🌌', '🌠', '🎇', '🎆', '🎡', '🎢', '🎠', '⛲', '⛱️', '🏖️', '🏝️', '🏜️', '🌋', '⛰️', '🏔️', '🗻', '🏕️', '⛺', '🛖', '🏛️', '🧱', '🪵', '🪨', '🗿', '⛩️', '🕍', '🕌', '🕋'],
        objects: [ /* ... all object emojis ... */ '⚙️', '🧰', '🧱', '🪵', '🪨', '🗿', '💯', '💢', '💬', '💭', '💣', '💥', '💫', '💦', '💨', '🕳️', '👋', '👏', '🙌', '🤝', '🙏', '✍️', '💅', '🤳', '💪', '👂', '👃', '🧠', '🦷', '🦴', '👀', '👁️', '👅', '👄', '💋', '💘', '💝', '💖', '💗', '💓', '💞', '💕', '💔', '❤️‍🔥', '❤️‍🩹', '💯', '🏧', '🚮', '🚾', '🛂', '🛃', '🛄', '🚹', '🚺', '🚻', '🎦', '📶', '📳', '📴', '♻️', '🉑', '☢️', '☣️', '⚠️', '🚸', '⛔', '🚫', '🚷', '📵', '🔞', '☢️', '☣️'],
        symbols: [ /* ... all symbol emojis ... */ '⬆️', '↗️', '➡️', '↘️', '⬇️', '↙️', '⬅️', '↖️', '↕️', '↔️', '↩️', '↪️', '⤴️', '⤵️', '🔀', '🔁', '🔂', '🔄', '🔃', '⬆️', '➡️', '⬇️', '⬅️', '🔄','➕','➖','➗','✖️','♾️','✔️','☑️','💲',' ©️','®️','™️','#️⃣','*️⃣','0️⃣','1️⃣','2️⃣','3️⃣','4️⃣','5️⃣','6️⃣','7️⃣','8️⃣','9️⃣','🔟','🔠','🔡','🔢','🔣','🔤','🅰️','🆎','🅱️','🆑','🆒','🆓','ℹ️','🆔','Ⓜ️','🆕','🆖','🅾️','🆗','🅿️','🆘','🆙','🆚','🔴','🟠','🟡','🟢','🔵','🟣','🟤','⚫','⚪','🟥','🟧','🟨','🟩','🟦','🟪','🟫','⬛','⬜','◼️','◻️','◾','◽','▪️','▫️','🔶','🔷','🔸','🔹','🔺','🔻','💠','🔘','🔳','🔲'],
        flags: [ /* ... all flag emojis ... */ '🇦🇫', '🇦🇱', '🇩🇿', '🇦🇸', '🇦🇩', '🇦🇴', '🇦🇮', '🇦🇶', '🇦🇬', '🇦🇷', '🇦🇲', '🇦🇼', '🇦🇺', '🇦🇹', '🇦🇿', '🇧🇸', '🇧🇭', '🇧🇩', '🇧🇧', '🇧🇾', '🇧🇪', '🇧🇿', '🇧🇯', '🇧🇲', '🇧🇹', '🇧🇴', '🇧🇦', '🇧🇼', '🇧🇷', '🇮🇴', '🇻🇬', '🇧🇳', '🇧🇬', '🇧🇫', '🇧🇮', '🇰🇭', '🇨🇲', '🇨🇦', '🇨🇻', '🇰🇾', '🇨🇫', '🇹🇩', '🇨🇱', '🇨🇳', '🇨🇽', '🇨🇨', '🇨🇴', '🇰🇲', '🇨🇬', '🇨🇩', '🇨🇰', '🇨🇷', '🇭🇷', '🇨🇺', '🇨🇾', '🇨🇿', '🇩🇰', '🇩🇯', '🇩🇲', '🇩🇴', '🇪🇨', '🇪🇬', '🇸🇻', '🇬🇶', '🇪🇷', '🇪🇪', '🇸🇿', '🇪🇹', '🇪🇺', '🇫🇰', '🇫🇴', '🇫🇯', '🇫🇮', '🇫🇷', '🇬🇫', '🇵🇫', '🇹🇫', '🇬🇦', '🇬🇲', '🇬🇪', '🇩🇪', '🇬🇭', '🇬🇮', '🇬🇷', '🇬🇱', '🇬🇩', '🇬🇵', '🇬🇺', '🇬🇹', '🇬🇬', '🇬🇳', '🇬🇼', '🇬🇾', '🇭🇹', '🇭🇳', '🇭🇰', '🇭🇺', '🇮🇸', '🇮🇳', '🇮🇩', '🇮🇷', '🇮🇶', '🇮🇪', '🇮🇲', '🇮🇱', '🇮🇹', '🇨🇮', '🇯🇲', '🇯🇵', '🇯🇪', '🇯🇴', '🇰🇿', '🇰🇪', '🇰🇮', '🇽🇰', '🇰🇼', '🇰🇬', '🇱🇦', '🇱🇻', '🇱🇧', '🇱🇸', '🇱🇷', '🇱🇾', '🇱🇮', '🇱🇹', '🇱🇺', '🇲🇴', '🇲🇰', '🇲🇬', '🇲🇼', '🇲🇾', '🇲🇻', '🇲🇱', '🇲🇹', '🇲🇭', '🇲🇶', '🇲🇷', '🇲🇺', '🇾🇹', '🇲🇽', '🇫🇲', '🇲🇩', '🇲🇨', '🇲🇳', '🇲🇪', '🇲🇸', '🇲🇦', '🇲🇿', '🇲🇲', '🇳🇦', '🇳🇷', '🇳🇵', '🇳🇱', '🇳🇨', '🇳🇿', '🇳🇮', '🇳🇪', '🇳🇬', '🇳🇺', '🇲🇵', '🇰🇵', '🇰🇷', '🇳🇴', '🇴🇲', '🇵🇰', '🇵🇼', '🇵🇸', '🇵🇦', '🇵🇬', '🇵🇾', '🇵🇪', '🇵🇭', '🇵🇱', '🇵🇹', '🇵🇷', '🇶🇦', '🇷🇪', '🇷🇴', '🇷🇺', '🇷🇼', '🇼🇸', '🇸🇲', '🇸🇹', '🇸🇦', '🇸🇳', '🇷🇸', '🇸🇨', '🇸🇱', '🇸🇬', '🇸🇰', '🇸🇮', '🇸🇧', '🇸🇴', '🇿🇦', '🇬🇸', '🇸🇸', '🇪🇸', '🇱🇰', '🇸🇩', '🇸🇷', '🇸🇪', '🇨🇭', '🇸🇾', '🇹🇼', '🇹🇯', '🇹🇿', '🇹🇭', '🇹🇱', '🇹🇬', '🇹🇰', '🇹🇴', '🇹🇹', '🇹🇳', '🇹🇷', '🇹🇲', '🇹🇨', '🇹🇻', '🇺🇬', '🇺🇦', '🇦🇪', '🇬🇧', '🇺🇸', '🇺🇾', '🇺🇿', '🇻🇺', '🇻🇪', '🇻🇳', '🇾🇪', '🇿🇲', '🇿🇼']
    };
    const emojiKeywords = {
    // --- Smileys & People ---
    '❤️': ['love', 'heart', 'red', 'wow', 'proud', 'kiss', 'smooch'],
    '😀': ['grinning', 'face', 'smile', 'happy', 'joy', 'grin', 'smiley'],
    '😃': ['grinning', 'face', 'big', 'eyes', 'smile', 'happy', 'joy', 'haha', 'mouth', 'smiley'],
    '😄': ['grinning', 'face', 'smiling', 'eyes', 'happy', 'joy', 'funny', 'haha', 'laugh', 'like', 'smiley'],
    '😁': ['beaming', 'face', 'smiling', 'eyes', 'grin', 'happy', 'joy', 'satisfied', 'smiley'],
    '😆': ['grinning', 'squinting', 'face', 'happy', 'haha', 'laugh', 'satisfied', 'lol', 'smiley'],
    '🥹': ['face', 'holding', 'back', 'tears', 'sad', 'cry', 'proud', 'resist', 'emotional', 'smiley'],
    '😅': ['grinning', 'face', 'sweat', 'happy', 'hot', 'nervous', 'anxious', 'haha', 'smiley'],
    '😂': ['face', 'tears', 'joy', 'laugh', 'cry', 'haha', 'funny', 'lol', 'smiley'],
    '🤣': ['rolling', 'floor', 'laughing', 'rofl', 'lol', 'haha', 'funny', 'smiley'],
    '🥲': ['smiling', 'face', 'tear', 'happy', 'sad', 'cry', 'grateful', 'touched', 'smiley'],
    '☺️': ['smiling', 'face', 'blush', 'happy', 'proud', 'flushed', 'shy', 'smiley'],
    '😊': ['smiling', 'face', 'eyes', 'happy', 'blush', 'proud', 'satisfied', 'joy', 'smiley'],
    '😇': ['smiling', 'face', 'halo', 'angel', 'innocent', 'heaven', 'good', 'smiley'],
    '🙂': ['slightly', 'smiling', 'face', 'happy', 'content', 'ok', 'smiley'],
    '🙃': ['upside', 'down', 'face', 'silly', 'sarcasm', 'goofy', 'playful', 'smiley'],
    '😉': ['winking', 'face', 'flirt', 'joke', 'secret', 'playful', 'wink', 'smiley'],
    '😌': ['relieved', 'face', 'calm', 'peace', 'relaxed', 'satisfied', 'content', 'smiley'],
    '😍': ['smiling', 'face', 'heart', 'eyes', 'love', 'crush', 'adore', 'infatuation', 'smiley'],
    '🥰': ['smiling', 'face', 'hearts', 'love', 'adore', 'crush', 'affection', 'fondness', 'smiley'],
    '😘': ['face', 'blowing', 'kiss', 'flirt', 'love', 'affection', 'goodbye', 'smiley'],
    '😗': ['kissing', 'face', 'pucker', 'whistle', 'innocent', 'smiley'],
    '😙': ['kissing', 'face', 'smiling', 'eyes', 'pucker', 'affection', 'fond', 'smiley'],
    '😚': ['kissing', 'face', 'closed', 'eyes', 'pucker', 'affection', 'love', 'sweet', 'smiley'],
    '😋': ['face', 'savoring', 'food', 'delicious', 'yum', 'tasty', 'tongue', 'lick', 'smiley'],
    '😛': ['face', 'tongue', 'stuck', 'out', 'playful', 'silly', 'cheeky', 'smiley'],
    '😝': ['squinting', 'face', 'tongue', 'stuck', 'out', 'playful', 'silly', 'goofy', 'smiley'],
    '😜': ['winking', 'face', 'tongue', 'stuck', 'out', 'joke', 'playful', 'silly', 'cheeky', 'smiley'],
    '🤪': ['zany', 'face', 'crazy', 'goofy', 'wild', 'silly', 'eyes', 'smiley'],
    '🤨': ['face', 'raised', 'eyebrow', 'skeptical', 'suspicious', 'doubt', 'disapproval', 'smiley'],
    '🧐': ['face', 'monocle', 'stuffy', 'investigate', 'posh', 'curious', 'inspect', 'smiley'],
    '🤓': ['nerd', 'face', 'geek', 'glasses', 'smart', 'study', 'smiley'],
    '😎': ['smiling', 'face', 'sunglasses', 'cool', 'smooth', 'bright', 'sun', 'smiley'],
    '🥸': ['disguised', 'face', 'groucho', 'glasses', 'nose', 'mustache', 'hide', 'incognito', 'smiley'],
    '🤩': ['star', 'struck', 'eyes', 'amazing', 'awesome', 'impressed', 'wow', 'smiley'],
    '🥳': ['partying', 'face', 'celebrate', 'party', 'hat', 'blower', 'hooray', 'birthday', 'smiley'],
    '🙂‍↕️': ['face', 'shaking', 'vertically', 'yes', 'nod', 'agree', 'affirmative', 'smiley'],
    '😏': ['smirking', 'face', 'smug', 'flirt', 'sass', 'mischief', 'suggestive', 'smiley'],
    '😒': ['unamused', 'face', 'annoyed', 'bored', 'skeptical', 'dissatisfied', 'meh', 'smiley'],
    '🙂‍↔️': ['face', 'shaking', 'horizontally', 'no', 'shake', 'disagree', 'negative', 'smiley'],
    '😞': ['disappointed', 'face', 'sad', 'let', 'down', 'regret', 'frown', 'smiley'],
    '😔': ['pensive', 'face', 'sad', 'thoughtful', 'reflect', 'sorry', 'upset', 'smiley'],
    '😟': ['worried', 'face', 'concern', 'anxious', 'nervous', 'distressed', 'smiley'],
    '😕': ['confused', 'face', 'uncertain', 'doubt', 'hmm', 'smiley'],
    '🙁': ['slightly', 'frowning', 'face', 'sad', 'unhappy', 'disappointed', 'smiley'],
    '☹️': ['frowning', 'face', 'sad', 'unhappy', 'disappointed', 'upset', 'smiley'],
    '😣': ['persevering', 'face', 'struggle', 'endure', 'pain', 'difficult', 'smiley'],
    '😖': ['confounded', 'face', 'struggle', 'frustrated', 'annoyed', 'dizzy', 'smiley'],
    '😫': ['tired', 'face', 'exhausted', 'frustrated', 'whine', 'upset', 'smiley'],
    '😩': ['weary', 'face', 'tired', 'exhausted', 'stressed', 'overwhelmed', 'anguish', 'smiley'],
    '🥺': ['pleading', 'face', 'begging', 'puppy', 'eyes', 'cute', 'sorry', 'smiley'],
    '😢': ['crying', 'face', 'sad', 'tear', 'upset', 'sob', 'smiley'],
    '😭': ['loudly', 'crying', 'face', 'sad', 'tears', 'sob', 'bawling', 'upset', 'smiley'],
    '😤': ['face', 'steam', 'nose', 'triumph', 'angry', 'frustrated', 'proud', 'huff', 'smiley'],
    '😠': ['angry', 'face', 'mad', 'annoyed', 'frustrated', 'grumpy', 'smiley'],
    '😡': ['pouting', 'face', 'angry', 'mad', 'red', 'rage', 'furious', 'smiley'],
    '🤬': ['face', 'symbols', 'mouth', 'swearing', 'cursing', 'angry', 'mad', 'profanity', 'smiley'],
    '🤯': ['exploding', 'head', 'mind', 'blown', 'shocked', 'amazed', 'surprised', 'smiley'],
    '😳': ['flushed', 'face', 'blush', 'embarrassed', 'shy', 'surprised', 'shocked', 'smiley'],
    '🥵': ['hot', 'face', 'overheated', 'sweating', 'fever', 'thirsty', 'attractive', 'smiley'],
    '🥶': ['cold', 'face', 'freezing', 'frozen', 'icicles', 'shivering', 'unfriendly', 'smiley'],
    '🫡': ['saluting', 'face', 'yes', 'sir', 'respect', 'military', 'greeting', 'salute', 'smiley'],
    '🫢': ['face', 'eyes', 'peeking', 'hand', 'mouth', 'shock', 'surprise', 'gasp', 'scared', 'smiley'],
    '🤭': ['face', 'hand', 'mouth', 'giggle', 'oops', 'secret', 'laugh', 'shy', 'embarrassed', 'smiley'],
    '🫣': ['face', 'peeking', 'eye', 'scared', 'curious', 'shy', 'hide', 'smiley'],
    '🤔': ['thinking', 'face', 'ponder', 'hmm', 'idea', 'question', 'curious', 'smiley'],
    '🤗': ['hugging', 'face', 'hug', 'embrace', 'support', 'welcome', 'affection', 'smiley'],
    '😓': ['downcast', 'face', 'sweat', 'sad', 'disappointed', 'stressed', 'work', 'smiley'],
    '😥': ['sad', 'relieved', 'face', 'whew', 'anxious', 'disappointed', 'sweat', 'smiley'],
    '😰': ['anxious', 'face', 'sweat', 'nervous', 'scared', 'blue', 'worried', 'smiley'],
    '😨': ['fearful', 'face', 'scared', 'shocked', 'scream', 'afraid', 'smiley'],
    '😱': ['face', 'screaming', 'fear', 'shock', 'surprise', 'scream', 'omg', 'scared', 'smiley'],
    '😶‍🌫️': ['face', 'clouds', 'fog', 'absentminded', 'dazed', 'head', 'obscured', 'smiley'],
    '🤫': ['shushing', 'face', 'quiet', 'silence', 'secret', 'shh', 'smiley'],
    '🫠': ['melting', 'face', 'liquid', 'dissolve', 'hot', 'embarrassed', 'overwhelmed', 'sarcasm', 'smiley'],
    '🤥': ['lying', 'face', 'pinocchio', 'liar', 'lie', 'nose', 'smiley'],
    '😶': ['face', 'without', 'mouth', 'silent', 'quiet', 'speechless', 'blank', 'smiley'],
    '🫥': ['dotted', 'line', 'face', 'invisible', 'hide', 'introvert', 'depressed', 'empty', 'smiley'],
    '😐': ['neutral', 'face', 'meh', 'deadpan', 'blank', 'indifferent', 'smiley'],
    '🫤': ['face', 'diagonal', 'mouth', 'skeptical', 'uncertain', 'disappointed', 'smiley'],
    '😑': ['expressionless', 'face', 'annoyed', 'bored', 'indifferent', 'meh', 'smiley'],
    '🫨': ['shaking', 'face', 'shock', 'vibrate', 'earthquake', 'disbelief', 'excited', 'smiley'],
    '😬': ['grimacing', 'face', 'awkward', 'nervous', 'oops', 'tense', 'embarrassed', 'smiley'],
    '🙄': ['face', 'rolling', 'eyes', 'annoyed', 'sarcasm', 'whatever', 'bored', 'smiley'],
    '😯': ['hushed', 'face', 'surprised', 'shocked', 'silent', 'oh', 'smiley'],
    '🤐': ['zipper', 'mouth', 'face', 'secret', 'silence', 'quiet', 'sealed', 'smiley'],
    '😵‍💫': ['face', 'spiral', 'eyes', 'dizzy', 'confused', 'woozy', 'hypnotized', 'smiley'],
    '😵': ['dizzy', 'face', 'knocked', 'out', 'shocked', 'dead', 'x eyes', 'smiley'],
    '😮‍💨': ['face', 'exhaling', 'sigh', 'relief', 'disappointment', 'tired', 'whistle', 'smiley'],
    '😪': ['sleepy', 'face', 'tired', 'sick', 'snot', 'bubble', 'drowsy', 'smiley'],
    '🤤': ['drooling', 'face', 'desire', 'hungry', 'tasty', 'attractive', 'sleepy', 'smiley'],
    '😴': ['sleeping', 'face', 'zzz', 'tired', 'nap', 'sleep', 'bored', 'smiley'],
    '🥱': ['yawning', 'face', 'tired', 'bored', 'sleepy', 'yawn', 'smiley'],
    '😲': ['astonished', 'face', 'shocked', 'surprised', 'amazed', 'gasp', 'wow', 'smiley'],
    '😮': ['face', 'open', 'mouth', 'surprise', 'shock', 'impressed', 'wow', 'oh', 'smiley'],
    '😧': ['anguished', 'face', 'pain', 'hurt', 'shocked', 'stressed', 'worried', 'smiley'],
    '😦': ['frowning', 'face', 'open', 'mouth', 'sad', 'surprised', 'shocked', 'concerned', 'smiley'],
    '🥴': ['woozy', 'face', 'drunk', 'tipsy', 'confused', 'dazed', 'flirt', 'smiley'],
    '🤢': ['nauseated', 'face', 'sick', 'vomit', 'disgusted', 'ill', 'green', 'smiley'],
    '🤮': ['face', 'vomiting', 'sick', 'puke', 'throw', 'up', 'ill', 'disgusted', 'smiley'],
    '🤧': ['sneezing', 'face', 'gesundheit', 'bless', 'you', 'sick', 'allergy', 'cold', 'smiley'],
    '😷': ['face', 'medical', 'mask', 'sick', 'ill', 'doctor', 'virus', 'covid', 'health', 'smiley'],
    '🤒': ['face', 'thermometer', 'sick', 'ill', 'fever', 'cold', 'flu', 'temperature', 'smiley'],
    '🤕': ['face', 'bandage', 'injured', 'hurt', 'headache', 'ouch', 'clumsy', 'smiley'],
    '🤑': ['money', 'mouth', 'face', 'rich', 'dollar', 'cash', 'greedy', 'cha-ching', 'smiley'],
    '🤠': ['cowboy', 'hat', 'face', 'western', 'yeehaw', 'howdy', 'smiley'],
    '😈': ['smiling', 'face', 'horns', 'devil', 'evil', 'imp', 'mischief', 'trouble', 'smiley'],
    '👿': ['angry', 'face', 'horns', 'devil', 'evil', 'imp', 'demon', 'rage', 'fantasy', 'smiley'],
    '👹': ['ogre', 'monster', 'demon', 'japanese', 'oni', 'fantasy', 'troll', 'mask', 'smiley'],
    '😸': ['grinning', 'cat', 'face', 'smiling', 'eyes', 'happy', 'animal', 'kitty', 'smiley'],
    '😺': ['grinning', 'cat', 'face', 'happy', 'smile', 'animal', 'kitty', 'smiley'],
    '🎃': ['jack', 'o', 'lantern', 'halloween', 'pumpkin', 'scary', 'holiday', 'carve', 'vegetable', 'smiley'],
    '🤖': ['robot', 'face', 'android', 'cyborg', 'machine', 'future', 'ai', 'smiley'],
    '👾': ['alien', 'monster', 'space', 'invader', 'game', 'retro', 'ufo', 'smiley'],
    '👽': ['alien', 'ufo', 'space', 'extraterrestrial', 'sci-fi', 'weird', 'smiley'],
    '☠️': ['skull', 'crossbones', 'death', 'danger', 'poison', 'pirate', 'warning', 'smiley'],
    '💀': ['skull', 'death', 'dead', 'skeleton', 'scary', 'danger', 'creepy', 'smiley'],
    '👻': ['ghost', 'halloween', 'scary', 'spirit', 'boo', 'spooky', 'monster', 'smiley'],
    '💩': ['pile', 'poo', 'poop', 'dung', 'shit', 'crap', 'funny', 'bad', 'smiley'],
    '🤡': ['clown', 'face', 'circus', 'joke', 'silly', 'creepy', 'fool', 'smiley'],
    '👺': ['goblin', 'monster', 'japanese', 'tengu', 'mask', 'fantasy', 'evil', 'smiley'],
    '😹': ['cat', 'face', 'tears', 'joy', 'laugh', 'funny', 'animal', 'kitty', 'lol', 'smiley'],
    '😻': ['smiling', 'cat', 'face', 'heart', 'eyes', 'love', 'adore', 'animal', 'kitty', 'crush', 'smiley'],
    '😼': ['cat', 'face', 'wry', 'smile', 'smirk', 'sarcastic', 'animal', 'kitty', 'smiley'],
    '😽': ['kissing', 'cat', 'face', 'closed', 'eyes', 'love', 'pucker', 'animal', 'kitty', 'smiley'],
    '🙀': ['weary', 'cat', 'face', 'shocked', 'surprised', 'omg', 'animal', 'kitty', 'tired', 'smiley'],
    '😿': ['crying', 'cat', 'face', 'sad', 'tear', 'animal', 'kitty', 'upset', 'smiley'],
    '😾': ['pouting', 'cat', 'face', 'angry', 'mad', 'annoyed', 'animal', 'kitty', 'grumpy', 'smiley'],
    '🫶': ['heart', 'hands', 'love', 'support', 'shape', 'affection', 'care', 'people'],
    '🤲': ['palms', 'up', 'together', 'prayer', 'receive', 'beg', 'open', 'hands', 'people'],
    '👐': ['open', 'hands', 'hug', 'jazz', 'welcome', 'spread', 'people'],
    '🙌': ['raising', 'hands', 'celebration', 'praise', 'hooray', 'yay', 'party', 'people'],
    '👏': ['clapping', 'hands', 'applause', 'congrats', 'praise', 'yay', 'clap', 'people'],
    '🤝': ['handshake', 'agreement', 'deal', 'meeting', 'greeting', 'partnership', 'people'],
    '👍': ['thumbs', 'up', 'yes', 'ok', 'good', 'like', 'approve', 'agree', 'people'],
    '👎': ['thumbs', 'down', 'no', 'bad', 'dislike', 'disapprove', 'disagree', 'people'],
    '👊': ['oncoming', 'fist', 'punch', 'brofist', 'bump', 'hit', 'attack', 'people'],
    '✊': ['raised', 'fist', 'power', 'protest', 'solidarity', 'resistance', 'rock', 'people'],
    '🤛': ['left', 'facing', 'fist', 'punch', 'brofist', 'bump', 'hit', 'people'],
    '🤜': ['right', 'facing', 'fist', 'punch', 'brofist', 'bump', 'hit', 'people'],
    '🫷': ['leftwards', 'pushing', 'hand', 'push', 'stop', 'reject', 'high five', 'refuse', 'people'],
    '🫸': ['rightwards', 'pushing', 'hand', 'push', 'stop', 'reject', 'high five', 'refuse', 'people'],
    '🤞': ['crossed', 'fingers', 'luck', 'hope', 'wish', 'superstition', 'people'],
    '✌️': ['victory', 'hand', 'peace', 'two', 'v', 'win', 'success', 'people'],
    '🫰': ['hand', 'index', 'finger', 'thumb', 'crossed', 'love', 'money', 'heart', 'kpop', 'snap', 'people'],
    '🤟': ['love', 'you', 'gesture', 'ily', 'asl', 'rock', 'on', 'metal', 'people'],
    '🤘': ['sign', 'horns', 'rock', 'on', 'metal', 'devil', 'rebel', 'people'],
    '👌': ['ok', 'hand', 'okay', 'perfect', 'good', 'a-ok', 'zero', 'diving', 'people'],
    '🤌': ['pinched', 'fingers', 'italian', 'what', 'sarcasm', 'disbelief', 'question', 'people'],
    '🤏': ['pinching', 'hand', 'small', 'tiny', 'little', 'amount', 'just', 'people'],
    '🫳': ['palm', 'down', 'hand', 'drop', 'dismiss', 'offer', 'receive', 'shoo', 'people'],
    '🫴': ['palm', 'up', 'hand', 'offer', 'receive', 'beg', 'come', 'present', 'people'],
    '👈': ['backhand', 'index', 'pointing', 'left', 'point', 'direction', 'this', 'people'],
    '👉': ['backhand', 'index', 'pointing', 'right', 'point', 'direction', 'this', 'people'],
    '👆': ['backhand', 'index', 'pointing', 'up', 'point', 'direction', 'above', 'one', 'people'],
    '👇': ['backhand', 'index', 'pointing', 'down', 'point', 'direction', 'below', 'here', 'people'],
    '☝️': ['index', 'pointing', 'up', 'point', 'one', 'idea', 'attention', 'wait', 'people'],
    '✋': ['raised', 'hand', 'stop', 'high five', 'question', 'palm', 'volunteer', 'people'],
    '🤚': ['raised', 'back', 'hand', 'stop', 'high five', 'question', 'palm', 'volunteer', 'people'],
    '🖐️': ['hand', 'fingers', 'splayed', 'high five', 'stop', 'wave', 'five', 'palm', 'people'],
    '🖖': ['vulcan', 'salute', 'spock', 'star trek', 'live long', 'prosper', 'logic', 'people'],
    '👋': ['waving', 'hand', 'hello', 'goodbye', 'hi', 'bye', 'wave', 'people'],
    '🤙': ['call', 'me', 'hand', 'shaka', 'hang loose', 'surf', 'phone', 'hawaii', 'people'],
    '🫲': ['rightwards', 'hand', 'offer', 'shake', 'deal', 'receive', 'palm', 'people'],
    '🫱': ['leftwards', 'hand', 'offer', 'shake', 'deal', 'receive', 'palm', 'people'],
    '💪': ['flexed', 'biceps', 'strong', 'muscle', 'power', 'strength', 'workout', 'arm', 'people'],
    '🦾': ['mechanical', 'arm', 'robot', 'prosthetic', 'cyborg', 'future', 'strength', 'people'],
    '🖕': ['middle', 'finger', 'fu', 'rude', 'offensive', 'flip', 'off', 'people'],
    '✍️': ['writing', 'hand', 'write', 'pen', 'sign', 'author', 'draw', 'people'],
    '🙏': ['folded', 'hands', 'please', 'thank you', 'pray', 'namaste', 'high five', 'hope', 'people'],
    '🫵': ['index', 'pointing', 'at', 'viewer', 'you', 'point', 'choose', 'blame', 'people'],
    '🦶': ['foot', 'kick', 'stomp', 'walk', 'leg', 'feet', 'base', 'people'],
    '🦵': ['leg', 'kick', 'walk', 'limb', 'run', 'prosthetic', 'people'],
    '🦿': ['mechanical', 'leg', 'robot', 'prosthetic', 'cyborg', 'future', 'run', 'people'],
    '💄': ['lipstick', 'makeup', 'cosmetics', 'kiss', 'beauty', 'fashion', 'people', 'object'],
    '💋': ['kiss', 'mark', 'lips', 'love', 'romance', 'smooch', 'lipstick', 'people', 'object'],
    '👄': ['mouth', 'lips', 'speak', 'kiss', 'talk', 'smile', 'people'],
    '🫦': ['biting', 'lip', 'flirt', 'nervous', 'anxious', 'desire', 'sexy', 'people'],
    '🦷': ['tooth', 'dentist', 'teeth', 'bite', 'dental', 'smile', 'people'],
    '👅': ['tongue', 'lick', 'taste', 'silly', 'mouth', 'speak', 'people'],
    '👀': ['eyes', 'look', 'see', 'watch', 'stare', 'curious', 'shifty', 'people'],
    '🫀': ['anatomical', 'heart', 'organ', 'pulse', 'biology', 'love', 'life', 'cardiology', 'people'],
    '🫁': ['lungs', 'organ', 'breath', 'respiration', 'biology', 'inhale', 'exhale', 'people'],
    '🧠': ['brain', 'mind', 'smart', 'intelligent', 'think', 'idea', 'knowledge', 'people'],
    '🗣️': ['speaking', 'head', 'silhouette', 'talk', 'shout', 'announce', 'speech', 'people'],
    '👤': ['bust', 'silhouette', 'person', 'user', 'generic', 'profile', 'guest', 'people'],
    '👥': ['busts', 'silhouette', 'people', 'group', 'team', 'users', 'crowd'],
    '🫂': ['people', 'hugging', 'hug', 'support', 'care', 'embrace', 'comfort', 'together'],
    '👁️': ['eye', 'see', 'look', 'watch', 'view', 'vision', 'sight', 'people'],
    '👣': ['footprints', 'feet', 'walk', 'steps', 'track', 'trail', 'print', 'people'],
    '🤰': ['pregnant', 'woman', 'expecting', 'baby', 'mother', 'pregnancy', 'people'],
    '🫄': ['pregnant', 'person', 'expecting', 'baby', 'parent', 'pregnancy', 'people'],
    '🫃': ['pregnant', 'man', 'expecting', 'baby', 'parent', 'pregnancy', 'transgender', 'people'],
    '🤱': ['breast', 'feeding', 'nursing', 'baby', 'mother', 'parent', 'milk', 'people'],
    '👩‍🍼': ['woman', 'feeding', 'baby', 'nursing', 'parent', 'mother', 'bottle', 'people'],
    '🧑‍🍼': ['person', 'feeding', 'baby', 'nursing', 'parent', 'bottle', 'people'],
    '👨‍🍼': ['man', 'feeding', 'baby', 'nursing', 'parent', 'father', 'bottle', 'people'],
    '💁‍♀️': ['woman', 'tipping', 'hand', 'sassy', 'help', 'information', 'desk', 'receptionist', 'people'],
    '💁': ['person', 'tipping', 'hand', 'sassy', 'help', 'information', 'desk', 'receptionist', 'people'],
    '💁‍♂️': ['man', 'tipping', 'hand', 'sassy', 'help', 'information', 'desk', 'receptionist', 'people'],
    '🙅‍♀️': ['woman', 'gesturing', 'no', 'stop', 'forbidden', 'reject', 'disagree', 'X', 'people'],
    '🙅': ['person', 'gesturing', 'no', 'stop', 'forbidden', 'reject', 'disagree', 'X', 'people'],
    '🙅‍♂️': ['man', 'gesturing', 'no', 'stop', 'forbidden', 'reject', 'disagree', 'X', 'people'],
    '🙆‍♀️': ['woman', 'gesturing', 'ok', 'yes', 'agree', 'circle', 'okay', 'people'],
    '🙆‍♂️': ['man', 'gesturing', 'ok', 'yes', 'agree', 'circle', 'okay', 'people'],
    '🙋‍♀️': ['woman', 'raising', 'hand', 'question', 'answer', 'volunteer', 'hello', 'people'],
    '🙋‍♂️': ['man', 'raising', 'hand', 'question', 'answer', 'volunteer', 'hello', 'people'],
    '🤦‍♀️': ['woman', 'facepalming', 'disbelief', 'exasperation', 'frustration', 'fail', 'doh', 'people'],
    '🤦‍♂️': ['man', 'facepalming', 'disbelief', 'exasperation', 'frustration', 'fail', 'doh', 'people'],
    '🤷‍♂️': ['man', 'shrugging', 'dunno', 'whatever', 'indifferent', 'confused', 'clueless', 'people'],
    '🤷‍♀️': ['woman', 'shrugging', 'dunno', 'whatever', 'indifferent', 'confused', 'clueless', 'people'],
    '👩‍❤️‍👨': ['couple', 'heart', 'love', 'romance', 'relationship', 'woman', 'man', 'heterosexual', 'people'],
    '💑': ['couple', 'heart', 'love', 'romance', 'relationship', 'dating', 'people'],

    // --- Animals & Nature ---
    '🐶': ['dog', 'face', 'pet', 'puppy', 'woof', 'animal', 'canine', 'nature'],
    '🐱': ['cat', 'face', 'pet', 'kitten', 'meow', 'animal', 'feline', 'nature'],
    '🐭': ['mouse', 'face', 'rodent', 'cheese', 'animal', 'small', 'nature'],
    '🐹': ['hamster', 'face', 'pet', 'rodent', 'animal', 'cute', 'nature'],
    '🐰': ['rabbit', 'face', 'bunny', 'pet', 'easter', 'animal', 'hop', 'nature'],
    '🦊': ['fox', 'face', 'animal', 'sly', 'cunning', 'red', 'nature'],
    '🐻': ['bear', 'face', 'animal', 'grizzly', 'brown', 'wild', 'nature'],
    '🐼': ['panda', 'face', 'animal', 'bear', 'bamboo', 'china', 'cute', 'nature'],
    '🐨': ['koala', 'animal', 'bear', 'australia', 'marsupial', 'eucalyptus', 'nature'],
    '🐯': ['tiger', 'face', 'cat', 'animal', 'wild', 'stripes', 'roar', 'nature'],
    '🦁': ['lion', 'face', 'cat', 'animal', 'wild', 'king', 'mane', 'roar', 'nature'],
    '🐮': ['cow', 'face', 'animal', 'farm', 'moo', 'milk', 'beef', 'nature'],
    '🐷': ['pig', 'face', 'animal', 'farm', 'oink', 'pork', 'sow', 'nature'],
    '🐸': ['frog', 'face', 'animal', 'amphibian', 'ribbit', 'pond', 'green', 'nature'],
    '🐒': ['monkey', 'face', 'animal', 'primate', 'banana', 'ape', 'cheeky', 'nature'],
    '🐔': ['chicken', 'animal', 'farm', 'bird', 'cluck', 'poultry', 'hen', 'nature'],
    '🐧': ['penguin', 'animal', 'bird', 'antarctica', 'cold', 'waddle', 'nature'],
    '🐦': ['bird', 'animal', 'fly', 'tweet', 'wing', 'avian', 'nature'],
    '🦉': ['owl', 'animal', 'bird', 'wise', 'hoot', 'night', 'nocturnal', 'nature'],
    '🦋': ['butterfly', 'animal', 'insect', 'fly', 'wings', 'beauty', 'metamorphosis', 'nature'],
    '🐛': ['bug', 'animal', 'insect', 'worm', 'caterpillar', 'larva', 'crawl', 'nature'],
    '🐜': ['ant', 'animal', 'insect', 'colony', 'small', 'work', 'nature'],
    '🐝': ['honeybee', 'animal', 'insect', 'bee', 'honey', 'buzz', 'sting', 'pollen', 'nature'],
    '🐞': ['lady', 'beetle', 'bug', 'animal', 'insect', 'ladybug', 'luck', 'red', 'nature'],
    '🐟': ['fish', 'animal', 'water', 'swim', 'sea', 'ocean', 'aquarium', 'nature'],
    '🐠': ['tropical', 'fish', 'animal', 'water', 'swim', 'sea', 'ocean', 'aquarium', 'nemo', 'nature'],
    '🐡': ['blowfish', 'animal', 'fish', 'water', 'swim', 'pufferfish', 'sea', 'ocean', 'poison', 'nature'],
    '🐢': ['turtle', 'animal', 'reptile', 'slow', 'shell', 'tortoise', 'sea', 'nature'],
    '🐳': ['spouting', 'whale', 'animal', 'mammal', 'sea', 'ocean', 'blue', 'large', 'nature'],
    '🐬': ['dolphin', 'animal', 'mammal', 'sea', 'ocean', 'flipper', 'smart', 'swim', 'nature'],
    '🐙': ['octopus', 'animal', 'mollusk', 'sea', 'ocean', 'tentacles', 'kraken', 'nature'],
    '🐚': ['spiral', 'shell', 'sea', 'ocean', 'beach', 'mollusk', 'conch', 'nature', 'object'],
    '🦀': ['crab', 'animal', 'crustacean', 'sea', 'ocean', 'beach', 'pincers', 'shellfish', 'nature'],
    '🦞': ['lobster', 'animal', 'crustacean', 'sea', 'ocean', 'claw', 'shellfish', 'expensive', 'food', 'nature'],
    '🦐': ['shrimp', 'animal', 'crustacean', 'sea', 'ocean', 'prawn', 'shellfish', 'food', 'nature'],
    '🦑': ['squid', 'animal', 'mollusk', 'sea', 'ocean', 'tentacles', 'calamari', 'ink', 'food', 'nature'],
    '🦖': ['T-Rex', 'dinosaur', 'tyrannosaurus', 'rex', 'extinct', 'roar', 'jurassic', 'reptile', 'animal', 'nature'],
    '🦕': ['sauropod', 'dinosaur', 'brontosaurus', 'diplodocus', 'extinct', 'long neck', 'jurassic', 'reptile', 'animal', 'nature'],
    '🦒': ['giraffe', 'animal', 'mammal', 'long neck', 'spots', 'africa', 'tall', 'nature'],
    '🦓': ['zebra', 'animal', 'mammal', 'stripes', 'africa', 'horse', 'nature'],
    '🐘': ['elephant', 'animal', 'mammal', 'trunk', 'large', 'africa', 'asia', 'ivory', 'nature'],
    '🦏': ['rhinoceros', 'animal', 'mammal', 'rhino', 'horn', 'africa', 'large', 'nature'],
    '🦛': ['hippopotamus', 'hippo', 'animal', 'mammal', 'africa', 'river', 'large', 'water', 'nature'],
    '🦍': ['gorilla', 'animal', 'mammal', 'primate', 'ape', 'strong', 'africa', 'nature'],
    '🦧': ['orangutan', 'animal', 'mammal', 'primate', 'ape', 'asia', 'forest', 'nature'],
    '🐪': ['camel', 'dromedary', 'animal', 'mammal', 'desert', 'hump', 'one', 'nature'],
    '🐫': ['two-hump', 'camel', 'bactrian', 'animal', 'mammal', 'desert', 'humps', 'nature'],
    '🐿️': ['chipmunk', 'squirrel', 'rodent', 'animal', 'nut', 'tree', 'cute', 'nature'],
    '🦔': ['hedgehog', 'animal', 'mammal', 'spikes', 'quills', 'sonic', 'cute', 'nature'],
    '🦦': ['otter', 'animal', 'mammal', 'water', 'river', 'playful', 'cute', 'nature'],
    '🦇': ['bat', 'animal', 'mammal', 'fly', 'night', 'nocturnal', 'cave', 'vampire', 'nature'],
    '🐺': ['wolf', 'face', 'animal', 'canine', 'dog', 'wild', 'howl', 'pack', 'nature'],

    // --- Food & Drink ---
    '🍕': ['pizza', 'slice', 'food', 'italian', 'cheese', 'pepperoni', 'party', 'drink'],
    '🍔': ['hamburger', 'burger', 'food', 'fast food', 'beef', 'cheese', 'sandwich', 'drink'],
    '🍟': ['french', 'fries', 'food', 'fast food', 'potato', 'chips', 'drink'],
    '🌭': ['hot', 'dog', 'food', 'fast food', 'sausage', 'frankfurter', 'bun', 'drink'],
    '🥪': ['sandwich', 'food', 'lunch', 'bread', 'sub', 'drink'],
    '🌮': ['taco', 'food', 'mexican', 'shell', 'meat', 'lettuce', 'drink'],
    '🌯': ['burrito', 'food', 'mexican', 'wrap', 'tortilla', 'bean', 'drink'],
    '🥙': ['stuffed', 'flatbread', 'food', 'pita', 'gyro', 'kebab', 'doner', 'drink'],
    '🧆': ['falafel', 'food', 'middle east', 'chickpea', 'vegetarian', 'ball', 'drink'],
    '🥚': ['egg', 'food', 'breakfast', 'chicken', 'protein', 'shell', 'drink'],
    '🍳': ['cooking', 'egg', 'food', 'breakfast', 'frying', 'pan', 'sunny side up', 'drink'],
    '🍿': ['popcorn', 'food', 'snack', 'movie', 'theater', 'butter', 'corn', 'drink'],
    '🧈': ['butter', 'food', 'dairy', 'margarine', 'spread', 'fat', 'drink'],
    '🥨': ['pretzel', 'food', 'snack', 'baked', 'german', 'knot', 'salt', 'drink'],
    '🥐': ['croissant', 'food', 'bread', 'pastry', 'french', 'breakfast', 'butter', 'drink'],
    '🍞': ['bread', 'food', 'toast', 'loaf', 'bakery', 'sandwich', 'wheat', 'drink'],
    '🥖': ['baguette', 'bread', 'food', 'french', 'loaf', 'bakery', 'long', 'drink'],
    '🫓': ['flatbread', 'food', 'pita', 'naan', 'tortilla', 'roti', 'wrap', 'drink'],
    '🥞': ['pancakes', 'food', 'breakfast', 'hotcakes', 'crepe', 'syrup', 'stack', 'drink'],
    '🧇': ['waffle', 'food', 'breakfast', 'dessert', 'syrup', 'iron', 'drink'],
    '🧀': ['cheese', 'wedge', 'food', 'dairy', 'swiss', 'cheddar', 'hole', 'drink'],
    '🍖': ['meat', 'bone', 'food', 'ribs', 'pork', 'beef', 'barbecue', 'bbq', 'drink'],
    '🍗': ['poultry', 'leg', 'food', 'chicken', 'turkey', 'drumstick', 'meat', 'fried', 'drink'],
    '🥩': ['cut', 'meat', 'food', 'steak', 'beef', 'pork', 'chop', 'raw', 'drink'],
    '🥓': ['bacon', 'food', 'breakfast', 'pork', 'meat', 'crispy', 'strip', 'drink'],
    '🫔': ['tamale', 'food', 'mexican', 'corn', 'masa', 'steamed', 'wrapped', 'drink'],
    '🥘': ['shallow', 'pan', 'food', 'paella', 'spanish', 'rice', 'casserole', 'skillet', 'drink'],
    '🍲': ['pot', 'food', 'stew', 'soup', 'casserole', 'hotpot', 'ramen', 'noodle', 'drink'],
    '🥣': ['bowl', 'spoon', 'food', 'cereal', 'soup', 'oatmeal', 'breakfast', 'drink'],
    '🥗': ['green', 'salad', 'food', 'healthy', 'vegetarian', 'vegetable', 'lettuce', 'bowl', 'drink'],
    '🫕': ['fondue', 'food', 'cheese', 'chocolate', 'swiss', 'pot', 'dip', 'bread', 'drink'],
    '🥫': ['canned', 'food', 'can', 'soup', 'vegetables', 'preserve', 'tin', 'drink'],
    '🍣': ['sushi', 'food', 'japanese', 'fish', 'rice', 'seaweed', 'raw', 'drink'],
    '🍱': ['bento', 'box', 'food', 'japanese', 'lunch', 'meal', 'rice', 'drink'],
    '🍘': ['rice', 'cracker', 'food', 'japanese', 'senbei', 'snack', 'seaweed', 'drink'],
    '🍙': ['rice', 'ball', 'food', 'japanese', 'onigiri', 'seaweed', 'drink'],
    '🍚': ['cooked', 'rice', 'food', 'asian', 'bowl', 'steam', 'grain', 'drink'],
    '🍛': ['curry', 'rice', 'food', 'indian', 'asian', 'spice', 'sauce', 'drink'],
    '🍜': ['steaming', 'bowl', 'food', 'ramen', 'noodle', 'soup', 'japanese', 'asian', 'drink'],
    '🍝': ['spaghetti', 'food', 'italian', 'pasta', 'noodle', 'sauce', 'meatball', 'drink'],
    '🍠': ['roasted', 'sweet', 'potato', 'food', 'yam', 'vegetable', 'baked', 'drink'],
    '🍢': ['oden', 'food', 'japanese', 'skewer', 'kebab', 'broth', 'dango', 'drink'],
    '🍡': ['dango', 'food', 'japanese', 'dessert', 'sweet', 'skewer', 'dumpling', 'rice', 'drink'],
    '🍧': ['shaved', 'ice', 'food', 'dessert', 'sweet', 'cold', 'summer', 'syrup', 'drink'],
    '🍨': ['ice', 'cream', 'food', 'dessert', 'sweet', 'cold', 'scoop', 'sundae', 'drink'],
    '🍦': ['soft', 'ice', 'cream', 'food', 'dessert', 'sweet', 'cold', 'cone', 'swirl', 'drink'],
    '🥧': ['pie', 'food', 'dessert', 'sweet', 'pastry', 'filling', 'crust', 'fruit', 'slice', 'drink'],
    '🍰': ['shortcake', 'food', 'dessert', 'sweet', 'cake', 'slice', 'pastry', 'strawberry', 'birthday', 'drink'],
    '🎂': ['birthday', 'cake', 'food', 'dessert', 'sweet', 'party', 'celebrate', 'candles', 'pastry', 'drink'],
    '🍮': ['custard', 'food', 'dessert', 'sweet', 'pudding', 'flan', 'caramel', 'drink'],
    '🍭': ['lollipop', 'food', 'dessert', 'sweet', 'candy', 'sugar', 'sucker', 'drink'],
    '🍬': ['candy', 'food', 'dessert', 'sweet', 'sugar', 'bonbon', 'treat', 'drink'],
    '🍫': ['chocolate', 'bar', 'food', 'dessert', 'sweet', 'candy', 'cocoa', 'dark', 'milk', 'drink'],
    '🍩': ['doughnut', 'donut', 'food', 'dessert', 'sweet', 'pastry', 'sprinkles', 'hole', 'glazed', 'drink'],
    '🍪': ['cookie', 'food', 'dessert', 'sweet', 'biscuit', 'chocolate chip', 'baked', 'drink'],
    '🌰': ['chestnut', 'food', 'nut', 'roast', 'fall', 'plant', 'drink'],
    '🥜': ['peanuts', 'food', 'nut', 'legume', 'snack', 'shell', 'drink'],
    '🍯': ['honey', 'pot', 'sweet', 'bee', 'nectar', 'jar', 'pooh', 'food', 'drink'],
    '🥛': ['glass', 'milk', 'drink', 'dairy', 'beverage', 'calcium', 'white', 'food'],
    '🍼': ['baby', 'bottle', 'drink', 'milk', 'infant', 'feed', 'formula', 'food'],
    '☕': ['hot', 'beverage', 'drink', 'coffee', 'tea', 'cafe', 'cup', 'steaming', 'food'],
    '🍵': ['teacup', 'without', 'handle', 'drink', 'tea', 'green', 'japanese', 'matcha', 'beverage', 'food'],
    '🍶': ['sake', 'drink', 'japanese', 'alcohol', 'rice wine', 'bottle', 'cup', 'beverage', 'food'],
    '🍺': ['beer', 'mug', 'drink', 'alcohol', 'bar', 'pub', 'brew', 'lager', 'ale', 'beverage', 'food'],
    '🍻': ['clinking', 'beer', 'mugs', 'drink', 'alcohol', 'bar', 'pub', 'cheers', 'celebrate', 'beverage', 'food'],
    '🍷': ['wine', 'glass', 'drink', 'alcohol', 'bar', 'red', 'white', 'beverage', 'vino', 'food'],
    '🥂': ['clinking', 'glasses', 'drink', 'alcohol', 'champagne', 'prosecco', 'wine', 'cheers', 'celebrate', 'toast', 'beverage', 'food'],
    '🥃': ['tumbler', 'glass', 'drink', 'alcohol', 'whiskey', 'scotch', 'bourbon', 'bar', 'liquor', 'beverage', 'food'],
    '🍸': ['cocktail', 'glass', 'drink', 'alcohol', 'bar', 'martini', 'beverage', 'party', 'food'],
    '🍹': ['tropical', 'drink', 'beverage', 'bar', 'cocktail', 'juice', 'summer', 'party', 'umbrella', 'food'],
    '🧉': ['mate', 'drink', 'beverage', 'tea', 'south america', 'gourd', 'bombilla', 'food'],
    '🥤': ['cup', 'straw', 'drink', 'beverage', 'soda', 'juice', 'fast food', 'takeaway', 'food'],
    '🧃': ['beverage', 'box', 'drink', 'juice', 'straw', 'carton', 'sweet', 'food'],
    '🧊': ['ice', 'cube', 'cold', 'frozen', 'water', 'drink', 'cooler', 'food'],
    '🥝': ['kiwi', 'fruit', 'food', 'green', 'brown', 'tropical', 'drink'],
    '🥥': ['coconut', 'fruit', 'food', 'tropical', 'palm', 'shell', 'brown', 'white', 'drink'],
    '🍇': ['grapes', 'fruit', 'food', 'wine', 'bunch', 'purple', 'green', 'drink'],
    '🍈': ['melon', 'fruit', 'food', 'honeydew', 'cantaloupe', 'green', 'sweet', 'drink'],
    '🍉': ['watermelon', 'fruit', 'food', 'red', 'green', 'summer', 'sweet', 'seed', 'drink'],
    '🍊': ['tangerine', 'orange', 'fruit', 'food', 'citrus', 'vitamin c', 'juice', 'drink'],
    '🍋': ['lemon', 'fruit', 'food', 'citrus', 'yellow', 'sour', 'limon', 'drink'],
    '🍌': ['banana', 'fruit', 'food', 'yellow', 'peel', 'monkey', 'potassium', 'drink'],
    '🍍': ['pineapple', 'fruit', 'food', 'tropical', 'sweet', 'spiky', 'ananas', 'drink'],
    '🥭': ['mango', 'fruit', 'food', 'tropical', 'sweet', 'orange', 'yellow', 'drink'],
    '🍎': ['red', 'apple', 'fruit', 'food', 'teacher', 'healthy', 'macintosh', 'drink'],
    '🍏': ['green', 'apple', 'fruit', 'food', 'granny smith', 'sour', 'healthy', 'drink'],
    '🍐': ['pear', 'fruit', 'food', 'green', 'sweet', 'shape', 'drink'],
    '🍑': ['peach', 'fruit', 'food', 'sweet', 'fuzzy', 'orange', 'stonefruit', 'drink'],
    '🍒': ['cherries', 'fruit', 'food', 'red', 'sweet', 'pair', 'stonefruit', 'drink'],
    '🍓': ['strawberry', 'fruit', 'food', 'red', 'sweet', 'berry', 'seed', 'drink'],

    // --- Activity ---
    '⚽': ['soccer', 'ball', 'football', 'sport', 'game', 'goal', 'kick', 'activity'],
    '🏀': ['basketball', 'ball', 'sport', 'game', 'hoop', 'dribble', 'nba', 'activity'],
    '🏈': ['american', 'football', 'ball', 'sport', 'game', 'nfl', 'touchdown', 'pigskin', 'activity'],
    '⚾': ['baseball', 'ball', 'sport', 'game', 'mlb', 'homerun', 'bat', 'pitch', 'activity'],
    '🎾': ['tennis', 'ball', 'racquet', 'sport', 'game', 'court', 'serve', 'green', 'activity'],
    '🏐': ['volleyball', 'ball', 'sport', 'game', 'beach', 'net', 'spike', 'activity'],
    '🏓': ['ping', 'pong', 'table', 'tennis', 'paddle', 'ball', 'sport', 'game', 'net', 'activity'],
    '🏸': ['badminton', 'racquet', 'shuttlecock', 'birdie', 'sport', 'game', 'net', 'activity'],
    '🏒': ['ice', 'hockey', 'stick', 'puck', 'sport', 'game', 'rink', 'goal', 'activity'],
    '🏑': ['field', 'hockey', 'stick', 'ball', 'sport', 'game', 'grass', 'goal', 'activity'],
    '🏏': ['cricket', 'game', 'bat', 'ball', 'sport', 'wicket', 'england', 'india', 'activity'],
    '🎿': ['skis', 'skiing', 'sport', 'winter', 'snow', 'mountain', 'poles', 'downhill', 'activity'],
    '🏂': ['snowboarder', 'snowboarding', 'sport', 'winter', 'snow', 'mountain', 'board', 'activity'],
    '⛷️': ['skier', 'skiing', 'sport', 'winter', 'snow', 'mountain', 'poles', 'downhill', 'activity'],
    '⛸️': ['ice', 'skate', 'skating', 'sport', 'winter', 'rink', 'blade', 'figure', 'activity'],
    '🎣': ['fishing', 'pole', 'rod', 'fish', 'hook', 'reel', 'water', 'hobby', 'sport', 'activity'],
    '🎽': ['running', 'shirt', 'sash', 'sport', 'marathon', 'race', 'track', 'athletics', 'activity'],
    '🥋': ['martial', 'arts', 'uniform', 'judo', 'karate', 'taekwondo', 'gi', 'sport', 'fight', 'activity'],
    '🥊': ['boxing', 'glove', 'sport', 'fight', 'punch', 'ring', 'combat', 'activity'],
    '🥅': ['goal', 'net', 'sport', 'soccer', 'hockey', 'lacrosse', 'score', 'activity'],
    '⛳': ['flag', 'in', 'hole', 'golf', 'sport', 'green', 'putt', 'course', 'tee', 'activity'],
    '🏹': ['bow', 'arrow', 'archery', 'sport', 'target', 'zodiac', 'sagittarius', 'activity'],
    '🎯': ['direct', 'hit', 'bullseye', 'target', 'darts', 'archery', 'goal', 'aim', 'center', 'activity'],
    '🥌': ['curling', 'stone', 'sport', 'winter', 'ice', 'broom', 'rock', 'activity'],
    '🎱': ['pool', '8', 'ball', 'billiards', 'game', 'snooker', 'eight', 'magic', 'activity'],
    '🪁': ['kite', 'fly', 'wind', 'sky', 'string', 'toy', 'childhood', 'activity'],
    '🪀': ['yo-yo', 'toy', 'play', 'string', 'up', 'down', 'skill', 'activity'],
    '🛝': ['playground', 'slide', 'fun', 'park', 'down', 'children', 'play', 'activity'],
    '🛹': ['skateboard', 'skate', 'board', 'skater', 'tony hawk', 'transport', 'sport', 'trick', 'activity', 'travel'],
    '🛴': ['kick', 'scooter', 'transport', 'ride', 'push', 'wheels', 'activity', 'travel'],
    '🚲': ['bicycle', 'bike', 'transport', 'ride', 'cycle', 'pedal', 'exercise', 'activity', 'travel'],
    '🛵': ['motor', 'scooter', 'transport', 'ride', 'vespa', 'moped', 'motorbike', 'activity', 'travel'],
    '🛶': ['canoe', 'boat', 'water', 'paddle', 'river', 'lake', 'transport', 'sport', 'activity', 'travel'],
    '⛵': ['sailboat', 'boat', 'water', 'sail', 'wind', 'sea', 'ocean', 'transport', 'yacht', 'activity', 'travel'],
    '🛥️': ['motor', 'boat', 'water', 'speed', 'sea', 'ocean', 'transport', 'yacht', 'activity', 'travel'],
    '🛳️': ['passenger', 'ship', 'cruise', 'boat', 'water', 'sea', 'ocean', 'transport', 'vacation', 'activity', 'travel'],
    '⛴️': ['ferry', 'boat', 'water', 'transport', 'commute', 'car', 'sea', 'ship', 'activity', 'travel'],
    '🚢': ['ship', 'boat', 'water', 'cargo', 'freight', 'sea', 'ocean', 'transport', 'large', 'activity', 'travel'],
    '✈️': ['airplane', 'flight', 'fly', 'transport', 'airport', 'plane', 'travel', 'sky', 'jet', 'activity'],
    '🛬': ['airplane', 'arrival', 'landing', 'flight', 'transport', 'airport', 'plane', 'travel', 'activity'],
    '🚀': ['rocket', 'space', 'launch', 'ship', 'nasa', 'elon', 'fly', 'transport', 'science', 'activity', 'travel'],
    '🛸': ['flying', 'saucer', 'ufo', 'alien', 'space', 'transport', 'scifi', 'xfiles', 'activity', 'travel'],
    '🛰️': ['satellite', 'space', 'orbit', 'signal', 'communication', 'science', 'gps', 'activity', 'travel'],
    '🌠': ['shooting', 'star', 'meteoroid', 'space', 'sky', 'night', 'wish', 'comet', 'activity', 'travel'],
    '🌌': ['milky', 'way', 'galaxy', 'space', 'stars', 'sky', 'night', 'cosmos', 'universe', 'activity', 'travel'],
    '🌃': ['night', 'stars', 'cityscape', 'sky', 'evening', 'dark', 'city', 'buildings', 'activity', 'travel'],
    '🌉': ['bridge', 'at', 'night', 'cityscape', 'lights', 'water', 'structure', 'travel', 'city', 'activity'],
    '🌆': ['cityscape', 'dusk', 'sunset', 'city', 'buildings', 'evening', 'sky', 'urban', 'activity', 'travel'],
    '🌇': ['cityscape', 'sunrise', 'dawn', 'city', 'buildings', 'morning', 'sky', 'urban', 'activity', 'travel'],
    '🌅': ['sunrise', 'dawn', 'morning', 'sun', 'sky', 'orange', 'ocean', 'landscape', 'activity', 'travel'],
    '🌄': ['sunrise', 'mountains', 'dawn', 'morning', 'sun', 'sky', 'landscape', 'view', 'activity', 'travel'],
    '☀️': ['sun', 'bright', 'weather', 'sunny', 'hot', 'light', 'day', 'activity', 'nature'],
    '🌤️': ['sun', 'behind', 'small', 'cloud', 'weather', 'partly', 'cloudy', 'sky', 'activity', 'nature'],
    '🌥️': ['sun', 'behind', 'large', 'cloud', 'weather', 'mostly', 'cloudy', 'sky', 'overcast', 'activity', 'nature'],
    '🌦️': ['sun', 'behind', 'rain', 'cloud', 'weather', 'showers', 'drizzle', 'sky', 'partly sunny', 'activity', 'nature'],
    '🌧️': ['cloud', 'rain', 'weather', 'storm', 'wet', 'sky', 'precipitation', 'shower', 'activity', 'nature'],
    '⛈️': ['cloud', 'lightning', 'thunder', 'weather', 'storm', 'rain', 'sky', 'bolt', 'activity', 'nature'],
    '🌩️': ['cloud', 'lightning', 'weather', 'storm', 'bolt', 'thunder', 'sky', 'activity', 'nature'],
    '🌨️': ['cloud', 'snow', 'weather', 'winter', 'cold', 'sky', 'blizzard', 'flurry', 'activity', 'nature'],
    '❄️': ['snowflake', 'snow', 'weather', 'winter', 'cold', 'frozen', 'ice', 'unique', 'activity', 'nature'],
    '☃️': ['snowman', 'snow', 'winter', 'cold', 'frozen', 'carrot', 'build', 'activity', 'nature'],
    '🌬️': ['wind', 'face', 'blow', 'air', 'weather', 'breeze', 'gust', 'activity', 'nature'],
    '💨': ['dashing', 'away', 'wind', 'blow', 'air', 'fast', 'run', 'smoke', 'puff', 'activity', 'nature', 'object'],
    '🌫️': ['fog', 'weather', 'mist', 'haze', 'obscured', 'cloud', 'smog', 'activity', 'nature'],
    '☔': ['umbrella', 'rain', 'weather', 'wet', 'protection', 'open', 'activity', 'nature', 'object'],
    '☂️': ['umbrella', 'rain', 'weather', 'protection', 'closed', 'activity', 'nature', 'object'],
    '🌈': ['rainbow', 'weather', 'rain', 'sun', 'color', 'pride', 'lgbtq', 'sky', 'luck', 'activity', 'nature'],
    '⚡': ['high', 'voltage', 'lightning', 'thunder', 'zap', 'bolt', 'electricity', 'power', 'danger', 'flash', 'activity', 'nature'],
    '🔥': ['fire', 'flame', 'hot', 'burn', 'lit', 'heat', 'cook', 'popular', 'trend', 'activity', 'nature', 'object'],
    '💧': ['droplet', 'water', 'rain', 'sweat', 'tear', 'wet', 'drip', 'blue', 'activity', 'nature', 'object'],
    '🌊': ['water', 'wave', 'ocean', 'sea', 'surf', 'tsunami', 'tide', 'blue', 'activity', 'nature'],
    '🌲': ['evergreen', 'tree', 'plant', 'nature', 'wood', 'pine', 'christmas', 'forest', 'activity'],
    '🌳': ['deciduous', 'tree', 'plant', 'nature', 'wood', 'leaf', 'forest', 'green', 'activity'],
    '🌴': ['palm', 'tree', 'plant', 'nature', 'tropical', 'beach', 'vacation', 'island', 'coconut', 'activity'],
    '🌵': ['cactus', 'plant', 'nature', 'desert', 'spike', 'succulent', 'green', 'activity'],
    '🌱': ['seedling', 'plant', 'nature', 'grow', 'new', 'leaf', 'green', 'life', 'sprout', 'activity'],
    '🌿': ['herb', 'plant', 'nature', 'leaf', 'green', 'medicine', 'tea', 'cook', 'activity'],
    '☘️': ['shamrock', 'plant', 'nature', 'luck', 'irish', 'st patrick', 'clover', 'three leaf', 'activity'],
    '🍀': ['four', 'leaf', 'clover', 'plant', 'nature', 'luck', 'irish', 'st patrick', 'fortune', 'activity'],
    '🎍': ['pine', 'decoration', 'plant', 'nature', 'japanese', 'new year', 'bamboo', 'kadomatsu', 'activity'],
    '🪴': ['potted', 'plant', 'nature', 'houseplant', 'grow', 'green', 'pot', 'indoor', 'activity'],
    '🍁': ['maple', 'leaf', 'plant', 'nature', 'fall', 'autumn', 'red', 'canada', 'tree', 'activity'],
    '🍂': ['fallen', 'leaf', 'plant', 'nature', 'fall', 'autumn', 'brown', 'orange', 'tree', 'wind', 'activity'],
    '🍃': ['leaf', 'fluttering', 'wind', 'plant', 'nature', 'green', 'tree', 'blow', 'float', 'activity'],
    '🌾': ['sheaf', 'rice', 'plant', 'nature', 'grain', 'ear', 'crop', 'farm', 'harvest', 'wheat', 'activity'],
    '🌺': ['hibiscus', 'flower', 'plant', 'nature', 'tropical', 'pink', 'red', 'hawaii', 'activity'],
    '🌻': ['sunflower', 'flower', 'plant', 'nature', 'yellow', 'sun', 'tall', 'seed', 'activity'],
    '🌹': ['rose', 'flower', 'plant', 'nature', 'love', 'romance', 'red', 'valentine', 'beauty', 'thorn', 'activity'],
    '🥀': ['wilted', 'flower', 'plant', 'nature', 'sad', 'dead', 'goodbye', 'broken', 'rose', 'activity'],
    '🌷': ['tulip', 'flower', 'plant', 'nature', 'spring', 'pink', 'netherlands', 'activity'],
    '🌸': ['cherry', 'blossom', 'flower', 'plant', 'nature', 'spring', 'pink', 'japan', 'sakura', 'activity'],
    '🌼': ['blossom', 'flower', 'plant', 'nature', 'spring', 'yellow', 'white', 'daisy', 'activity'],
    '💐': ['bouquet', 'flowers', 'plant', 'nature', 'romance', 'gift', 'spring', 'wedding', 'arrangement', 'activity'],
    '🍄': ['mushroom', 'plant', 'nature', 'fungus', 'food', 'toadstool', 'mario', 'red', 'activity'],

    // --- Travel & Places ---
    '🚗': ['automobile', 'car', 'vehicle', 'transport', 'drive', 'road', 'red', 'sedan', 'travel', 'places'],
    '🚕': ['taxi', 'cab', 'car', 'vehicle', 'transport', 'drive', 'road', 'yellow', 'uber', 'lyft', 'travel', 'places'],
    '🚙': ['sport', 'utility', 'vehicle', 'suv', 'car', 'transport', 'drive', 'road', 'blue', '4x4', 'travel', 'places'],
    '🚌': ['bus', 'vehicle', 'transport', 'commute', 'public', 'road', 'school', 'travel', 'places'],
    '🚎': ['trolleybus', 'bus', 'vehicle', 'transport', 'commute', 'public', 'road', 'electric', 'tram', 'travel', 'places'],
    '🚓': ['police', 'car', 'vehicle', 'transport', 'cop', 'emergency', 'siren', 'law', '911', 'patrol', 'travel', 'places'],
    '🚑': ['ambulance', 'vehicle', 'transport', 'emergency', 'hospital', 'paramedic', 'siren', 'help', '911', 'travel', 'places'],
    '🚒': ['fire', 'engine', 'truck', 'vehicle', 'transport', 'emergency', 'firefighter', 'hose', 'siren', '911', 'travel', 'places'],
    '🚐': ['minibus', 'van', 'vehicle', 'transport', 'bus', 'delivery', 'travel', 'places'],
    '🚚': ['delivery', 'truck', 'vehicle', 'transport', 'lorry', 'shipping', 'cargo', 'freight', 'moving', 'travel', 'places'],
    '🚛': ['articulated', 'lorry', 'truck', 'vehicle', 'transport', 'semi', 'trailer', 'shipping', 'cargo', 'freight', 'long', 'travel', 'places'],
    '🚜': ['tractor', 'vehicle', 'transport', 'farm', 'agriculture', 'field', 'crop', 'farmer', 'travel', 'places'],
    '🏎️': ['racing', 'car', 'vehicle', 'transport', 'race', 'speed', 'f1', 'sport', 'fast', 'travel', 'places'],
    '🏍️': ['motorcycle', 'bike', 'vehicle', 'transport', 'ride', 'race', 'motorbike', 'speed', 'travel', 'places'],
    '🚏': ['bus', 'stop', 'sign', 'transport', 'public', 'commute', 'wait', 'station', 'travel', 'places'],
    '🛣️': ['motorway', 'road', 'highway', 'street', 'drive', 'transport', 'travel', 'route', 'journey', 'places'],
    '🛤️': ['railway', 'track', 'train', 'transport', 'railroad', 'station', 'travel', 'route', 'journey', 'places'],
    '⛽': ['fuel', 'pump', 'gas', 'station', 'petrol', 'diesel', 'car', 'transport', 'travel', 'fill up', 'places'],
    '🚨': ['police', 'car', 'light', 'siren', 'emergency', 'beacon', 'warning', 'ambulance', 'fire truck', '911', 'travel', 'places', 'object'],
    '🚥': ['horizontal', 'traffic', 'light', 'signal', 'road', 'stop', 'go', 'wait', 'red', 'yellow', 'green', 'intersection', 'travel', 'places'],
    '🚦': ['vertical', 'traffic', 'light', 'signal', 'road', 'stop', 'go', 'wait', 'red', 'yellow', 'green', 'intersection', 'travel', 'places'],
    '🚧': ['construction', 'sign', 'barrier', 'road', 'work', 'warning', 'under construction', 'caution', 'travel', 'places'],
    '🛑': ['stop', 'sign', 'road', 'octagon', 'red', 'halt', 'warning', 'intersection', 'travel', 'places'],
    '⚓': ['anchor', 'boat', 'ship', 'sea', 'ocean', 'sailor', 'navy', 'harbor', 'dock', 'heavy', 'travel', 'places', 'object'],
    '🛕': ['hindu', 'temple', 'religion', 'worship', 'india', 'mandir', 'building', 'place', 'shrine', 'travel', 'places'],
    '🏘️': ['houses', 'buildings', 'residence', 'home', 'neighborhood', 'suburb', 'village', 'community', 'place', 'travel', 'places'],
    '🏠': ['house', 'building', 'home', 'residence', 'address', 'place', 'travel', 'places'],
    '🏡': ['house', 'garden', 'building', 'home', 'residence', 'yard', 'tree', 'place', 'suburb', 'travel', 'places'],
    '🏢': ['office', 'building', 'work', 'business', 'city', 'skyscraper', 'company', 'place', 'urban', 'travel', 'places'],
    '🏣': ['japanese', 'post', 'office', 'building', 'mail', 'letter', 'japan', 'place', 'travel', 'places'],
    '🏥': ['hospital', 'building', 'doctor', 'nurse', 'medicine', 'health', 'emergency', 'clinic', 'place', 'sick', 'travel', 'places'],
    '🏦': ['bank', 'building', 'money', 'finance', 'cash', 'atm', 'loan', 'place', 'currency', 'travel', 'places'],
    '🏨': ['hotel', 'building', 'lodging', 'motel', 'accommodation', 'vacation', 'travel', 'check in', 'place', 'travel', 'places'],
    '🏩': ['love', 'hotel', 'building', 'romance', 'sex', 'couple', 'hourly', 'japan', 'place', 'heart', 'travel', 'places'],
    '💒': ['wedding', 'chapel', 'building', 'marriage', 'love', 'romance', 'church', 'bride', 'groom', 'ceremony', 'place', 'travel', 'places'],
    '🏫': ['school', 'building', 'education', 'student', 'teacher', 'class', 'learn', 'college', 'university', 'place', 'travel', 'places'],
    '🏬': ['department', 'store', 'building', 'shopping', 'mall', 'retail', 'sale', 'shop', 'place', 'travel', 'places'],
    '🏭': ['factory', 'building', 'industry', 'work', 'production', 'manufacture', 'smoke', 'pollution', 'place', 'plant', 'travel', 'places'],
    '🏯': ['japanese', 'castle', 'building', 'japan', 'history', 'shogun', 'fortress', 'place', 'asia', 'travel', 'places'],
    '🏰': ['castle', 'building', 'europe', 'history', 'fortress', 'palace', 'medieval', 'king', 'queen', 'disney', 'place', 'travel', 'places'],
    '🏕️': ['camping', 'tent', 'nature', 'outdoors', 'camp', 'forest', 'vacation', 'travel', 'adventure', 'place', 'travel', 'places'],
    '⛺': ['tent', 'camping', 'nature', 'outdoors', 'camp', 'forest', 'shelter', 'place', 'travel', 'places'],
    '🛖': ['hut', 'building', 'house', 'simple', 'primitive', 'village', 'shelter', 'round', 'mud', 'place', 'travel', 'places'],
    '🏛️': ['classical', 'building', 'architecture', 'government', 'bank', 'museum', 'court', 'columns', 'history', 'greek', 'roman', 'place', 'travel', 'places'],
    '🧱': ['brick', 'wall', 'build', 'construction', 'material', 'masonry', 'red', 'travel', 'places', 'object'],
    '🪵': ['wood', 'log', 'lumber', 'material', 'tree', 'nature', 'firewood', 'pile', 'timber', 'travel', 'places', 'object'],
    '🪨': ['rock', 'stone', 'heavy', 'material', 'nature', 'geology', 'boulder', 'gray', 'travel', 'places', 'object'],
    '🗿': ['moai', 'statue', 'easter island', 'rapa nui', 'stone', 'face', 'polynesia', 'history', 'mystery', 'travel', 'places', 'object'],
    '🏙️': ['cityscape', 'city', 'buildings', 'skyline', 'urban', 'metropolis', 'view', 'place', 'travel', 'places'],
    '🎇': ['sparkler', 'fireworks', 'celebration', 'party', 'new year', 'fourth july', 'light', 'sparkle', 'travel', 'places', 'activity'],
    '🎆': ['fireworks', 'celebration', 'party', 'new year', 'fourth july', 'light', 'explode', 'sky', 'night', 'travel', 'places', 'activity'],
    '🎡': ['ferris', 'wheel', 'amusement', 'park', 'ride', 'fun', 'carnival', 'view', 'round', 'place', 'travel', 'places'],
    '🎢': ['roller', 'coaster', 'amusement', 'park', 'ride', 'fun', 'carnival', 'thrill', 'speed', 'scream', 'place', 'travel', 'places'],
    '🎠': ['carousel', 'horse', 'amusement', 'park', 'ride', 'fun', 'carnival', 'merry go round', 'pony', 'place', 'travel', 'places'],
    '⛲': ['fountain', 'water', 'park', 'plaza', 'spray', 'refresh', 'sculpture', 'place', 'travel', 'places'],
    '⛱️': ['umbrella', 'on', 'ground', 'beach', 'sand', 'sun', 'shade', 'vacation', 'relax', 'parasol', 'place', 'travel', 'places'],
    '🏖️': ['beach', 'umbrella', 'sand', 'water', 'ocean', 'sea', 'sun', 'vacation', 'relax', 'coast', 'shore', 'place', 'travel', 'places'],
    '🏝️': ['desert', 'island', 'palm', 'tree', 'beach', 'sand', 'water', 'ocean', 'sea', 'tropical', 'vacation', 'lonely', 'paradise', 'place', 'travel', 'places'],
    '🏜️': ['desert', 'sand', 'dune', 'dry', 'hot', 'cactus', 'sahara', 'landscape', 'place', 'arid', 'travel', 'places'],
    '🌋': ['volcano', 'mountain', 'eruption', 'lava', 'magma', 'hot', 'smoke', 'disaster', 'geology', 'place', 'travel', 'places'],
    '⛰️': ['mountain', 'peak', 'hike', 'climb', 'nature', 'landscape', 'view', 'snow', 'tall', 'place', 'travel', 'places'],
    '🏔️': ['snow', 'capped', 'mountain', 'peak', 'hike', 'climb', 'nature', 'landscape', 'view', 'cold', 'winter', 'alps', 'place', 'travel', 'places'],
    '🗻': ['mount', 'fuji', 'mountain', 'japan', 'volcano', 'peak', 'snow', 'asia', 'landmark', 'place', 'travel', 'places'],
    '⛩️': ['shinto', 'shrine', 'religion', 'japan', 'torii', 'gate', 'place', 'worship', 'travel', 'places'],
    '🕍': ['synagogue', 'religion', 'jewish', 'judaism', 'temple', 'worship', 'star david', 'place', 'travel', 'places'],
    '🕌': ['mosque', 'religion', 'islam', 'muslim', 'worship', 'minaret', 'dome', 'allah', 'place', 'travel', 'places'],
    '🕋': ['kaaba', 'religion', 'islam', 'muslim', 'mecca', 'hajj', 'cube', 'black', 'holy', 'place', 'travel', 'places'],

    // --- Objects ---
    '⚙️': ['gear', 'cog', 'settings', 'tool', 'machine', 'mechanical', 'engine', 'part', 'options', 'object'],
    '🧰': ['toolbox', 'tools', 'repair', 'mechanic', 'fix', 'diy', 'container', 'chest', 'object'],
    '💯': ['hundred', 'points', 'score', 'perfect', '100', 'exam', 'test', 'grade', 'keep it 100', 'symbol', 'object'],
    '💢': ['anger', 'symbol', 'comic', 'manga', 'mad', 'annoyed', 'vein', 'pop', 'object'],
    '💬': ['speech', 'balloon', 'talk', 'chat', 'message', 'dialog', 'comic', 'speak', 'bubble', 'object'],
    '💭': ['thought', 'balloon', 'thinking', 'idea', 'dream', 'cloud', 'mind', 'comic', 'bubble', 'object'],
    '💣': ['bomb', 'explode', 'explosion', 'boom', 'danger', 'weapon', 'blast', 'fuse', 'object'],
    '💥': ['collision', 'explode', 'explosion', 'boom', 'crash', 'pow', 'bam', 'object'],
    '💫': ['dizzy', 'stars', 'spin', 'circle', 'woozy', 'magic', 'sparkle', 'shoot', 'object'],
    '💦': ['sweat', 'droplets', 'water', 'splash', 'drip', 'rain', 'wet', 'exertion', 'object'],
    '🕳️': ['hole', 'pit', 'black hole', 'ground', 'trap', 'empty', 'object'],
    '💅': ['nail', 'polish', 'manicure', 'beauty', 'care', 'cosmetics', 'fashion', 'varnish', 'hand', 'object'],
    '🤳': ['selfie', 'phone', 'camera', 'photo', 'narcissist', 'picture', 'hand', 'object'],
    '👂': ['ear', 'hear', 'listen', 'sound', 'body', 'part', 'object', 'people'],
    '👃': ['nose', 'smell', 'sniff', 'scent', 'body', 'part', 'object', 'people'],
    '🦴': ['bone', 'skeleton', 'calcium', 'dog', 'body', 'part', 'object', 'people'],
    '💘': ['heart', 'arrow', 'love', 'romance', 'cupid', 'valentine', 'affection', 'symbol', 'object'],
    '💝': ['heart', 'ribbon', 'love', 'romance', 'valentine', 'gift', 'present', 'box', 'symbol', 'object'],
    '💖': ['sparkling', 'heart', 'love', 'romance', 'valentine', 'excited', 'shiny', 'pink', 'symbol', 'object'],
    '💗': ['growing', 'heart', 'love', 'romance', 'valentine', 'excited', 'pulse', 'pink', 'symbol', 'object'],
    '💓': ['beating', 'heart', 'love', 'romance', 'valentine', 'pulse', 'life', 'pink', 'symbol', 'object'],
    '💞': ['revolving', 'hearts', 'love', 'romance', 'valentine', 'affection', 'couple', 'pink', 'symbol', 'object'],
    '💕': ['two', 'hearts', 'love', 'romance', 'valentine', 'affection', 'couple', 'pink', 'symbol', 'object'],
    '💔': ['broken', 'heart', 'sad', 'breakup', 'love', 'lost', 'pain', 'red', 'symbol', 'object'],
    '❤️‍🔥': ['heart', 'on', 'fire', 'love', 'lust', 'passion', 'desire', 'burn', 'intense', 'symbol', 'object'],
    '❤️‍🩹': ['mending', 'heart', 'heal', 'recover', 'support', 'well', 'bandage', 'fix', 'broken', 'symbol', 'object'],
    '🏧': ['atm', 'sign', 'bank', 'money', 'cash', 'automated', 'teller', 'machine', 'symbol', 'object'],
    '🚮': ['litter', 'bin', 'sign', 'trash', 'garbage', 'waste', 'recycle', 'throw away', 'symbol', 'object'],
    '🚾': ['water', 'closet', 'toilet', 'restroom', 'bathroom', 'wc', 'washroom', 'lavatory', 'symbol', 'object'],
    '🛂': ['passport', 'control', 'customs', 'border', 'travel', 'official', 'immigration', 'symbol', 'object'],
    '🛃': ['customs', 'border', 'travel', 'official', 'inspection', 'duty', 'symbol', 'object'],
    '🛄': ['baggage', 'claim', 'airport', 'travel', 'luggage', 'suitcase', 'carousel', 'symbol', 'object'],
    '🛅': ['left', 'luggage', 'locker', 'storage', 'travel', 'baggage', 'symbol', 'object'], // Added missing emoji
    '🚹': ['men', 'room', 'restroom', 'bathroom', 'toilet', 'lavatory', 'male', 'man', 'symbol', 'object'],
    '🚺': ['women', 'room', 'restroom', 'bathroom', 'toilet', 'lavatory', 'female', 'woman', 'symbol', 'object'],
    '🚻': ['restroom', 'bathroom', 'toilet', 'wc', 'lavatory', 'man', 'woman', 'unisex', 'symbol', 'object'],
    '🚼': ['baby', 'symbol', 'changing', 'station', 'infant', 'diaper', 'nursery', 'restroom', 'object'],
    '🎦': ['cinema', 'movie', 'film', 'theater', 'camera', 'projector', 'symbol', 'object'],
    '📶': ['antenna', 'bars', 'signal', 'strength', 'wifi', 'internet', 'phone', 'cell', 'connection', 'symbol', 'object'],
    '📳': ['vibration', 'mode', 'phone', 'mobile', 'silent', 'buzz', 'symbol', 'object'],
    '📴': ['mobile', 'phone', 'off', 'cell', 'mute', 'quiet', 'turn off', 'symbol', 'object'],
    '♻️': ['recycling', 'symbol', 'recycle', 'reuse', 'green', 'environment', 'eco', 'object'],
    '🉑': ['japanese', 'acceptable', 'button', 'kanji', 'ok', 'agree', 'symbol', 'object'],
    '☢️': ['radioactive', 'sign', 'nuclear', 'warning', 'danger', 'hazard', 'symbol', 'object'],
    '☣️': ['biohazard', 'sign', 'warning', 'danger', 'hazard', 'virus', 'germs', 'symbol', 'object'],
    '⚠️': ['warning', 'sign', 'caution', 'danger', 'alert', 'hazard', 'triangle', 'exclamation', 'symbol', 'object'],
    '🚸': ['children', 'crossing', 'sign', 'warning', 'school', 'pedestrian', 'slow', 'symbol', 'object'],
    '⛔': ['no', 'entry', 'sign', 'stop', 'forbidden', 'restricted', 'prohibited', 'wrong way', 'symbol', 'object'],
    '🚫': ['prohibited', 'sign', 'no', 'forbidden', 'not allowed', 'banned', 'restricted', 'circle', 'slash', 'symbol', 'object'],
    '🚷': ['no', 'pedestrians', 'sign', 'forbidden', 'not allowed', 'walk', 'symbol', 'object'],
    '📵': ['no', 'mobile', 'phones', 'sign', 'forbidden', 'not allowed', 'cell', 'silent', 'turn off', 'symbol', 'object'],
    '🔞': ['no', 'one', 'under', 'eighteen', 'sign', 'adults', 'only', 'restricted', 'age', '18', 'symbol', 'object'],

    // --- Symbols ---
    '⬆️': ['up', 'arrow', 'direction', 'north', 'increase', 'high', 'symbol'],
    '↗️': ['up-right', 'arrow', 'direction', 'northeast', 'increase', 'diagonal', 'symbol'],
    '➡️': ['right', 'arrow', 'direction', 'east', 'next', 'forward', 'symbol'],
    '↘️': ['down-right', 'arrow', 'direction', 'southeast', 'decrease', 'diagonal', 'symbol'],
    '⬇️': ['down', 'arrow', 'direction', 'south', 'decrease', 'low', 'symbol'],
    '↙️': ['down-left', 'arrow', 'direction', 'southwest', 'decrease', 'diagonal', 'symbol'],
    '⬅️': ['left', 'arrow', 'direction', 'west', 'previous', 'back', 'symbol'],
    '↖️': ['up-left', 'arrow', 'direction', 'northwest', 'increase', 'diagonal', 'symbol'],
    '↕️': ['up-down', 'arrow', 'direction', 'vertical', 'sort', 'resize', 'symbol'],
    '↔️': ['left-right', 'arrow', 'direction', 'horizontal', 'resize', 'swap', 'symbol'],
    '↩️': ['right', 'arrow', 'curving', 'left', 'return', 'reply', 'undo', 'back', 'hook', 'symbol'],
    '↪️': ['left', 'arrow', 'curving', 'right', 'forward', 'next', 'redo', 'hook', 'symbol'],
    '⤴️': ['right', 'arrow', 'curving', 'up', 'increase', 'level up', 'positive', 'symbol'],
    '⤵️': ['right', 'arrow', 'curving', 'down', 'decrease', 'level down', 'negative', 'symbol'],
    '🔀': ['shuffle', 'tracks', 'button', 'music', 'random', 'mix', 'arrow', 'symbol'],
    '🔁': ['repeat', 'button', 'music', 'loop', 'replay', 'arrow', 'cycle', 'symbol'],
    '🔂': ['repeat', 'single', 'button', 'music', 'loop', 'replay', 'arrow', 'one', 'symbol'],
    '🔄': ['counterclockwise', 'arrows', 'button', 'sync', 'reload', 'refresh', 'update', 'cycle', 'round', 'symbol'],
    '🔃': ['clockwise', 'vertical', 'arrows', 'reload', 'refresh', 'cycle', 'round', 'symbol'],
    '➕': ['plus', 'sign', 'math', 'add', 'increase', 'positive', 'calculate', 'symbol', 'operator'],
    '➖': ['minus', 'sign', 'math', 'subtract', 'decrease', 'negative', 'calculate', 'dash', 'hyphen', 'symbol', 'operator'],
    '➗': ['divide', 'sign', 'math', 'division', 'calculate', 'obelus', 'symbol', 'operator'],
    '✖️': ['multiply', 'sign', 'math', 'multiplication', 'calculate', 'times', 'x', 'cancel', 'close', 'symbol', 'operator'],
    '♾️': ['infinity', 'symbol', 'unlimited', 'forever', 'math', 'loop', 'mobius'],
    '✔️': ['check', 'mark', 'tick', 'yes', 'ok', 'done', 'complete', 'correct', 'select', 'symbol'],
    '☑️': ['check', 'box', 'mark', 'tick', 'yes', 'ok', 'done', 'complete', 'correct', 'select', 'ballot', 'symbol'],
    '💲': ['heavy', 'dollar', 'sign', 'money', 'currency', 'cash', 'payment', 'usa', 'symbol'],
    '©️': ['copyright', 'sign', 'c', 'legal', 'intellectual property', 'symbol'],
    '®️': ['registered', 'sign', 'r', 'legal', 'trademark', 'symbol'],
    '™️': ['trade', 'mark', 'sign', 'tm', 'legal', 'brand', 'symbol'],
    '#️⃣': ['hash', 'key', 'number', 'sign', 'pound', 'hashtag', 'symbol', 'octothorpe'],
    '*️⃣': ['keycap', 'asterisk', 'star', 'multiply', 'password', 'symbol'],
    '0️⃣': ['keycap', '0', 'number', 'zero', 'digit', 'symbol'],
    '1️⃣': ['keycap', '1', 'number', 'one', 'digit', 'symbol'],
    '2️⃣': ['keycap', '2', 'number', 'two', 'digit', 'symbol'],
    '3️⃣': ['keycap', '3', 'number', 'three', 'digit', 'symbol'],
    '4️⃣': ['keycap', '4', 'number', 'four', 'digit', 'symbol'],
    '5️⃣': ['keycap', '5', 'number', 'five', 'digit', 'symbol'],
    '6️⃣': ['keycap', '6', 'number', 'six', 'digit', 'symbol'],
    '7️⃣': ['keycap', '7', 'number', 'seven', 'digit', 'symbol'],
    '8️⃣': ['keycap', '8', 'number', 'eight', 'digit', 'symbol'],
    '9️⃣': ['keycap', '9', 'number', 'nine', 'digit', 'symbol'],
    '🔟': ['keycap', '10', 'number', 'ten', 'digit', 'symbol'],
    '🔠': ['input', 'latin', 'uppercase', 'letters', 'abcd', 'alphabet', 'case', 'symbol'],
    '🔡': ['input', 'latin', 'lowercase', 'letters', 'abcd', 'alphabet', 'case', 'symbol'],
    '🔢': ['input', 'numbers', '1234', 'digits', 'numeric', 'symbol'],
    '🔣': ['input', 'symbols', 'punctuation', 'characters', '&%#$', 'symbol'],
    '🔤': ['input', 'latin', 'letters', 'abc', 'alphabet', 'language', 'symbol'],
    '🅰️': ['a', 'button', 'blood', 'type', 'letter', 'red', 'alphabet', 'symbol'],
    '🆎': ['ab', 'button', 'blood', 'type', 'letter', 'red', 'alphabet', 'symbol'],
    '🅱️': ['b', 'button', 'blood', 'type', 'letter', 'red', 'alphabet', 'symbol'],
    '🆑': ['cl', 'button', 'clear', 'letter', 'red', 'alphabet', 'symbol'],
    '🆒': ['cool', 'button', 'word', 'blue', 'symbol'],
    '🆓': ['free', 'button', 'word', 'blue', 'symbol'],
    'ℹ️': ['information', 'source', 'i', 'letter', 'blue', 'help', 'details', 'symbol'],
    '🆔': ['id', 'button', 'identity', 'identification', 'purple', 'symbol'],
    'Ⓜ️': ['circled', 'm', 'metro', 'subway', 'station', 'letter', 'blue', 'alphabet', 'symbol'],
    '🆕': ['new', 'button', 'word', 'blue', 'fresh', 'up', 'symbol'],
    '🆖': ['ng', 'button', 'no good', 'letter', 'red', 'symbol'],
    '🅾️': ['o', 'button', 'blood', 'type', 'letter', 'red', 'alphabet', 'symbol', 'circle'],
    '🆗': ['ok', 'button', 'yes', 'agree', 'okay', 'blue', 'symbol'],
    '🅿️': ['p', 'button', 'parking', 'letter', 'blue', 'alphabet', 'symbol'],
    '🆘': ['sos', 'button', 'help', 'emergency', 'danger', 'red', 'symbol'],
    '🆙': ['up', 'button', 'mark', 'new', 'above', 'red', 'symbol'],
    '🆚': ['vs', 'button', 'versus', 'compare', 'fight', 'match', 'orange', 'symbol'],
    '🔴': ['red', 'circle', 'shape', 'color', 'button', 'stop', 'symbol', 'geometric'],
    '🟠': ['orange', 'circle', 'shape', 'color', 'button', 'symbol', 'geometric'],
    '🟡': ['yellow', 'circle', 'shape', 'color', 'button', 'symbol', 'geometric'],
    '🟢': ['green', 'circle', 'shape', 'color', 'button', 'go', 'symbol', 'geometric'],
    '🔵': ['blue', 'circle', 'shape', 'color', 'button', 'symbol', 'geometric'],
    '🟣': ['purple', 'circle', 'shape', 'color', 'button', 'symbol', 'geometric'],
    '🟤': ['brown', 'circle', 'shape', 'color', 'button', 'symbol', 'geometric'],
    '⚫': ['black', 'circle', 'shape', 'color', 'button', 'symbol', 'geometric', 'dot'],
    '⚪': ['white', 'circle', 'shape', 'color', 'button', 'symbol', 'geometric', 'dot'],
    '🟥': ['red', 'square', 'shape', 'color', 'button', 'symbol', 'geometric'],
    '🟧': ['orange', 'square', 'shape', 'color', 'button', 'symbol', 'geometric'],
    '🟨': ['yellow', 'square', 'shape', 'color', 'button', 'symbol', 'geometric'],
    '🟩': ['green', 'square', 'shape', 'color', 'button', 'symbol', 'geometric'],
    '🟦': ['blue', 'square', 'shape', 'color', 'button', 'symbol', 'geometric'],
    '🟪': ['purple', 'square', 'shape', 'color', 'button', 'symbol', 'geometric'],
    '🟫': ['brown', 'square', 'shape', 'color', 'button', 'symbol', 'geometric'],
    '⬛': ['black', 'large', 'square', 'shape', 'color', 'button', 'symbol', 'geometric'],
    '⬜': ['white', 'large', 'square', 'shape', 'color', 'button', 'symbol', 'geometric', 'empty'],
    '◼️': ['black', 'medium', 'square', 'shape', 'color', 'symbol', 'geometric'],
    '◻️': ['white', 'medium', 'square', 'shape', 'color', 'symbol', 'geometric', 'empty'],
    '◾': ['black', 'medium-small', 'square', 'shape', 'color', 'symbol', 'geometric'],
    '◽': ['white', 'medium-small', 'square', 'shape', 'color', 'symbol', 'geometric', 'empty'],
    '▪️': ['black', 'small', 'square', 'shape', 'color', 'symbol', 'geometric', 'dot'],
    '▫️': ['white', 'small', 'square', 'shape', 'color', 'symbol', 'geometric', 'dot', 'empty'],
    '🔶': ['large', 'orange', 'diamond', 'shape', 'color', 'symbol', 'geometric', 'jewel'],
    '🔷': ['large', 'blue', 'diamond', 'shape', 'color', 'symbol', 'geometric', 'jewel'],
    '🔸': ['small', 'orange', 'diamond', 'shape', 'color', 'symbol', 'geometric', 'jewel'],
    '🔹': ['small', 'blue', 'diamond', 'shape', 'color', 'symbol', 'geometric', 'jewel'],
    '🔺': ['red', 'triangle', 'pointed', 'up', 'shape', 'color', 'symbol', 'geometric', 'play', 'increase'],
    '🔻': ['red', 'triangle', 'pointed', 'down', 'shape', 'color', 'symbol', 'geometric', 'decrease'],
    '💠': ['diamond', 'dot', 'shape', 'color', 'symbol', 'geometric', 'jewel', 'blue', 'crystal'],
    '🔘': ['radio', 'button', 'shape', 'circle', 'input', 'select', 'option', 'symbol', 'geometric'],
    '🔳': ['white', 'square', 'button', 'shape', 'outline', 'empty', 'input', 'symbol', 'geometric'],
    '🔲': ['black', 'square', 'button', 'shape', 'input', 'symbol', 'geometric'],

    // --- Flags ---
    '🇦🇫': ['afghanistan', 'flag', 'nation', 'country'],
    '🇦🇱': ['albania', 'flag', 'nation', 'country'],
    '🇩🇿': ['algeria', 'flag', 'nation', 'country'],
    '🇦🇸': ['american samoa', 'flag', 'territory', 'us'],
    '🇦🇩': ['andorra', 'flag', 'nation', 'country'],
    '🇦🇴': ['angola', 'flag', 'nation', 'country'],
    '🇦🇮': ['anguilla', 'flag', 'territory', 'uk'],
    '🇦🇶': ['antarctica', 'flag', 'continent', 'region'],
    '🇦🇬': ['antigua', 'barbuda', 'flag', 'nation', 'country'],
    '🇦🇷': ['argentina', 'flag', 'nation', 'country'],
    '🇦🇲': ['armenia', 'flag', 'nation', 'country'],
    '🇦🇼': ['aruba', 'flag', 'territory', 'netherlands'],
    '🇦🇺': ['australia', 'flag', 'nation', 'country'],
    '🇦🇹': ['austria', 'flag', 'nation', 'country'],
    '🇦🇿': ['azerbaijan', 'flag', 'nation', 'country'],
    '🇧🇸': ['bahamas', 'flag', 'nation', 'country'],
    '🇧🇭': ['bahrain', 'flag', 'nation', 'country'],
    '🇧🇩': ['bangladesh', 'flag', 'nation', 'country'],
    '🇧🇧': ['barbados', 'flag', 'nation', 'country'],
    '🇧🇾': ['belarus', 'flag', 'nation', 'country'],
    '🇧🇪': ['belgium', 'flag', 'nation', 'country'],
    '🇧🇿': ['belize', 'flag', 'nation', 'country'],
    '🇧🇯': ['benin', 'flag', 'nation', 'country'],
    '🇧🇲': ['bermuda', 'flag', 'territory', 'uk'],
    '🇧🇹': ['bhutan', 'flag', 'nation', 'country'],
    '🇧🇴': ['bolivia', 'flag', 'nation', 'country'],
    '🇧🇦': ['bosnia', 'herzegovina', 'flag', 'nation', 'country'],
    '🇧🇼': ['botswana', 'flag', 'nation', 'country'],
    '🇧🇷': ['brazil', 'flag', 'nation', 'country'],
    '🇮🇴': ['british', 'indian', 'ocean', 'territory', 'flag', 'uk'],
    '🇻🇬': ['british', 'virgin', 'islands', 'flag', 'territory', 'uk'],
    '🇧🇳': ['brunei', 'flag', 'nation', 'country'],
    '🇧🇬': ['bulgaria', 'flag', 'nation', 'country'],
    '🇧🇫': ['burkina', 'faso', 'flag', 'nation', 'country'],
    '🇧🇮': ['burundi', 'flag', 'nation', 'country'],
    '🇰🇭': ['cambodia', 'flag', 'nation', 'country'],
    '🇨🇲': ['cameroon', 'flag', 'nation', 'country'],
    '🇨🇦': ['canada', 'flag', 'nation', 'country'],
    '🇨🇻': ['cape', 'verde', 'cabo', 'flag', 'nation', 'country'],
    '🇰🇾': ['cayman', 'islands', 'flag', 'territory', 'uk'],
    '🇨🇫': ['central', 'african', 'republic', 'flag', 'nation', 'country'],
    '🇹🇩': ['chad', 'flag', 'nation', 'country'],
    '🇨🇱': ['chile', 'flag', 'nation', 'country'],
    '🇨🇳': ['china', 'flag', 'nation', 'country'],
    '🇨🇽': ['christmas', 'island', 'flag', 'territory', 'australia'],
    '🇨🇨': ['cocos', 'keeling', 'islands', 'flag', 'territory', 'australia'],
    '🇨🇴': ['colombia', 'flag', 'nation', 'country'],
    '🇰🇲': ['comoros', 'flag', 'nation', 'country'],
    '🇨🇬': ['congo', 'brazzaville', 'republic', 'flag', 'nation', 'country'],
    '🇨🇩': ['congo', 'kinshasa', 'democratic', 'republic', 'drc', 'flag', 'nation', 'country'],
    '🇨🇰': ['cook', 'islands', 'flag', 'territory', 'new zealand'],
    '🇨🇷': ['costa', 'rica', 'flag', 'nation', 'country'],
    '🇭🇷': ['croatia', 'flag', 'nation', 'country'],
    '🇨🇺': ['cuba', 'flag', 'nation', 'country'],
    '🇨🇾': ['cyprus', 'flag', 'nation', 'country'],
    '🇨🇿': ['czechia', 'czech', 'republic', 'flag', 'nation', 'country'],
    '🇩🇰': ['denmark', 'flag', 'nation', 'country'],
    '🇩🇯': ['djibouti', 'flag', 'nation', 'country'],
    '🇩🇲': ['dominica', 'flag', 'nation', 'country'],
    '🇩🇴': ['dominican', 'republic', 'flag', 'nation', 'country'],
    '🇪🇨': ['ecuador', 'flag', 'nation', 'country'],
    '🇪🇬': ['egypt', 'flag', 'nation', 'country'],
    '🇸🇻': ['el', 'salvador', 'flag', 'nation', 'country'],
    '🇬🇶': ['equatorial', 'guinea', 'flag', 'nation', 'country'],
    '🇪🇷': ['eritrea', 'flag', 'nation', 'country'],
    '🇪🇪': ['estonia', 'flag', 'nation', 'country'],
    '🇸🇿': ['eswatini', 'swaziland', 'flag', 'nation', 'country'],
    '🇪🇹': ['ethiopia', 'flag', 'nation', 'country'],
    '🇪🇺': ['european', 'union', 'flag', 'europe'],
    '🇫🇰': ['falkland', 'islands', 'malvinas', 'flag', 'territory', 'uk'],
    '🇫🇴': ['faroe', 'islands', 'flag', 'territory', 'denmark'],
    '🇫🇯': ['fiji', 'flag', 'nation', 'country'],
    '🇫🇮': ['finland', 'flag', 'nation', 'country'],
    '🇫🇷': ['france', 'flag', 'nation', 'country'],
    '🇬🇫': ['french', 'guiana', 'flag', 'territory', 'france'],
    '🇵🇫': ['french', 'polynesia', 'flag', 'territory', 'france'],
    '🇹🇫': ['french', 'southern', 'territories', 'flag', 'france'],
    '🇬🇦': ['gabon', 'flag', 'nation', 'country'],
    '🇬🇲': ['gambia', 'flag', 'nation', 'country'],
    '🇬🇪': ['georgia', 'flag', 'nation', 'country'],
    '🇩🇪': ['germany', 'flag', 'nation', 'country'],
    '🇬🇭': ['ghana', 'flag', 'nation', 'country'],
    '🇬🇮': ['gibraltar', 'flag', 'territory', 'uk'],
    '🇬🇷': ['greece', 'flag', 'nation', 'country'],
    '🇬🇱': ['greenland', 'flag', 'territory', 'denmark'],
    '🇬🇩': ['grenada', 'flag', 'nation', 'country'],
    '🇬🇵': ['guadeloupe', 'flag', 'territory', 'france'],
    '🇬🇺': ['guam', 'flag', 'territory', 'us'],
    '🇬🇹': ['guatemala', 'flag', 'nation', 'country'],
    '🇬🇬': ['guernsey', 'flag', 'dependency', 'uk'],
    '🇬🇳': ['guinea', 'flag', 'nation', 'country'],
    '🇬🇼': ['guinea-bissau', 'flag', 'nation', 'country'],
    '🇬🇾': ['guyana', 'flag', 'nation', 'country'],
    '🇭🇹': ['haiti', 'flag', 'nation', 'country'],
    '🇭🇳': ['honduras', 'flag', 'nation', 'country'],
    '🇭🇰': ['hong', 'kong', 'sar', 'china', 'flag', 'region'],
    '🇭🇺': ['hungary', 'flag', 'nation', 'country'],
    '🇮🇸': ['iceland', 'flag', 'nation', 'country'],
    '🇮🇳': ['india', 'flag', 'nation', 'country'],
    '🇮🇩': ['indonesia', 'flag', 'nation', 'country'],
    '🇮🇷': ['iran', 'flag', 'nation', 'country'],
    '🇮🇶': ['iraq', 'flag', 'nation', 'country'],
    '🇮🇪': ['ireland', 'flag', 'nation', 'country'],
    '🇮🇲': ['isle', 'of', 'man', 'flag', 'dependency', 'uk'],
    '🇮🇱': ['israel', 'flag', 'nation', 'country'],
    '🇮🇹': ['italy', 'flag', 'nation', 'country'],
    '🇨🇮': ["côte", "d'ivoire", 'ivory', 'coast', 'flag', 'nation', 'country'],
    '🇯🇲': ['jamaica', 'flag', 'nation', 'country'],
    '🇯🇵': ['japan', 'flag', 'nation', 'country'],
    '🇯🇪': ['jersey', 'flag', 'dependency', 'uk'],
    '🇯🇴': ['jordan', 'flag', 'nation', 'country'],
    '🇰🇿': ['kazakhstan', 'flag', 'nation', 'country'],
    '🇰🇪': ['kenya', 'flag', 'nation', 'country'],
    '🇰🇮': ['kiribati', 'flag', 'nation', 'country'],
    '🇽🇰': ['kosovo', 'flag', 'nation', 'country'],
    '🇰🇼': ['kuwait', 'flag', 'nation', 'country'],
    '🇰🇬': ['kyrgyzstan', 'flag', 'nation', 'country'],
    '🇱🇦': ['laos', 'flag', 'nation', 'country'],
    '🇱🇻': ['latvia', 'flag', 'nation', 'country'],
    '🇱🇧': ['lebanon', 'flag', 'nation', 'country'],
    '🇱🇸': ['lesotho', 'flag', 'nation', 'country'],
    '🇱🇷': ['liberia', 'flag', 'nation', 'country'],
    '🇱🇾': ['libya', 'flag', 'nation', 'country'],
    '🇱🇮': ['liechtenstein', 'flag', 'nation', 'country'],
    '🇱🇹': ['lithuania', 'flag', 'nation', 'country'],
    '🇱🇺': ['luxembourg', 'flag', 'nation', 'country'],
    '🇲🇴': ['macao', 'sar', 'china', 'flag', 'region'],
    '🇲🇰': ['north', 'macedonia', 'flag', 'nation', 'country'],
    '🇲🇬': ['madagascar', 'flag', 'nation', 'country'],
    '🇲🇼': ['malawi', 'flag', 'nation', 'country'],
    '🇲🇾': ['malaysia', 'flag', 'nation', 'country'],
    '🇲🇻': ['maldives', 'flag', 'nation', 'country'],
    '🇲🇱': ['mali', 'flag', 'nation', 'country'],
    '🇲🇹': ['malta', 'flag', 'nation', 'country'],
    '🇲🇭': ['marshall', 'islands', 'flag', 'nation', 'country'],
    '🇲🇶': ['martinique', 'flag', 'territory', 'france'],
    '🇲🇷': ['mauritania', 'flag', 'nation', 'country'],
    '🇲🇺': ['mauritius', 'flag', 'nation', 'country'],
    '🇾🇹': ['mayotte', 'flag', 'territory', 'france'],
    '🇲🇽': ['mexico', 'flag', 'nation', 'country'],
    '🇫🇲': ['micronesia', 'flag', 'nation', 'country'],
    '🇲🇩': ['moldova', 'flag', 'nation', 'country'],
    '🇲🇨': ['monaco', 'flag', 'nation', 'country'],
    '🇲🇳': ['mongolia', 'flag', 'nation', 'country'],
    '🇲🇪': ['montenegro', 'flag', 'nation', 'country'],
    '🇲🇸': ['montserrat', 'flag', 'territory', 'uk'],
    '🇲🇦': ['morocco', 'flag', 'nation', 'country'],
    '🇲🇿': ['mozambique', 'flag', 'nation', 'country'],
    '🇲🇲': ['myanmar', 'burma', 'flag', 'nation', 'country'],
    '🇳🇦': ['namibia', 'flag', 'nation', 'country'],
    '🇳🇷': ['nauru', 'flag', 'nation', 'country'],
    '🇳🇵': ['nepal', 'flag', 'nation', 'country'],
    '🇳🇱': ['netherlands', 'flag', 'nation', 'country'],
    '🇳🇨': ['new', 'caledonia', 'flag', 'territory', 'france'],
    '🇳🇿': ['new', 'zealand', 'flag', 'nation', 'country'],
    '🇳🇮': ['nicaragua', 'flag', 'nation', 'country'],
    '🇳🇪': ['niger', 'flag', 'nation', 'country'],
    '🇳🇬': ['nigeria', 'flag', 'nation', 'country'],
    '🇳🇺': ['niue', 'flag', 'territory', 'new zealand'],
    '🇲🇵': ['northern', 'mariana', 'islands', 'flag', 'territory', 'us'],
    '🇰🇵': ['north', 'korea', 'dprk', 'flag', 'nation', 'country'],
    '🇰🇷': ['south', 'korea', 'rok', 'flag', 'nation', 'country'],
    '🇳🇴': ['norway', 'flag', 'nation', 'country'],
    '🇴🇲': ['oman', 'flag', 'nation', 'country'],
    '🇵🇰': ['pakistan', 'flag', 'nation', 'country'],
    '🇵🇼': ['palau', 'flag', 'nation', 'country'],
    '🇵🇸': ['palestinian', 'territories', 'palestine', 'flag', 'state', 'country'],
    '🇵🇦': ['panama', 'flag', 'nation', 'country'],
    '🇵🇬': ['papua', 'new', 'guinea', 'flag', 'nation', 'country'],
    '🇵🇾': ['paraguay', 'flag', 'nation', 'country'],
    '🇵🇪': ['peru', 'flag', 'nation', 'country'],
    '🇵🇭': ['philippines', 'flag', 'nation', 'country'],
    '🇵🇱': ['poland', 'flag', 'nation', 'country'],
    '🇵🇹': ['portugal', 'flag', 'nation', 'country'],
    '🇵🇷': ['puerto', 'rico', 'flag', 'territory', 'us'],
    '🇶🇦': ['qatar', 'flag', 'nation', 'country'],
    '🇷🇪': ['réunion', 'flag', 'territory', 'france'],
    '🇷🇴': ['romania', 'flag', 'nation', 'country'],
    '🇷🇺': ['russia', 'flag', 'nation', 'country'],
    '🇷🇼': ['rwanda', 'flag', 'nation', 'country'],
    '🇼🇸': ['samoa', 'flag', 'nation', 'country'],
    '🇸🇲': ['san', 'marino', 'flag', 'nation', 'country'],
    '🇸🇹': ['são', 'tomé', 'príncipe', 'sao', 'tome', 'principe', 'flag', 'nation', 'country'],
    '🇸🇦': ['saudi', 'arabia', 'flag', 'nation', 'country'],
    '🇸🇳': ['senegal', 'flag', 'nation', 'country'],
    '🇷🇸': ['serbia', 'flag', 'nation', 'country'],
    '🇸🇨': ['seychelles', 'flag', 'nation', 'country'],
    '🇸🇱': ['sierra', 'leone', 'flag', 'nation', 'country'],
    '🇸🇬': ['singapore', 'flag', 'nation', 'country'],
    '🇸🇰': ['slovakia', 'flag', 'nation', 'country'],
    '🇸🇮': ['slovenia', 'flag', 'nation', 'country'],
    '🇸🇧': ['solomon', 'islands', 'flag', 'nation', 'country'],
    '🇸🇴': ['somalia', 'flag', 'nation', 'country'],
    '🇿🇦': ['south', 'africa', 'flag', 'nation', 'country'],
    '🇬🇸': ['south', 'georgia', 'sandwich', 'islands', 'flag', 'territory', 'uk'],
    '🇸🇸': ['south', 'sudan', 'flag', 'nation', 'country'],
    '🇪🇸': ['spain', 'flag', 'nation', 'country'],
    '🇱🇰': ['sri', 'lanka', 'flag', 'nation', 'country'],
    '🇸🇩': ['sudan', 'flag', 'nation', 'country'],
    '🇸🇷': ['suriname', 'flag', 'nation', 'country'],
    '🇸🇪': ['sweden', 'flag', 'nation', 'country'],
    '🇨🇭': ['switzerland', 'flag', 'nation', 'country'],
    '🇸🇾': ['syria', 'flag', 'nation', 'country'],
    '🇹🇼': ['taiwan', 'flag', 'nation', 'country', 'china'],
    '🇹🇯': ['tajikistan', 'flag', 'nation', 'country'],
    '🇹🇿': ['tanzania', 'flag', 'nation', 'country'],
    '🇹🇭': ['thailand', 'flag', 'nation', 'country'],
    '🇹🇱': ['timor-leste', 'east', 'timor', 'flag', 'nation', 'country'],
    '🇹🇬': ['togo', 'flag', 'nation', 'country'],
    '🇹🇰': ['tokelau', 'flag', 'territory', 'new zealand'],
    '🇹🇴': ['tonga', 'flag', 'nation', 'country'],
    '🇹🇹': ['trinidad', 'tobago', 'flag', 'nation', 'country'],
    '🇹🇳': ['tunisia', 'flag', 'nation', 'country'],
    '🇹🇷': ['turkey', 'flag', 'nation', 'country'],
    '🇹🇲': ['turkmenistan', 'flag', 'nation', 'country'],
    '🇹🇨': ['turks', 'caicos', 'islands', 'flag', 'territory', 'uk'],
    '🇹🇻': ['tuvalu', 'flag', 'nation', 'country'],
    '🇺🇬': ['uganda', 'flag', 'nation', 'country'],
    '🇺🇦': ['ukraine', 'flag', 'nation', 'country'],
    '🇦🇪': ['united', 'arab', 'emirates', 'uae', 'flag', 'nation', 'country'],
    '🇬🇧': ['united', 'kingdom', 'uk', 'great', 'britain', 'england', 'scotland', 'wales', 'northern ireland', 'flag', 'nation', 'country'],
    '🇺🇸': ['united', 'states', 'usa', 'america', 'flag', 'nation', 'country'],
    '🇺🇾': ['uruguay', 'flag', 'nation', 'country'],
    '🇺🇿': ['uzbekistan', 'flag', 'nation', 'country'],
    '🇻🇺': ['vanuatu', 'flag', 'nation', 'country'],
    '🇻🇪': ['venezuela', 'flag', 'nation', 'country'],
    '🇻🇳': ['vietnam', 'flag', 'nation', 'country'],
    '🇾🇪': ['yemen', 'flag', 'nation', 'country'],
    '🇿🇲': ['zambia', 'flag', 'nation', 'country'],
    '🇿🇼': ['zimbabwe', 'flag', 'nation', 'country']
};
    // --- Socket.IO Instance ---
    const socket = io({
        reconnectionAttempts: 5,
        reconnectionDelay: 2000,
    });


    // --- Helper Functions ---

    /** Attempts to play the notification sound, handling potential browser restrictions. */
    function playNotificationSound() {
        if (notificationSound) {
            const audioContext = window.AudioContext || window.webkitAudioContext;
            if (audioContext && notificationSound.context && notificationSound.context.state === 'suspended') {
                notificationSound.context.resume();
            }
            notificationSound.currentTime = 0;
            const playPromise = notificationSound.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.error("[Audio] Notification sound playback failed:", error);
                    // Optional: Inform user about blocked sound
                });
            }
        } else {
            console.warn("Notification sound element not found.");
        }
    }

    /** Formats an ISO UTC date string into a user-friendly relative time string. */
    function formatLastSeen(isoUtcString) {
        if (!isoUtcString) return 'Never';
        try {
            const date = new Date(isoUtcString);
            if (isNaN(date.getTime())) return 'Invalid Date';
            const now = new Date();
            const diffSeconds = Math.round((now - date) / 1000);

            if (diffSeconds < 5) return 'just now';
            if (diffSeconds < 60) return `${diffSeconds} sec ago`;
            const diffMinutes = Math.round(diffSeconds / 60);
            if (diffMinutes < 60) return `${diffMinutes} min ago`;
            const diffHours = Math.round(diffMinutes / 60);
            if (diffHours < 24) return `${diffHours} hr ago`;
            const diffDays = Math.round(diffHours / 24);
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        } catch (e) {
            console.error("Error formatting last_seen date:", e, isoUtcString);
            return 'Error';
        }
    }

    /** Generates HTML for the user status indicator (Online/Last Seen/Offline). */
    function getStatusHTML(isOnline, lastSeenIsoUtc) {
        if (isOnline === true) {
            return `<b><span class="text-green-500">Online</span></b>`;
        } else if (isOnline === false && lastSeenIsoUtc) {
            return `<b>Last seen: ${formatLastSeen(lastSeenIsoUtc)}</b>`;
        } else if (isOnline === false) {
            return `<b><span class="text-gray-500 dark:text-gray-400">Offline</span></b>`;
        } else {
            return '<b><span class="text-yellow-500">Status Unknown</span></b>';
        }
    }

    /** Generates HTML for the chat header, combining status and a bio snippet. */
    function getHeaderStatusHTML(isOnline, lastSeenIsoUtc, userBioInput) {
        const userBio = userBioInput || '';
        const statusText = getStatusHTML(isOnline, lastSeenIsoUtc);
        const bioSnippet = userBio.substring(0, 30) + (userBio.length > 30 ? '...' : '');
        // Hide bio on small screens using sm:inline
        return statusText + `<span class="text-gray-500 dark:text-gray-400 ml-2 whitespace-nowrap hidden sm:inline"> - ${userBio ? sanitizeText(bioSnippet) : 'No bio'}</span>`;
    }

    /** Updates the status display in the chat header. */
    function updateChatHeaderStatusUI(htmlContent) {
        if (chatUserStatusElement) {
            chatUserStatusElement.innerHTML = htmlContent;
        }
    }

    /** Scrolls the chat box to the bottom smoothly. */
    function scrollToBottom() {
        if (chatBox) {
            requestAnimationFrame(() => {
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        }
    }

    /** Basic text sanitization to prevent HTML injection. Use a library for production. */
    function sanitizeText(text) {
        if (text === null || typeof text === 'undefined') return '';
        const temp = document.createElement('div');
        temp.textContent = String(text); // Ensure it's a string
        return temp.innerHTML;
    }

    /** Adds a date separator ('Today', 'Yesterday', 'Month Day') to the chat box if the message date is different from the last one. */
    function addDateSeparatorIfNeeded(msgDate) {
        if (!chatBox || !(msgDate instanceof Date) || isNaN(msgDate.getTime())) {
             console.warn("[Date Separator] Invalid input:", msgDate);
             return;
        }

        const msgDateOnly = new Date(msgDate.getFullYear(), msgDate.getMonth(), msgDate.getDate());
        const msgDateStr = msgDateOnly.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });

        let lastDateStr = null;
        if (lastMessageDate instanceof Date && !isNaN(lastMessageDate.getTime())) {
            const lastDateOnly = new Date(lastMessageDate.getFullYear(), lastMessageDate.getMonth(), lastMessageDate.getDate());
            lastDateStr = lastDateOnly.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
        }

        if (msgDateStr !== lastDateStr) {
            const dateLabel = document.createElement('div');
            dateLabel.className = "relative z-10 text-center text-xs text-gray-500 dark:text-gray-400 py-2 my-2 bg-gray-100 dark:bg-gray-800 rounded-md shadow-sm";

            const today = new Date(); today.setHours(0,0,0,0);
            const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1); yesterday.setHours(0,0,0,0);

            if (msgDateOnly.getTime() === today.getTime()) {
                dateLabel.textContent = "Today";
            } else if (msgDateOnly.getTime() === yesterday.getTime()) {
                dateLabel.textContent = "Yesterday";
            } else {
                dateLabel.textContent = msgDateStr;
            }

            chatBox.appendChild(dateLabel);
            lastMessageDate = new Date(msgDateOnly); // Update the tracker
        }
    }

    /** Resets the chat UI to the initial "No chat selected" state. */
    function showNoChatState() {
        stopActiveChatStatusUpdates();
        if (typingTimer) clearTimeout(typingTimer);
        isTyping = false;
        originalStatusHTML = '';
        receiverId = null;
        currentReceiverUser = null;
        lastMessageDate = null;

        if (chatBox) chatBox.innerHTML = ''; // Clear messages
        if (noChatMessageElement) {
            // Show placeholder only on desktop or if already visible
            const shouldShowPlaceholder = window.innerWidth >= 768 || !noChatMessageElement.classList.contains('hidden');
             noChatMessageElement.classList.toggle('hidden', !shouldShowPlaceholder);
             noChatMessageElement.classList.toggle('flex', shouldShowPlaceholder);
            if(shouldShowPlaceholder && chatBox) { // Re-add if needed and showing
                chatBox.innerHTML = `
                  <div id="no-chat-message" class="relative z-10 flex flex-col items-center justify-center h-full text-center text-gray-600 dark:text-gray-400">
                    <i class="fas fa-comments text-5xl mb-4 text-${userColorScheme}-500 animate-pulse-slow"></i>
                    <h2 class="text-xl font-semibold mb-2">No chat selected</h2>
                    <p class="text-sm max-w-sm">Pick someone from the left, or use <span class="font-semibold text-${userColorScheme}-500">Connect</span> 💬</p>
                  </div>`;
            }
        }

        if (chatHeader) { chatHeader.classList.add('hidden'); chatHeader.classList.remove('flex'); }
        if (chatInputBar) { chatInputBar.classList.add('hidden'); chatInputBar.classList.remove('flex'); }
        if (chatUsernameElement) chatUsernameElement.textContent = 'Select a user';
        if (chatUserPicElement) chatUserPicElement.src = DEFAULT_AVATAR;
        if (chatUserStatusElement) chatUserStatusElement.innerHTML = 'Status: ---'; // Use innerHTML for potential formatting
        if (pingUserButton) pingUserButton.classList.add('hidden');

        // Handle mobile view: Show sidebar, hide chat area
        if (window.innerWidth < 768) {
            const sidebarArea = querySelector('aside');
            if (chatAreaContainer) { chatAreaContainer.classList.add('hidden'); chatAreaContainer.classList.remove('flex'); }
            if (sidebarArea) { sidebarArea.classList.remove('hidden'); sidebarArea.classList.add('flex'); }
        }
    }

    /** Debounce function */
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    /** Generates seen icon HTML based on message status */
    function getSeenIconHTML(seenStatus) {
         // No icon for deleted messages (handled separately now)
         // Only show for self messages (handled where it's called)
         if (seenStatus === true) {
            // Read
            return '<i class="fas fa-check-double text-blue-400 dark:text-blue-300"></i>';
         }
         if (seenStatus === false || seenStatus === null || typeof seenStatus === 'undefined') {
             // Delivered (or status unknown/just sent)
             return '<i class="fas fa-check-double text-gray-400 dark:text-gray-500"></i>';
         }
         // Fallback for 'sent' if backend ever sends that explicitly, though unlikely needed now
         return '<i class="fas fa-check text-gray-400 dark:text-gray-500"></i>';
    }

    // --- Core Chat Logic ---

    /** Adds a message object to the chat box UI. */
    function addMessageToBox(msg) {
        if (!chatBox || !msg) return;

        const isDeleted = msg.deleted_for_everyone === true;
        // Get the raw, trimmed content for analysis
        const rawContent = (msg.content || '').trim();

        // --- Jumbo Emoji Detection ---
        let isJumboEmoji = false;
        if (!isDeleted && !msg.media_url && rawContent) {
             try {
                 // Regex to match base emojis for counting (1-3 limit applies to these)
                 const baseEmojiRegex = /\p{Emoji_Presentation}|\p{Extended_Pictographic}/gu;
                 const baseEmojiMatches = rawContent.match(baseEmojiRegex);
                 const baseEmojiCount = baseEmojiMatches ? baseEmojiMatches.length : 0;

                 // Regex to match emojis AND common modifiers/joiners/selectors for cleanup check
                 // Includes: Base Emojis, Skin Tones (U+1F3FB to U+1F3FF),
                 // Variation Selector 16 (U+FE0F - forces emoji), Zero Width Joiner (U+200D)
                 const emojiComponentRegex = /[\p{Emoji_Presentation}\p{Extended_Pictographic}\u{1F3FB}-\u{1F3FF}\uFE0F\u200D]/gu;

                 // Check if the *entire* string (minus whitespace) consists ONLY of these components
                 const nonEmojiComponentContent = rawContent.replace(emojiComponentRegex, '').trim();

                 // Apply jumbo style if count is 1-3 AND the string is purely emoji components
                 if (baseEmojiCount >= 1 && baseEmojiCount <= 3 && nonEmojiComponentContent === '') {
                     isJumboEmoji = true;
                     // console.log(`Jumbo DETECTED for "${rawContent}": Count=${baseEmojiCount}, Remainder="${nonEmojiComponentContent}"`); // Debugging
                 } else {
                    // console.log(`Jumbo NOT detected for "${rawContent}": Count=${baseEmojiCount}, Remainder="${nonEmojiComponentContent}"`); // Debugging
                 }

             } catch (e) {
                  console.warn("Emoji regex failed (browser might not support \\p{} or complex sequences):", e);
                  // Fallback or ignore jumbo style if regex fails
             }
        }
        // --- End Jumbo Emoji Detection ---

        const sanitizedContent = isDeleted ? '[This message was deleted]' : sanitizeText(msg.content); // Sanitize for display
        const displayMediaUrl = isDeleted ? null : msg.media_url;
        const isSelf = msg.sender_id == currentUserId;

        let msgDate;
        try {
            msgDate = new Date(msg.date || Date.now());
            if (isNaN(msgDate.getTime())) throw new Error("Invalid date");
            addDateSeparatorIfNeeded(msgDate);
        } catch (e) {
            console.error("[addMessageToBox] Error processing message date:", e, msg.date);
            msgDate = new Date();
            addDateSeparatorIfNeeded(msgDate);
        }

        const messageWrapper = document.createElement('div');
        const messageId = msg.id || msg.localId;
        messageWrapper.id = `message-${messageId}`;
        // Note: We apply jumbo class to the BUBBLE, not the wrapper
        messageWrapper.className = `relative z-10 flex ${isSelf ? 'justify-end' : 'justify-start'} mb-2 fade-in w-full message-container`;
        messageWrapper.setAttribute('data-message-id', messageId);
        messageWrapper.setAttribute('data-sender-id', msg.sender_id);
        messageWrapper.setAttribute('data-content', isDeleted ? '' : msg.content || ''); // Store original content
        messageWrapper.setAttribute('data-is-deleted', isDeleted);
        messageWrapper.setAttribute('data-timestamp-iso', msgDate.toISOString());

        const selfBubbleColor = `bg-${userColorScheme}-500 dark:bg-${userColorScheme}-700`;
        const otherBubbleColor = `bg-gray-200 dark:bg-gray-700`;
        const deletedBubbleStyle = isDeleted ? 'italic text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-800 border border-dashed border-gray-300 dark:border-gray-600' : '';
        const jumboBubbleClass = isJumboEmoji ? 'jumbo-emoji-message' : ''; // Apply jumbo class conditionally

        // Combine all bubble classes
        const bubbleClass = `py-2 px-4 shadow-sm max-w-[80%] sm:max-w-[70%] break-words inline-block message-bubble cursor-pointer group relative ${isSelf ? selfBubbleColor + ' text-white rounded-t-xl rounded-bl-xl mr-4 sm:mr-8' : otherBubbleColor + ' text-gray-800 dark:text-gray-100 rounded-b-xl rounded-tr-xl ml-4 sm:ml-8'} ${deletedBubbleStyle} ${jumboBubbleClass}`; // Added jumboBubbleClass

        const timestamp = msgDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const seenIconHTML = getSeenIconHTML(msg.seen);

        let mediaHTML = '';
        // Media logic remains the same...
        if (displayMediaUrl) {
             // ... (image/video/link generation) ...
            const isImage = /\.(jpe?g|png|gif|webp)$/i.test(displayMediaUrl);
            const isVideo = /\.(mp4|webm|ogg|mov)$/i.test(displayMediaUrl);

            if (isImage) {
                mediaHTML = `<img src="${displayMediaUrl}" class="media-trigger max-w-xs h-auto rounded mt-2 cursor-pointer block object-cover" alt="Chat Image" data-media-type="image" data-media-src="${displayMediaUrl}" onerror="this.alt='Image failed to load'; this.parentNode.innerHTML = '<span class=\'text-xs text-red-500\'>Image load error</span>';"/>`;
            } else if (isVideo) {
                mediaHTML = `<div class="media-trigger relative max-w-xs h-auto mt-2 cursor-pointer rounded overflow-hidden group bg-gray-800 aspect-video flex items-center justify-center" data-media-type="video" data-media-src="${displayMediaUrl}"><i class="fas fa-play text-white text-4xl opacity-70 group-hover:opacity-90 transition-opacity duration-200 p-16"></i><span class="absolute bottom-1 right-1 text-xs bg-black bg-opacity-50 text-white px-1 rounded">Video</span></div>`;
            } else {
                mediaHTML = `<a href="${displayMediaUrl}" target="_blank" class="text-sm underline hover:text-blue-400 block mt-2 break-all">[View Media: ${sanitizeText(displayMediaUrl.split('/').pop())}]</a>`;
            }
        }

        messageWrapper.innerHTML = `
            <div class="${bubbleClass}" title="${isJumboEmoji ? rawContent : 'Click for options'}">
                 ${/* Display sanitized content unless it's only jumbo emojis */ ''}
                 ${sanitizedContent ? `<div class="message-content-display">${sanitizedContent}</div>` : ''}
                ${mediaHTML}
                <div class="text-xs ${isSelf ? 'text-gray-200 dark:text-gray-300' : 'text-gray-500 dark:text-gray-400'} mt-1 flex items-center ${isSelf ? 'justify-end' : 'justify-start'} space-x-1 opacity-80">
                    ${isDeleted ? `<i class="fas fa-ban mr-1 text-gray-400"></i>` : ''}
                    <span>${timestamp}</span>
                    <span class="message-status-icon ${isSelf ? '' : 'hidden'}">${seenIconHTML}</span>
                </div>
                 ${/* Options trigger should still work, position might need CSS tweak if padding changed drastically */ ''}
                ${!isDeleted && !isJumboEmoji ? `
                <button class="message-options-trigger absolute ${isSelf ? 'left-[-24px]' : 'right-[-24px]'} top-1/2 transform -translate-y-1/2 p-1 rounded-full text-gray-400 dark:text-gray-500 opacity-0 group-hover:opacity-100 focus:opacity-100 transition-opacity duration-150" aria-label="Message options">
                     <i class="fas fa-ellipsis-v text-xs"></i>
                </button>` : ''}
                 ${/* No options trigger for jumbo emoji messages? Or keep it? For now, removing it for jumbo */ ''}

            </div>
        `;

        const placeholder = chatBox.querySelector('#no-chat-message');
        if (placeholder) placeholder.remove();

        chatBox.appendChild(messageWrapper);

        const contentDisplayElement = messageWrapper.querySelector('.message-content-display');

        // Render emojis using Twemoji ONLY IF THE MESSAGE IS NOT JUMBO
        if (contentDisplayElement && typeof twemoji !== 'undefined' && !isJumboEmoji) { // <-- ADDED !isJumboEmoji
            try {
                 twemoji.parse(contentDisplayElement, { folder: 'svg', ext: '.svg' });
                 // console.log("Applied Twemoji to:", contentDisplayElement.textContent); // Optional debug log
            } catch (e) { console.error("Twemoji parsing error:", e); }
        }
        // If isJumboEmoji is true, we skip Twemoji and let the CSS font-size rule
        // make the browser's native emoji rendering larger.


        // --- Update Sidebar Snippet ---
        // Use a different representation for jumbo emojis in snippet?
        let snippetContent = '';
        if (isDeleted) {
            snippetContent = '[Message deleted]';
        } else if (isJumboEmoji) {
            snippetContent = rawContent; // Show the emojis themselves in the snippet
        } else if (msg.media_url && !msg.content) {
            snippetContent = '[Media]';
        } else {
            snippetContent = msg.content || (msg.media_url ? '[Media]' : ''); // Original logic
        }

        if (snippetContent || isDeleted) { // Update snippet if there's content or deletion
            const partnerId = isSelf ? msg.receiver_id : msg.sender_id;
            const userListItem = querySelector(`.user-list-item[data-user-id='${partnerId}']`);
            if (userListItem) {
                 // Pass modified content for snippet
                 updateUserListSnippet(userListItem, { ...msg, content: snippetContent, media_url: displayMediaUrl });
                 // Move item to top
                 if (userListContainer && userListItem !== userListContainer.firstChild) {
                     userListContainer.insertBefore(userListItem, userListContainer.firstChild);
                 }
            }
        }
        // --- End Sidebar Snippet Update ---
    }


    /** Sends the typed message to the server via Socket.IO. */
    async function sendMessage() {
        const content = messageInput ? messageInput.value.trim() : '';

        if (!receiverId) { console.warn("No receiver selected."); return; }
        if (!socket.connected){ console.warn("Socket not connected."); return; }
        if (!content) { return; } // Don't send empty messages

        sendStopTypingEvent();

        const localTimestamp = new Date();
        const localId = `local_${Date.now()}`;
        scrollToBottom();

        socket.emit('send_message', {
             receiver_id: receiverId,
             content: content,
             localId: localId // Send local ID for confirmation matching
        });

        if (messageInput) messageInput.value = '';
    }

    /** Initiates the chat with a selected user, fetching messages and updating the UI. */
    async function joinChat(id, user) {
        if (!user || !id) { console.error("Cannot join chat: Missing user data or ID."); return; }
        if (id === receiverId) { // Already in chat, ensure view is correct on mobile
            if (window.innerWidth < 768 && chatAreaContainer && sidebarContainer) {
                chatAreaContainer.classList.remove('hidden'); chatAreaContainer.classList.add('flex');
                sidebarContainer.classList.add('hidden'); sidebarContainer.classList.remove('flex');
            }
            if (messageInput) messageInput.focus();
            return;
        }

        sendStopTypingEvent(); // Stop typing in previous chat

        // Update State
        receiverId = id;
        currentReceiverUser = user;
        originalStatusHTML = getHeaderStatusHTML(user.online, user.last_seen, user.bio);
        lastMessageDate = null; // Reset date separator tracking

        // Update Sidebar Badge
        const userListItem = querySelector(`.user-list-item[data-user-id='${id}']`);
        if (userListItem) {
            updateUserUnreadBadge(userListItem, 0);
        }

        // Emit Events
        if (socket.connected) {
            socket.emit('join_chat', { receiver_id: id });
            socket.emit('mark_chat_read', { sender_id: id });
        }

        // Update Header UI
        if (chatUsernameElement) chatUsernameElement.textContent = user.display_name || 'Chat';
        if (chatUserPicElement) {
            chatUserPicElement.src = user.profile_image || DEFAULT_AVATAR;
            chatUserPicElement.alt = `${user.display_name || 'User'}'s profile picture`;
            chatUserPicElement.onerror = () => { chatUserPicElement.src = DEFAULT_AVATAR; };
        }
        updateChatHeaderStatusUI(originalStatusHTML);

        // Prepare Chat Box
        if (chatBox) {
            chatBox.innerHTML = `<p class="p-4 text-center text-gray-500 dark:text-gray-300 animate-pulse">Loading messages...</p>`;
        }

        // Show/Hide UI Elements
        if (noChatMessageElement) noChatMessageElement.classList.add('hidden');
        if (chatHeader) { chatHeader.classList.remove('hidden'); chatHeader.classList.add('flex'); }
        if (chatInputBar) { chatInputBar.classList.remove('hidden'); chatInputBar.classList.add('flex'); }
        if (pingUserButton) pingUserButton.classList.remove('hidden');

        // Fetch and Render Messages
        if (chatBox) {
            try {
                const res = await fetch(`/messages/${id}`);
                if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
                const messages = await res.json();

                chatBox.innerHTML = ''; // Clear loading/previous messages

                if (messages.length > 0) {
                    messages.sort((a, b) => new Date(a.date) - new Date(b.date)); // Ensure order
                    messages.forEach(m => addMessageToBox(m));
                    scrollToBottom();
                } else {
                     // Optionally show a "No messages yet" indicator
                     chatBox.innerHTML = `<p class="p-4 text-center text-gray-500 dark:text-gray-400">No messages yet. Start the conversation!</p>`;
                }
            } catch (error) {
                console.error("[Join Chat] Error fetching messages:", error);
                chatBox.innerHTML = `<div class="relative z-10 text-center text-red-500 p-4">Error loading messages. Please try again.</div>`;
            }
        }

        // Start Active Status Polling
        fetchAndUpdateStatus(id); // Immediate check
        startActiveChatStatusUpdates();

        // Handle Mobile View Switching
        if (window.innerWidth < 768 && chatAreaContainer && sidebarContainer) {
            chatAreaContainer.classList.remove('hidden'); chatAreaContainer.classList.add('flex');
            sidebarContainer.classList.add('hidden'); sidebarContainer.classList.remove('flex');
        }

        // Focus Input
        setTimeout(() => { if (messageInput) messageInput.focus(); }, 100);
    }

    /** Fetches the basic list of users and their latest previews to populate the sidebar. */
    async function loadUsersWithPreviews() {
        if (!userListContainer) return;
        userListContainer.innerHTML = `<p class="p-4 text-center text-gray-500 dark:text-gray-300 animate-pulse">Loading chats...</p>`;

        let users = [];
        let previews = {};

        try {
            // Fetch Basic User List
            const userRes = await fetch('/chat_users');
            if (!userRes.ok) throw new Error(`HTTP error fetching users: ${userRes.status}`);
            users = await userRes.json();

            if (users.length === 0) {
                userListContainer.innerHTML = `<p class="p-4 text-center text-gray-500 dark:text-gray-400">No chats found. Use 'Connect'.</p>`;
                return;
            }

            // Fetch Chat Previews
            try {
                const previewRes = await fetch('/api/chat_previews');
                if (previewRes.ok) previews = await previewRes.json();
                else console.warn(`Failed to fetch previews (Status: ${previewRes.status}).`);
            } catch (previewError) {
                console.error("Network error fetching chat previews:", previewError);
            }

            // Sort users by latest message timestamp from previews
            users.sort((a, b) => {
                const timeA = previews[a.id]?.latest_message?.timestamp;
                const timeB = previews[b.id]?.latest_message?.timestamp;
                if (timeA && timeB) return new Date(timeB) - new Date(timeA);
                if (timeA) return -1;
                if (timeB) return 1;
                return (a.display_name || '').localeCompare(b.display_name || '');
            });

            // Render List Structure
            userListContainer.innerHTML = '';
            const fragment = document.createDocumentFragment();
            users.forEach(user => {
                const div = document.createElement('div');
                div.className = 'user-list-item p-3 mx-2 md:mx-4 my-1 border-b dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer flex items-center space-x-3 transition-colors duration-200 rounded-md';
                div.innerHTML = `
                    <div class="relative flex-shrink-0">
                        <img src="${user.profile_image || DEFAULT_AVATAR}" class="w-10 h-10 rounded-full object-cover" alt="${user.display_name || 'User'}" onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';" />
                        <span class="online-dot-indicator absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white dark:border-gray-800 rounded-full" style="display: none;"></span>
                    </div>
                    <div class="flex-grow overflow-hidden">
                        <p class="font-semibold text-gray-800 dark:text-gray-100 truncate">${user.display_name || 'Unknown User'}</p>
                        <p class="latest-message-snippet text-gray-600 dark:text-gray-400 truncate text-xs mt-1"><!-- Populated by JS --></p>
                        <p class="status-text text-xs text-gray-500 dark:text-gray-400 mt-1"><!-- Status --></p>
                    </div>
                    <div class="flex-shrink-0 ml-auto flex items-center justify-center w-6">
                       <span class="unread-badge bg-${userColorScheme}-500 text-white text-[0.65rem] font-bold rounded-full px-1.5 py-0.5 min-w-[1.25rem] h-[1.25rem] flex items-center justify-center leading-none" style="display: none;"></span>
                    </div>
                `;
                populateUserListItem(div, user, previews[user.id]);
                fragment.appendChild(div);
            });
            userListContainer.appendChild(fragment);

            // Start background status updates for the list
            startAllUsersStatusUpdates();
            // Start preview polling as well
            startChatPreviewPolling();

        } catch (error) {
            console.error("[Load Users] Error:", error);
            if (userListContainer) userListContainer.innerHTML = `<p class="p-4 text-red-500 text-center">Could not load chats. ${error.message}</p>`;
        }
    }

    /** Populates a single user list item element with user data and preview info. */
    function populateUserListItem(listItemElement, user, previewData = null) {
        if (!listItemElement || !user) return;

        const userId = user.id;
        listItemElement.setAttribute('data-user-id', userId);

        // Basic Info
        const img = listItemElement.querySelector('img');
        const nameP = listItemElement.querySelector('.font-semibold');
        if(img) {
            img.src = user.profile_image || DEFAULT_AVATAR;
            img.alt = user.display_name || 'User';
        }
        if(nameP) nameP.textContent = user.display_name || 'Unknown User';

        // Online Status (Initial)
        const statusElement = listItemElement.querySelector('.status-text');
        const onlineIndicator = listItemElement.querySelector('.online-dot-indicator');
        if (statusElement) statusElement.innerHTML = getStatusHTML(user.online, user.last_seen);
        if (onlineIndicator) onlineIndicator.style.display = user.online ? 'block' : 'none';


        // Snippet & Badge (Prioritize previewData)
        let latestMsgDataForSnippet = null;
        let unreadCount = 0;
        if (previewData?.latest_message) latestMsgDataForSnippet = previewData.latest_message;
        if (previewData?.unread_count) unreadCount = parseInt(previewData.unread_count) || 0;

        updateUserListSnippet(listItemElement, latestMsgDataForSnippet);
        updateUserUnreadBadge(listItemElement, unreadCount);

        // Store combined data in dataset
        let combinedUserData = { ...user, unread_count: unreadCount };
        if (latestMsgDataForSnippet) {
            combinedUserData.latest_message_content = latestMsgDataForSnippet.content || (latestMsgDataForSnippet.media_url ? '[Media]' : null);
            combinedUserData.latest_message_sender_id = latestMsgDataForSnippet.sender_id;
            combinedUserData.latest_message_timestamp_iso = latestMsgDataForSnippet.timestamp;
        }
        listItemElement.dataset.userData = JSON.stringify(combinedUserData);

        // Attach click handler (replace existing)
        listItemElement.onclick = () => {
            try {
                const userDataOnClick = JSON.parse(listItemElement.dataset.userData || '{}');
                if (userDataOnClick.id) joinChat(userDataOnClick.id, userDataOnClick);
                else console.error("Missing user ID for click handler:", listItemElement);
            } catch (e) { console.error("Error parsing user data on click:", e); }
        };
    }

    /** Updates the unread messages badge for a user list item. */
    function updateUserUnreadBadge(userListItem, newCount) {
        if (!userListItem) return;
        const badgeElement = userListItem.querySelector('.unread-badge');
        if (!badgeElement) return;

        const count = parseInt(newCount) || 0;
        if (count > 0) {
            badgeElement.textContent = count > 99 ? '99+' : count;
            badgeElement.style.display = 'inline-flex';
        } else {
            badgeElement.style.display = 'none';
        }

        // Update stored data
        try {
            const currentData = JSON.parse(userListItem.dataset.userData || '{}');
            currentData.unread_count = count;
            userListItem.dataset.userData = JSON.stringify(currentData);
        } catch (e) { console.error("Failed to update badge data:", e); }
    }

    /** Updates the latest message snippet in a user list item. */
    function updateUserListSnippet(userListItem, latestMsgData) {
        if (!userListItem) return;
        const snippetElement = userListItem.querySelector('.latest-message-snippet');
        if (!snippetElement) return;

        let snippet = '<span class="italic text-gray-400">No messages yet</span>';
        let latestMsgContent = null;
        let latestMsgSenderId = null;
        let latestMsgTimestampIso = null;

        if (latestMsgData && typeof latestMsgData === 'object') {
             const prefix = latestMsgData.sender_id === currentUserId ? '<span class="text-blue-500 dark:text-blue-400">You:</span> ' : '';
             let content = '';
             if (latestMsgData.deleted_for_everyone) {
                 content = '<i class="fas fa-ban mr-1 text-gray-400"></i>[Message deleted]';
             } else {
                 content = latestMsgData.content || (latestMsgData.media_url ? '[Media]' : '...');
             }
             const safeContent = sanitizeText(content).substring(0, 35); // Limit length
             snippet = prefix + safeContent + (content.length > 35 ? '...' : '');

             latestMsgContent = content;
             latestMsgSenderId = latestMsgData.sender_id;
             latestMsgTimestampIso = latestMsgData.timestamp || latestMsgData.date || new Date().toISOString();
        }

        snippetElement.innerHTML = snippet;
        snippetElement.title = latestMsgContent ? (latestMsgSenderId === currentUserId ? 'You: ' : '') + sanitizeText(latestMsgContent) : 'No messages';

        // Render emojis
        if (typeof twemoji !== 'undefined') {
            try { twemoji.parse(snippetElement, { folder: 'svg', ext: '.svg' }); }
            catch(e) { console.error("Twemoji snippet error:", e); }
        }

        // Update stored data
        try {
            const currentData = JSON.parse(userListItem.dataset.userData || '{}');
            currentData.latest_message_content = latestMsgContent;
            currentData.latest_message_sender_id = latestMsgSenderId;
            currentData.latest_message_timestamp_iso = latestMsgTimestampIso;
            userListItem.dataset.userData = JSON.stringify(currentData);
        } catch (e) { console.error("Failed to update snippet data:", e); }
    }


    // --- Status Update Logic ---

    /** Updates status indicators (dot, text) in the user list and potentially the chat header. */
    function updateStatusElements(userId, isOnline, lastSeenIsoUtc, isError = false) {
        const userListItem = querySelector(`.user-list-item[data-user-id='${userId}']`);

        // Update User List Item
        if (userListItem) {
            const statusElement = userListItem.querySelector('.status-text');
            const onlineIndicator = userListItem.querySelector('.online-dot-indicator');
            let statusTextHTML = '<span class="text-orange-500">Status N/A</span>';
            let showDot = false;

            if (!isError) {
                 statusTextHTML = getStatusHTML(isOnline, lastSeenIsoUtc);
                 showDot = isOnline === true;
            }

            if (statusElement) statusElement.innerHTML = statusTextHTML;
            if (onlineIndicator) onlineIndicator.style.display = showDot ? 'block' : 'none';

             // Update stored data in dataset
             try {
                const currentData = JSON.parse(userListItem.dataset.userData || '{}');
                currentData.online = isOnline;
                currentData.last_seen = lastSeenIsoUtc;
                userListItem.dataset.userData = JSON.stringify(currentData);
            } catch (e) { console.error("Failed to update status data:", e); }
        }

        // Update Chat Header if this user is the active chat partner
        if (currentReceiverUser && currentReceiverUser.id === userId) {
            let newHeaderStatusHTML = '';
            if (!isError) {
                // Update the cached user data as well
                currentReceiverUser.online = isOnline;
                currentReceiverUser.last_seen = lastSeenIsoUtc;
                newHeaderStatusHTML = getHeaderStatusHTML(isOnline, lastSeenIsoUtc, currentReceiverUser.bio);
            } else {
                newHeaderStatusHTML = '<b><span class="text-orange-500">Status Unavailable</span></b>';
            }

            originalStatusHTML = newHeaderStatusHTML; // Store latest non-typing status

            // Only update UI if 'typing...' indicator isn't currently shown
            const isPartnerTypingIndicatorVisible = chatUserStatusElement?.querySelector('.typing-indicator');
            if (!isPartnerTypingIndicatorVisible) {
                updateChatHeaderStatusUI(originalStatusHTML);
            }
        }
    }

    /** Fetches status for a single user ID and updates the UI. */
    async function fetchAndUpdateStatus(userId) {
        if (!userId || !socket.connected) return;
        try {
            const response = await fetch(`/api/user_status/${userId}`);
            if (!response.ok) throw new Error(`Status ${response.status}`);
            const statusData = await response.json();
            updateStatusElements(userId, statusData.online, statusData.last_seen);
        } catch (error) {
            console.error(`[Status Fetch] Failed for ${userId}:`, error);
            updateStatusElements(userId, null, null, true); // Mark as error
        }
    }

    /** Starts polling the status of the currently active chat partner frequently. */
    function startActiveChatStatusUpdates() {
        stopActiveChatStatusUpdates();
        if (receiverId) {
            activeChatStatusInterval = setInterval(() => {
                if (receiverId && socket.connected && !document.hidden) {
                    fetchAndUpdateStatus(receiverId);
                } else {
                    stopActiveChatStatusUpdates(); // Stop if conditions aren't met
                }
            }, STATUS_CHECK_INTERVAL_MS);
        }
    }

    /** Stops polling the status of the active chat partner. */
    function stopActiveChatStatusUpdates() {
        if (activeChatStatusInterval) {
            clearInterval(activeChatStatusInterval);
            activeChatStatusInterval = null;
        }
    }

    /** Starts polling the status of all users in the sidebar list less frequently. */
    function startAllUsersStatusUpdates() {
        stopAllUsersStatusUpdates();
        const updateOthers = () => {
            if (!userListContainer || !socket.connected || document.hidden) return;
            const userItems = userListContainer.querySelectorAll('.user-list-item');
            userItems.forEach(item => {
                const userId = item.getAttribute('data-user-id');
                if (userId && parseInt(userId) !== receiverId) {
                    fetchAndUpdateStatus(parseInt(userId));
                }
            });
        };
        updateOthers(); // Immediate check
        allUsersStatusInterval = setInterval(updateOthers, ALL_USERS_CHECK_INTERVAL_MS);
    }

    /** Stops polling the status of all users in the sidebar list. */
    function stopAllUsersStatusUpdates() {
        if (allUsersStatusInterval) {
            clearInterval(allUsersStatusInterval);
            allUsersStatusInterval = null;
        }
    }


    // --- Sidebar Preview Polling ---

    /** Fetches chat previews and updates the sidebar list items. */
    async function fetchAndUpdateChatPreviews() {
        if (document.hidden || !socket.connected) { return; } // Only poll if visible and connected

        try {
            const response = await fetch('/api/chat_previews');
            if (!response.ok) { console.error(`Preview poll failed: ${response.status}`); return; }
            const previews = await response.json();

            if (!userListContainer) return;

            let itemsUpdated = false;
            for (const partnerId in previews) {
                const previewData = previews[partnerId];
                const userListItem = userListContainer.querySelector(`.user-list-item[data-user-id='${partnerId}']`);

                if (userListItem) {
                    let itemNeedsUpdate = false;
                    try {
                        const currentData = JSON.parse(userListItem.dataset.userData || '{}');
                        const currentUnread = currentData.unread_count || 0;
                        const currentTimestamp = currentData.latest_message_timestamp_iso || null;

                        // Compare Unread Count
                        const newUnread = parseInt(previewData.unread_count) || 0;
                        if (newUnread !== currentUnread) {
                            updateUserUnreadBadge(userListItem, newUnread);
                            itemNeedsUpdate = true;
                        }

                        // Compare Snippet based on timestamp
                        const newMessage = previewData.latest_message;
                        const newTimestamp = newMessage?.timestamp;
                        if (newTimestamp && newTimestamp !== currentTimestamp) {
                            updateUserListSnippet(userListItem, newMessage);
                            itemNeedsUpdate = true;
                        } else if (newMessage && !currentTimestamp) { // First message case
                             updateUserListSnippet(userListItem, newMessage);
                             itemNeedsUpdate = true;
                        }

                        if (itemNeedsUpdate) {
                            itemsUpdated = true;
                            // Move updated item to top
                            if (userListContainer.firstChild !== userListItem) {
                                userListContainer.insertBefore(userListItem, userListContainer.firstChild);
                            }
                        }
                    } catch (e) { console.error(`Error processing preview for user ${partnerId}:`, e); }
                } else {
                     console.warn(`User ${partnerId} from preview not in list.`);
                     // Possibly trigger a full refresh if this happens? loadUsersWithPreviews();
                }
            }
        } catch (error) { console.error("Error fetching/processing previews:", error); }
    }

    /** Starts the periodic polling for chat previews. */
    function startChatPreviewPolling() {
        stopChatPreviewPolling();
        fetchAndUpdateChatPreviews(); // Run immediately
        chatPreviewPollInterval = setInterval(fetchAndUpdateChatPreviews, CHAT_PREVIEW_POLL_INTERVAL_MS);
    }

    /** Stops the periodic polling for chat previews. */
    function stopChatPreviewPolling() {
        if (chatPreviewPollInterval) {
            clearInterval(chatPreviewPollInterval);
            chatPreviewPollInterval = null;
        }
    }


    // --- Media Handling ---

    /** Handles the file selection, validation, and initiates the preview. */
    function handleMediaFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            // Validation
            if (file.size > MAX_FILE_SIZE_BYTES) {
                alert(`File too large (${(file.size / 1024 / 1024).toFixed(1)} MB). Max ${MAX_FILE_SIZE_MB} MB.`);
                event.target.value = ''; return;
            }
            if (!file.type.startsWith('image/') && !file.type.startsWith('video/')) {
                alert('Invalid file type. Please select an image or video.');
                event.target.value = ''; return;
            }
            if (!receiverId) {
                alert("Please select a chat before sending media.");
                 event.target.value = ''; return;
            }

            showMediaPreview(file); // Show preview modal
        }
        event.target.value = ''; // Reset input value after handling
    }

    /** Displays the media preview modal with the selected file. */
    function showMediaPreview(file) {
        if (!file || !mediaPreviewModal || !mediaPreviewDialog) return;

        currentPreviewFile = file; // Store file reference

        // Reset preview elements
        mediaPreviewImage.classList.add('hidden'); mediaPreviewImage.src = '';
        mediaPreviewVideo.classList.add('hidden'); mediaPreviewVideo.src = '';
        mediaPreviewVideo.pause(); mediaPreviewVideo.currentTime = 0;
        mediaPreviewError.classList.add('hidden');
        mediaPreviewCaption.value = '';

        try {
            currentPreviewUrl = URL.createObjectURL(file);

            if (file.type.startsWith('image/')) {
                mediaPreviewImage.src = currentPreviewUrl;
                mediaPreviewImage.onload = () => mediaPreviewImage.classList.remove('hidden');
                mediaPreviewImage.onerror = () => { cleanupPreviewUrl(); mediaPreviewError.classList.remove('hidden'); };
            } else if (file.type.startsWith('video/')) {
                mediaPreviewVideo.src = currentPreviewUrl;
                mediaPreviewVideo.oncanplay = () => mediaPreviewVideo.classList.remove('hidden');
                mediaPreviewVideo.onerror = () => { cleanupPreviewUrl(); mediaPreviewError.classList.remove('hidden'); };
            } else {
                throw new Error("Unsupported file type for preview.");
            }

            // Show modal with animation
            mediaPreviewModal.classList.remove('hidden', 'opacity-0');
            requestAnimationFrame(() => {
                mediaPreviewDialog.classList.remove('scale-95', 'opacity-0');
                mediaPreviewDialog.classList.add('scale-100', 'opacity-100');
            });

        } catch (error) {
            console.error("Error creating preview:", error);
            cleanupPreviewUrl();
            mediaPreviewError.classList.remove('hidden');
            mediaPreviewModal.classList.remove('hidden'); // Show modal even on error
        }
    }

    /** Closes the media preview modal and cleans up resources. */
    function closeMediaPreview() {
        if (mediaPreviewModal && mediaPreviewDialog && !mediaPreviewModal.classList.contains('hidden')) {
            mediaPreviewDialog.classList.remove('scale-100', 'opacity-100');
            mediaPreviewDialog.classList.add('scale-95', 'opacity-0');
            mediaPreviewModal.classList.add('opacity-0');

            setTimeout(() => {
                mediaPreviewModal.classList.add('hidden');
                cleanupPreviewUrl(); // Revoke URL and clear file reference
            }, 300);
        }
    }

    /** Revokes the object URL and clears the file reference. */
    function cleanupPreviewUrl() {
        if (currentPreviewUrl) {
            URL.revokeObjectURL(currentPreviewUrl);
            currentPreviewUrl = null;
        }
        currentPreviewFile = null;
    }

    /** Handles the 'Send' button click in the media preview modal. */
    function handlePreviewSend() {
        if (!currentPreviewFile) { closeMediaPreview(); return; }
        const caption = mediaPreviewCaption.value.trim();
        handleMediaUpload(currentPreviewFile, caption); // Start the upload process
        closeMediaPreview();
    }

    /** Uploads the selected media file with an optional caption. */
    async function handleMediaUpload(file, caption = '') {
        if (!receiverId || !file) return;

        sendStopTypingEvent();

        const tempId = `local_media_${Date.now()}`;
        const localTimestamp = new Date();
        const uploadingText = `<i class="opacity-75 text-xs">Uploading ${sanitizeText(file.name)}...</i>`;

        // Show temporary uploading message
        addMessageToBox({
            localId: tempId, id: null, sender_id: currentUserId, receiver_id: receiverId,
            content: caption ? `${sanitizeText(caption)}<br>${uploadingText}` : uploadingText,
            media_url: null, date: localTimestamp.toISOString(), seen: null
        });
        scrollToBottom();

        const formData = new FormData();
        formData.append('file', file);
        formData.append('receiver_id', receiverId);

        try {
            const res = await fetch('/upload', { method: 'POST', body: formData });
            const data = await res.json();

            // Remove temporary message
            const tempMsgElement = getElement(`message-${tempId}`);
            if (tempMsgElement) tempMsgElement.remove();

            if (res.ok && data.url) {
                // Send final message via socket
                socket.emit('send_message', {
                    receiver_id: receiverId,
                    content: caption,
                    media_url: data.url
                    // Server will add timestamp and ID
                });
            } else {
                throw new Error(data.error || `Server error ${res.status}`);
            }
        } catch (error) {
            console.error('[Media Upload] Error:', error);
            const tempMsgElementOnError = getElement(`message-${tempId}`);
            if(tempMsgElementOnError) tempMsgElementOnError.remove();
            // Show error message in chat
            addMessageToBox({
                localId: `err_${Date.now()}`, id: null, sender_id: currentUserId, receiver_id: receiverId,
                content: `<i class="text-red-500 text-xs">Upload failed: ${sanitizeText(file.name)} - ${sanitizeText(error.message)}</i>`,
                media_url: null, date: new Date().toISOString(), seen: null
            });
            scrollToBottom();
        }
    }

    /** Opens the media viewer modal (for images/videos already in chat). */
    function openMediaModal(src, type) {
        if (!mediaViewerModal || !src || !type) return;

        // Reset elements first
        mediaViewerImage.classList.add('hidden'); mediaViewerImage.src = '';
        mediaViewerVideo.classList.add('hidden'); mediaViewerVideo.src = '';
        mediaViewerVideo.pause(); mediaViewerVideo.currentTime = 0;
        if (mediaViewerLoading) mediaViewerLoading.classList.add('hidden');

        let loadErrorOccurred = false;

        if (type === 'image') {
            if (mediaViewerLoading) mediaViewerLoading.classList.remove('hidden');
            mediaViewerImage.onerror = () => { if(loadErrorOccurred) return; loadErrorOccurred = true; console.error("Viewer: Failed image", src); closeMediaModal(); };
            mediaViewerImage.onload = () => { if(loadErrorOccurred) return; mediaViewerImage.classList.remove('hidden'); if (mediaViewerLoading) mediaViewerLoading.classList.add('hidden'); };
            mediaViewerImage.src = src;
        } else if (type === 'video') {
            if (mediaViewerLoading) mediaViewerLoading.classList.remove('hidden');
            mediaViewerVideo.onerror = () => { if(loadErrorOccurred) return; loadErrorOccurred = true; console.error("Viewer: Failed video", src); closeMediaModal(); };
            mediaViewerVideo.oncanplay = () => { if(loadErrorOccurred) return; if (mediaViewerLoading) mediaViewerLoading.classList.add('hidden'); mediaViewerVideo.classList.remove('hidden'); };
            mediaViewerVideo.src = src;
        } else {
            return; // Unsupported type
        }

        if (!loadErrorOccurred) {
            mediaViewerModal.classList.remove('hidden', 'opacity-0');
            requestAnimationFrame(() => { mediaViewerModal.classList.add('opacity-100'); });
            document.addEventListener('keydown', handleMediaViewerEscKey);
        }
    }

    /** Closes the media viewer modal. */
    function closeMediaModal() {
        if (!mediaViewerModal || mediaViewerModal.classList.contains('hidden')) return;

        mediaViewerModal.classList.remove('opacity-100');
        mediaViewerModal.classList.add('opacity-0');
        mediaViewerVideo.pause(); // Stop video immediately

        setTimeout(() => {
            mediaViewerModal.classList.add('hidden');
            mediaViewerImage.src = ''; mediaViewerImage.classList.add('hidden');
            mediaViewerVideo.src = ''; mediaViewerVideo.classList.add('hidden');
            if (mediaViewerLoading) mediaViewerLoading.classList.add('hidden');
        }, 200); // Match transition duration

        document.removeEventListener('keydown', handleMediaViewerEscKey);
    }

    /** Handles the ESC key press to close the media viewer. */
    function handleMediaViewerEscKey(event) {
        if (event.key === 'Escape') {
            closeMediaModal();
        }
    }


    // --- Typing Indicator Logic ---

    /** Emits a 'stop_typing' event to the server if the user was typing. */
    function sendStopTypingEvent() {
        if (isTyping && receiverId && socket.connected) {
            clearTimeout(typingTimer);
            socket.emit('stop_typing', { receiver_id: receiverId });
            isTyping = false;
            typingTimer = null;
        }
    }


    // --- Ping Logic ---

    /** Handles the click event for the 'Ping User' button. */
    function handlePingButtonClick() {
        if (!receiverId || !socket.connected || !pingUserButton) return;
        if (pingUserButton.disabled) return; // Cooldown active

        socket.emit('send_ping', { receiver_id: receiverId });

        // Cooldown Visuals
        pingUserButton.disabled = true;
        pingUserButton.classList.add('opacity-50', 'cursor-not-allowed');
        const originalIcon = pingUserButton.innerHTML;
        pingUserButton.innerHTML = '<i class="fas fa-spinner fa-spin text-xl"></i>';

        clearTimeout(pingButtonCooldownTimer);
        pingButtonCooldownTimer = setTimeout(() => {
            if (pingUserButton) {
                 pingUserButton.disabled = false;
                 pingUserButton.classList.remove('opacity-50', 'cursor-not-allowed');
                 pingUserButton.innerHTML = originalIcon;
            }
        }, 7000); // 7-second cooldown
    }

    /** Displays a temporary notification when a ping is received. */
    function showTemporaryPingNotification(senderName) {
        let notificationElement = getElement('ping-notification-area');
        if (!notificationElement) {
             notificationElement = document.createElement('div');
             notificationElement.id = 'ping-notification-area';
             // Position fixed, top-right, styled according to user's theme
             notificationElement.className = `fixed top-4 right-4 z-50 p-3 rounded-md shadow-lg bg-${userColorScheme}-100 dark:bg-${userColorScheme}-800 text-${userColorScheme}-700 dark:text-${userColorScheme}-200 border border-${userColorScheme}-300 dark:border-${userColorScheme}-600 transition-opacity duration-300 ease-out opacity-0`;
             document.body.appendChild(notificationElement);
        }
        notificationElement.innerHTML = `<i class="fas fa-bell mr-2"></i> ${sanitizeText(senderName)} pinged you!`; // Use innerHTML for icon
        notificationElement.classList.remove('opacity-0'); // Fade in

        setTimeout(() => { // Fade out
            notificationElement.classList.add('opacity-0');
        }, 4000);
    }


    // --- Dropdown & Modal Logic ---

    /** Opens the user info modal with details of the current chat partner. */
    function openUserInfoModal() {
        if (currentReceiverUser && userInfoModal && userInfoModalContent) {
            const statusSubHeader = getStatusHTML(currentReceiverUser.online, currentReceiverUser.last_seen);
            userInfoModalContent.innerHTML = `
                <div class="flex items-center space-x-4 mb-4">
                    <img src="${currentReceiverUser.profile_image || DEFAULT_AVATAR}" class="w-16 h-16 rounded-full object-cover flex-shrink-0" alt="${currentReceiverUser.display_name || 'User'}'s picture" onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';" />
                    <div class="flex-grow min-w-0">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-gray-200 truncate">${sanitizeText(currentReceiverUser.display_name) || 'User'}</h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400">${statusSubHeader}</p> <!-- Status already HTML -->
                    </div>
                </div>
                <p class="text-sm text-gray-700 dark:text-gray-300 mt-1">Username: @${sanitizeText(currentReceiverUser.username) || 'N/A'}</p>
                <p class="text-sm text-gray-700 dark:text-gray-300 mt-1">Level: ${currentReceiverUser.level || 'N/A'}</p>
                <p class="text-sm text-gray-700 dark:text-gray-300 mt-1">Joined: ${currentReceiverUser.joined ? new Date(currentReceiverUser.joined).toLocaleDateString() : 'N/A'}</p>
                <p class="text-sm text-gray-700 dark:text-gray-300 mt-2">Bio:</p>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1 max-h-24 overflow-y-auto break-words">${sanitizeText(currentReceiverUser.bio) || 'No bio available.'}</p>
            `;
            userInfoModal.classList.remove('hidden');
            // Update profile button link
             const profileButton = userInfoModal.querySelector('button[onclick*="window.location.href"]');
             if(profileButton) {
                 profileButton.onclick = () => window.location.href = `/profile/${currentReceiverUser.username}`;
                 profileButton.disabled = false;
             }

        } else if (userInfoModal) {
             // Handle case where modal opened but no user selected (e.g., clicking header before chat)
             userInfoModalContent.innerHTML = '<p class="text-sm text-gray-500">Select a chat to view user information.</p>';
             const profileButton = userInfoModal.querySelector('button[onclick*="window.location.href"]');
             if(profileButton) profileButton.disabled = true; // Disable profile button
             userInfoModal.classList.remove('hidden');
        }
    }

    /** Closes the user info modal. */
    function closeUserInfoModal() {
        if (userInfoModal) userInfoModal.classList.add('hidden');
    }
    // Expose globally for HTML onclick attributes
    window.openUserInfoModal = openUserInfoModal;
    window.closeUserInfoModal = closeUserInfoModal;

    /** Opens the message options dropdown menu, positioned near the triggering element. */
    function openMessageOptionsDropdown(event, messageElement) {
        event.stopPropagation();
        if (!messageOptionsDropdown || !messageElement) return;

        const messageId = messageElement.getAttribute('data-message-id');
        if (!messageId || messageId.startsWith('local_')) return; // No options for local/unconfirmed messages

        const senderId = parseInt(messageElement.getAttribute('data-sender-id'));
        const isSender = senderId === currentUserId;
        const isDeleted = messageElement.getAttribute('data-is-deleted') === 'true';
        const messageContent = messageElement.getAttribute('data-content');

        // Close previous dropdown if open for a different message
        if (currentOpenDropdownMessageId && currentOpenDropdownMessageId !== messageId) {
            closeMessageOptionsDropdown();
        }

        if (isDeleted) { closeMessageOptionsDropdown(); return; } // No options for deleted

        // Configure Dropdown Options Visibility
        messageOptionsDropdown.setAttribute('data-message-id', messageId);
        const replyButton = messageOptionsDropdown.querySelector('[data-action="reply"]');
        const copyButton = messageOptionsDropdown.querySelector('[data-action="copy"]');
        const deleteMeButton = messageOptionsDropdown.querySelector('[data-action="delete-me"]');
        const deleteEveryoneButton = messageOptionsDropdown.querySelector('[data-action="delete-everyone"]');

        if (replyButton) replyButton.style.display = 'block';
        if (copyButton) copyButton.style.display = messageContent ? 'block' : 'none';
        if (deleteMeButton) deleteMeButton.style.display = 'block';
        if (deleteEveryoneButton) deleteEveryoneButton.style.display = isSender ? 'block' : 'none';

        // Position Dropdown
        const triggerButton = messageElement.querySelector('.message-options-trigger');
        const positioningElement = triggerButton || messageElement.querySelector('.message-bubble');
        if (!positioningElement) return;
        const rect = positioningElement.getBoundingClientRect();

        let top = rect.bottom + window.scrollY + 2;
        let left = isSender ? (rect.right + window.scrollX - messageOptionsDropdown.offsetWidth) : (rect.left + window.scrollX);

        messageOptionsDropdown.style.position = 'absolute';
        messageOptionsDropdown.style.top = `${top}px`;
        messageOptionsDropdown.style.left = `${left}px`;
        messageOptionsDropdown.classList.remove('hidden');
        currentOpenDropdownMessageId = messageId;

        // Adjust if off-screen
        requestAnimationFrame(() => {
            const dropdownRect = messageOptionsDropdown.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;

            if (dropdownRect.right > viewportWidth - 10) messageOptionsDropdown.style.left = `${viewportWidth - dropdownRect.width - 10 + window.scrollX}px`;
            else if (dropdownRect.left < 10) messageOptionsDropdown.style.left = `${10 + window.scrollX}px`;

            if (dropdownRect.bottom > viewportHeight - 10) {
                const topAbove = rect.top + window.scrollY - dropdownRect.height - 2;
                if (topAbove > window.scrollY + 10) messageOptionsDropdown.style.top = `${topAbove}px`;
                else messageOptionsDropdown.style.top = `${viewportHeight - dropdownRect.height - 10 + window.scrollY}px`;
            }
        });
    }

    /** Closes the message options dropdown menu. */
    function closeMessageOptionsDropdown() {
        if (messageOptionsDropdown && !messageOptionsDropdown.classList.contains('hidden')) {
            messageOptionsDropdown.classList.add('hidden');
            messageOptionsDropdown.removeAttribute('style');
            messageOptionsDropdown.setAttribute('data-message-id', '');
            currentOpenDropdownMessageId = null;
        }
    }

    /** Handles clicks on buttons within the message options dropdown. */
    function handleMessageOptionClick(event) {
        const button = event.target.closest('.message-option-button');
        if (!button || !messageOptionsDropdown) return;

        const action = button.getAttribute('data-action');
        const messageId = messageOptionsDropdown.getAttribute('data-message-id');
        const messageElement = getElement(`message-${messageId}`);

        if (!messageId || messageId.startsWith('local_')) return; // Ignore local messages

        switch (action) {
            case 'reply':
                alert(`Reply to message ${messageId} (coming soon)`); // Placeholder
                break;
            case 'copy':
                 if (messageElement) {
                     const originalContent = messageElement.getAttribute('data-content');
                     if (originalContent) navigator.clipboard.writeText(originalContent);
                 }
                break;
            case 'delete-me':
                if (messageElement) messageElement.remove(); // Local removal only
                break;
            case 'delete-everyone':
                if (socket.connected) {
                     if (confirm("Delete this message for everyone? This cannot be undone.")) {
                         socket.emit('delete_message', { message_id: messageId });
                     }
                } else { alert("Cannot delete: Not connected."); }
                break;
        }
        closeMessageOptionsDropdown();
    }

    /** Toggles the visibility of the main options dropdown in the chat header. */
    function toggleOptionsDropdown() {
        if (optionsDropdown) optionsDropdown.classList.toggle('hidden');
    }

    /** Closes the main options dropdown in the chat header. */
    function closeOptionsDropdown() {
        if (optionsDropdown) optionsDropdown.classList.add('hidden');
    }
    // Expose globally for HTML onclick
    window.closeOptionsDropdown = closeOptionsDropdown;

    // --- Emoji Picker Logic ---
    // --- (Functions: populateEmojiPicker, switchEmojiTab, toggleEmojiPicker, closeEmojiPicker) ---
    // --- These functions now have access to the global emojiCategories ---
    /** Populates an emoji panel (category or search) with emoji buttons. */
    // Create debounced version of filterEmojis
    const debouncedFilterEmojis = debounce(filterEmojis, EMOJI_SEARCH_DEBOUNCE_MS);

    function populateEmojiPanel(panelElement, emojis) {
        if (!panelElement) return;
        panelElement.innerHTML = ''; // Clear previous
        const fragment = document.createDocumentFragment();
        emojis.forEach(emoji => {
            const button = document.createElement('button');
            button.setAttribute('type', 'button');
            // Ensure button text is the emoji itself
            button.textContent = emoji;
            button.onclick = () => {
                if (messageInput) {
                    const start = messageInput.selectionStart;
                    const end = messageInput.selectionEnd;
                    const originalValue = messageInput.value; // Get value before change

                    // Construct the new value by inserting the emoji
                    const newValue = originalValue.substring(0, start) + emoji + originalValue.substring(end);

                    // Update the input value
                    messageInput.value = newValue;

                    // Calculate the new cursor position. It should be the original start position
                    // plus the actual length (in UTF-16 code units) of the inserted emoji string.
                    const newCursorPos = start + emoji.length; // <-- Use simple emoji.length

                    // Ensure focus is on the input
                    messageInput.focus();

                    // Set the cursor position *after* the inserted emoji
                    // Use requestAnimationFrame to ensure DOM updates are processed before setting selection
                    requestAnimationFrame(() => {
                         messageInput.setSelectionRange(newCursorPos, newCursorPos);
                    });


                    // --- Trigger input event manually ---
                    // This helps if other parts of the code (like emoji suggestions)
                    // rely on the 'input' event.
                    messageInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
            };
            fragment.appendChild(button);
        });
        panelElement.appendChild(fragment);
    }

    /** Switches the active tab and content panel in the emoji picker. */
    function switchEmojiTab(tabName) {
        if (!tabName || !emojiPicker) return;

        // Clear search input and filter when switching tabs
        if (emojiSearchInput) {
            emojiSearchInput.value = '';
            // No need to call filterEmojis directly, hiding panels below handles it
        }

        querySelectorAll('#emoji-picker-tabs button.emoji-tab-button').forEach(btn => {
             btn.classList.toggle('active', btn.id === `tab-${tabName}`);
        });
        querySelectorAll('#emoji-picker-panels .emoji-category-panel').forEach(panel => {
            panel.classList.toggle('hidden', panel.id !== `panel-${tabName}`);
        });

        // Populate the newly activated panel if needed
        populateEmojiCategoryIfNeeded(tabName);

         // Ensure search results panel is hidden when switching tabs
         if (emojiSearchResultsPanel) emojiSearchResultsPanel.classList.add('hidden');
         if (emojiNoResults) emojiNoResults.classList.add('hidden');
    }

    /** Toggles the visibility of the emoji picker and resets search. */
    function toggleEmojiPicker() {
        if (emojiPicker) {
             const isOpening = emojiPicker.classList.toggle('hidden');
             if (!isOpening) { // If opening (was hidden, now not)
                 // Reset search
                 if (emojiSearchInput) emojiSearchInput.value = '';
                 filterEmojis(); // Show default category panel

                 // Ensure the initially active tab is populated
                 const activeTabButton = emojiPicker.querySelector('#emoji-picker-tabs button.active');
                  if(activeTabButton && activeTabButton.id) {
                       const activeTabName = activeTabButton.id.substring(4);
                       populateEmojiCategoryIfNeeded(activeTabName);
                  }
             }
        }
    }

    /** Closes the emoji picker. */
    function closeEmojiPicker() {
        if (emojiPicker && !emojiPicker.classList.contains('hidden')) {
             emojiPicker.classList.add('hidden');
             // Optionally clear search on close too? Depends on desired UX.
             // if (emojiSearchInput) emojiSearchInput.value = '';
             // filterEmojis();
        }
    }

    /** Populates a specific category panel only if it's empty. */
    function populateEmojiCategoryIfNeeded(category) {
        const panel = getElement(`panel-${category}`);
        if (panel && panel.childElementCount === 0 && emojiCategories[category]) {
            populateEmojiPanel(panel, emojiCategories[category]);
        }
    }

    /** Filters emojis based on the search input. */
    function filterEmojis() {
        if (!emojiSearchInput || !emojiSearchResultsPanel || !emojiNoResults || !emojiKeywords) return;

        const searchTerm = emojiSearchInput.value.trim().toLowerCase();

        // Hide all category panels and the search panel initially
        querySelectorAll('#emoji-picker-panels .emoji-category-panel').forEach(panel => {
            panel.classList.add('hidden');
        });
        emojiNoResults.classList.add('hidden');

        if (searchTerm === '') {
            // If search is empty, show the active category tab
            const activeTabButton = querySelector('#emoji-picker-tabs button.active');
            if (activeTabButton && activeTabButton.id) {
                const activeTabName = activeTabButton.id.substring(4);
                const activeCategoryPanel = getElement(`panel-${activeTabName}`);
                if (activeCategoryPanel) {
                    activeCategoryPanel.classList.remove('hidden');
                    populateEmojiCategoryIfNeeded(activeTabName); // Ensure it's populated
                }
            } else {
                 // Fallback: show smileys if no tab is active?
                 const smileyPanel = getElement('panel-smileys');
                 if (smileyPanel) {
                     smileyPanel.classList.remove('hidden');
                     populateEmojiCategoryIfNeeded('smileys');
                 }
            }
            return; // Exit search mode
        }

        // Perform search
        const matchingEmojis = [];
        for (const emoji in emojiKeywords) {
            if (emojiKeywords[emoji].some(keyword => keyword.includes(searchTerm))) {
                matchingEmojis.push(emoji);
            }
            // Also check the emoji character itself
            else if (emoji.includes(searchTerm)) {
                 matchingEmojis.push(emoji);
            }
        }

        // Show search results panel
        emojiSearchResultsPanel.classList.remove('hidden');

        if (matchingEmojis.length > 0) {
            populateEmojiPanel(emojiSearchResultsPanel, matchingEmojis);
            emojiNoResults.classList.add('hidden'); // Hide "no results"
        } else {
            emojiSearchResultsPanel.innerHTML = ''; // Clear any old results
            emojiNoResults.classList.remove('hidden'); // Show "no results"
            // Must add the no results message back if cleared
             emojiSearchResultsPanel.appendChild(emojiNoResults);
        }
    }


    /** Finds emoji suggestions based on a keyword */
    function findEmojiSuggestions(keyword) {
        if (!keyword || keyword.length < 1 || !emojiKeywords) return []; // Minimum 1 char keyword

        const lowerKeyword = keyword.toLowerCase();
        const matches = [];

        for (const emoji in emojiKeywords) {
            // Prioritize keywords starting with the term
            if (emojiKeywords[emoji].some(kw => kw.toLowerCase().startsWith(lowerKeyword))) {
                matches.push(emoji);
            }
            // Allow matching the emoji character itself too (less common use case here)
            else if (emoji.startsWith(lowerKeyword)) {
                matches.push(emoji)
            }
        }
        // Limit number of suggestions shown? Optional. e.g., return matches.slice(0, 10);
        return matches;
    }

    /** Shows the emoji suggestion popup */
    function showEmojiSuggestions(suggestions, inputElement) {
        if (!emojiSuggestionPopup || !inputElement || suggestions.length === 0) {
            hideEmojiSuggestions();
            return;
        }

        emojiSuggestionPopup.innerHTML = ''; // Clear previous
        const fragment = document.createDocumentFragment();

        suggestions.forEach(emoji => {
            const button = document.createElement('button');
            button.type = 'button';
            button.textContent = emoji;
            button.dataset.emoji = emoji; // Store emoji for easy access
            button.title = (emojiKeywords[emoji]?.[0] || 'emoji'); // Basic title
            button.onclick = (e) => {
                e.preventDefault(); // Prevent form submission if any
                insertEmojiFromSuggestion(emoji, inputElement);
            };
            fragment.appendChild(button);
        });

        emojiSuggestionPopup.appendChild(fragment);

        // --- Positioning ---
        const inputRect = inputElement.getBoundingClientRect();
        // Position relative to the document, not viewport, accounting for scroll
        const inputTop = inputRect.top + window.scrollY;
        const inputLeft = inputRect.left + window.scrollX;

        emojiSuggestionPopup.style.position = 'absolute';
        // Place it above the input field
        emojiSuggestionPopup.style.top = `${inputTop - emojiSuggestionPopup.offsetHeight - 4}px`; // Position above + margin
        emojiSuggestionPopup.style.left = `${inputLeft}px`; // Align left

        emojiSuggestionPopup.classList.remove('hidden');
        isSuggestionPopupVisible = true;

        // --- Adjust if off-screen (optional enhancement) ---
        requestAnimationFrame(() => {
             const popupRect = emojiSuggestionPopup.getBoundingClientRect();
             const viewportWidth = window.innerWidth;
             if (popupRect.right > viewportWidth - 10) {
                 // If it overflows right, align it to the right edge of the input instead
                 emojiSuggestionPopup.style.left = `${inputRect.right + window.scrollX - popupRect.width}px`;
             }
             if (popupRect.left < 10) {
                 emojiSuggestionPopup.style.left = `${10 + window.scrollX}px`; // Ensure min left margin
             }
             // Check top boundary if needed (less likely for a single row)
             if (popupRect.top < 10 + window.scrollY) {
                 // If not enough space above, maybe show below? (More complex)
                 // For now, we assume enough space above.
                 emojiSuggestionPopup.style.top = `${10 + window.scrollY}px`;
             }
        });
    }

    /** Hides the emoji suggestion popup */
    function hideEmojiSuggestions() {
        if (emojiSuggestionPopup) {
            emojiSuggestionPopup.classList.add('hidden');
        }
        isSuggestionPopupVisible = false;
        currentSuggestionKeyword = '';
    }

    /** Replaces the keyword in the input with the selected emoji */
    function insertEmojiFromSuggestion(emoji, inputElement) {
        if (!inputElement || !currentSuggestionKeyword) return;

        const currentValue = inputElement.value;
        const keywordPattern = `:${currentSuggestionKeyword}`;
        const lastColonIndex = currentValue.lastIndexOf(':'); // Find where the suggestion started

        // Ensure we're replacing the correct pattern instance
        if (lastColonIndex !== -1 && currentValue.substring(lastColonIndex).startsWith(keywordPattern)) {
             const before = currentValue.substring(0, lastColonIndex);
             const after = currentValue.substring(lastColonIndex + keywordPattern.length);
             const newValue = before + emoji + after;

             inputElement.value = newValue;

             // Set cursor position after the inserted emoji
             const newCursorPos = lastColonIndex + [...emoji].length; // Use spread for multi-byte chars
             inputElement.focus();
             inputElement.setSelectionRange(newCursorPos, newCursorPos);
        }

        hideEmojiSuggestions();

        // Trigger input event manually if needed, e.g., for frameworks or other listeners
        inputElement.dispatchEvent(new Event('input', { bubbles: true }));
    }

    /** Handles input changes for inline emoji suggestions */
    function handleInlineEmojiInput(event) {
        const input = event.target;
        const value = input.value;
        const cursorPos = input.selectionStart;

        const lastColonIndex = value.lastIndexOf(':');

        // Check if cursor is immediately after a potential keyword
        if (lastColonIndex !== -1 && cursorPos > lastColonIndex + 1) {
            const potentialKeyword = value.substring(lastColonIndex + 1, cursorPos);
            // Check if the keyword contains spaces or colons - if so, it's not a valid pattern
            if (!/\s|:/.test(potentialKeyword)) {
                currentSuggestionKeyword = potentialKeyword; // Store the current keyword
                const suggestions = findEmojiSuggestions(potentialKeyword);
                if (suggestions.length > 0) {
                    showEmojiSuggestions(suggestions, input);
                } else {
                    hideEmojiSuggestions();
                }
                return; // Found a pattern, processed it.
            }
        }

        // If no valid pattern at cursor, hide suggestions
        hideEmojiSuggestions();
    }

    /** Handles keydown events for inline emoji suggestions (specifically Enter) */
    function handleInlineEmojiKeyDown(event) {
        // Handle Enter key when suggestions are visible
        if (event.key === 'Enter' && isSuggestionPopupVisible && emojiSuggestionPopup && emojiSuggestionPopup.children.length > 0) {
            event.preventDefault(); // IMPORTANT: Prevent default newline/form submission

            const firstSuggestionButton = emojiSuggestionPopup.querySelector('button');
            if (firstSuggestionButton) {
                const firstEmoji = firstSuggestionButton.dataset.emoji;
                const inputElement = event.target;

                // --- Replace keyword with emoji ---
                const currentValue = inputElement.value;
                const keywordPattern = `:${currentSuggestionKeyword}`;
                const lastColonIndex = currentValue.lastIndexOf(':'); // Find where suggestion started

                if (lastColonIndex !== -1 && currentValue.substring(lastColonIndex).startsWith(keywordPattern)) {
                    const before = currentValue.substring(0, lastColonIndex);
                    const after = currentValue.substring(lastColonIndex + keywordPattern.length);
                    const newValue = before + firstEmoji + after; // Note: Use firstEmoji here

                    inputElement.value = newValue;

                    // Set cursor position after the inserted emoji
                    const newCursorPos = lastColonIndex + [...firstEmoji].length;
                    // Focus might already be there, but ensure range is set correctly
                    inputElement.focus();
                    inputElement.setSelectionRange(newCursorPos, newCursorPos);

                    // Manually trigger input event AFTER setting value and cursor
                    inputElement.dispatchEvent(new Event('input', { bubbles: true }));
                }
                 // --- --- --- --- --- --- ---

                 hideEmojiSuggestions(); // Hide popup after selection

                 // --- Send the message ---
                 sendMessage();
                 // --- --- --- --- --- ---

            } else {
                 // No suggestion button found? Hide popup and allow default Enter.
                 hideEmojiSuggestions();
            }

        }
        // Handle Escape key to close suggestions
        else if (event.key === 'Escape' && isSuggestionPopupVisible) {
             event.preventDefault();
             hideEmojiSuggestions();
        }
        // You could add Arrow key navigation here later if desired
    }

     /** Handles keyup/mouseup to check if cursor moved out of suggestion range */
     function checkCursorForSuggestions(event) {
         if (isSuggestionPopupVisible) {
             // Re-run the logic from handleInlineEmojiInput to see if the pattern is still valid at the cursor
             handleInlineEmojiInput({ target: event.target });
         }
     }


    // --- Socket.IO Event Handlers ---

    /** Sets up all Socket.IO event listeners. */
    function setupSocketEventListeners() {
        // --- Connection Lifecycle ---
        socket.on('connect', () => {
            console.log("Socket Connected:", socket.id);
            socket.emit('request_initial_counts'); // Get unread counts

            loadUsersWithPreviews().then(() => {
                if (receiverId && currentReceiverUser) {
                    joinChat(receiverId, currentReceiverUser); // Re-join active chat
                } else {
                    showNoChatState(); // Ensure clean state
                }
                if(messageInput) { messageInput.placeholder = "Type a message..."; messageInput.disabled = false; }
                if(sendButton) sendButton.disabled = false;
                startAllUsersStatusUpdates(); // Resume status polling
                startChatPreviewPolling(); // Resume preview polling
                isInitialLoadComplete = true;
            }).catch(error => {
                 console.error("Error loading users after connect:", error);
                 if(userListContainer) userListContainer.innerHTML = `<p class="p-4 text-red-500">Error loading chats.</p>`;
                 isInitialLoadComplete = true; // Mark complete even on error
            });
        });

        socket.on('disconnect', (reason) => {
            console.log("Socket Disconnected:", reason);
            isInitialLoadComplete = false;
            sendStopTypingEvent();
            stopActiveChatStatusUpdates();
            stopAllUsersStatusUpdates();
            stopChatPreviewPolling();
            if (chatUserStatusElement && receiverId) updateChatHeaderStatusUI('<b><span class="text-orange-500">Offline - Reconnecting...</span></b>');
            if(messageInput) { messageInput.placeholder = "Disconnected..."; messageInput.disabled = true; }
            if(sendButton) sendButton.disabled = true;
        });

        socket.on('connect_error', (error) => {
            console.error('Socket Connection Error:', error);
            isInitialLoadComplete = false;
             if (chatUserStatusElement && receiverId) updateChatHeaderStatusUI('<b><span class="text-red-500">Connection failed</span></b>');
             if(messageInput) { messageInput.placeholder = "Connection failed."; messageInput.disabled = true; }
             if(sendButton) sendButton.disabled = true;
             // Show error in user list?
        });


        // --- Messaging Events ---
        socket.on('receive_message', (msgData) => {
            const partnerId = msgData.sender_id === currentUserId ? msgData.receiver_id : msgData.sender_id;

            // Handle confirmation of own sent message (match localId)
            if (msgData.sender_id === currentUserId && msgData.localId) {
                const localMsgElement = getElement(`message-${msgData.localId}`);
                if (localMsgElement) {
                     localMsgElement.id = `message-${msgData.id}`; // Update element ID
                     localMsgElement.setAttribute('data-message-id', msgData.id); // Update data attribute
                     const statusIconSpan = localMsgElement.querySelector('.message-status-icon');
                     if (statusIconSpan) statusIconSpan.innerHTML = getSeenIconHTML(false); // Show delivered icon
                     // Update sidebar snippet for own sent message
                     const sentToListitem = querySelector(`.user-list-item[data-user-id='${msgData.receiver_id}']`);
                     if(sentToListitem) updateUserListSnippet(sentToListitem, msgData);
                }
                return; // Don't process further or play sound
            }

            // Process incoming messages from others
            const isActiveChat = receiverId && partnerId === receiverId;
            const userListItem = querySelector(`.user-list-item[data-user-id='${partnerId}']`);

            if (isActiveChat) {
                addMessageToBox(msgData);
                scrollToBottom();
                if (socket.connected) {
                    socket.emit('mark_chat_read', { sender_id: partnerId }); // Mark as read immediately
                }
            } else {
                // Background chat: Update snippet & play sound (badge handled by 'update_unread_count')
                if (userListItem) {
                     updateUserListSnippet(userListItem, msgData);
                     // Move to top
                     if (userListContainer && userListItem !== userListContainer.firstChild) {
                         userListContainer.insertBefore(userListItem, userListContainer.firstChild);
                     }
                }
                if (isInitialLoadComplete) {
                     playNotificationSound();
                }
            }
        });

        socket.on('message_seen', (data) => { // Confirmation that *your* message was seen
            if (!data || !data.message_id) return;
            const messageElement = getElement(`message-${data.message_id}`);
            if (messageElement && messageElement.getAttribute('data-sender-id') == currentUserId) { // Check it's our message
                const statusIconSpan = messageElement.querySelector('.message-status-icon');
                if (statusIconSpan) {
                     statusIconSpan.innerHTML = getSeenIconHTML(true); // Show read icon (double blue)
                }
            }
        });

        socket.on('message_deleted', (data) => { // Message deleted by sender
            if (!data || !data.message_id) return;
            const messageId = data.message_id;
            const newContent = "[This message was deleted]";
            const isoTimestamp = data.date; // Server sends ISO timestamp

            const messageElement = getElement(`message-${messageId}`);
            if (messageElement) {
                const contentDisplay = messageElement.querySelector('.message-content-display');
                const bubble = messageElement.querySelector('.message-bubble');
                const timeSpan = messageElement.querySelector('.text-xs span:first-child'); // Timestamp span
                const statusIcon = messageElement.querySelector('.message-status-icon');
                const mediaContent = messageElement.querySelector('img, .media-trigger, a[target="_blank"]'); // Find media
                const optionsTrigger = messageElement.querySelector('.message-options-trigger');

                if(contentDisplay) contentDisplay.textContent = newContent;
                if(mediaContent) mediaContent.remove();
                if(optionsTrigger) optionsTrigger.remove(); // Remove options trigger

                // Update styles for deleted bubble
                if(bubble) {
                    bubble.className = bubble.className.replace(/bg-\w+-\d+/g, '').replace(/dark:bg-\w+-\d+/g, ''); // Remove color classes
                    bubble.classList.add('italic', 'text-gray-500', 'dark:text-gray-400', 'bg-gray-100', 'dark:bg-gray-800', 'border', 'border-dashed', 'border-gray-300', 'dark:border-gray-600');
                    bubble.title = "Message deleted"; // Update title
                }
                if (statusIcon) statusIcon.innerHTML = '<i class="fas fa-ban mr-1 text-gray-400"></i>'; // Replace seen status with ban icon
                if (timeSpan && isoTimestamp) {
                   try { timeSpan.textContent = new Date(isoTimestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }
                   catch(e) { /* ignore date format error */ }
                }

                messageElement.setAttribute('data-is-deleted', 'true');
                messageElement.setAttribute('data-content', '');

                // Update sidebar snippet if this was the latest message
                const senderId = parseInt(messageElement.getAttribute('data-sender-id'));
                const partnerId = senderId === currentUserId ? parseInt(messageElement.closest('.message-container').parentElement.dataset.receiverId || receiverId) : senderId;
                const userListItem = querySelector(`.user-list-item[data-user-id='${partnerId}']`);
                 if (userListItem) {
                     try {
                         const storedData = JSON.parse(userListItem.dataset.userData || '{}');
                         if(storedData.latest_message_timestamp_iso === isoTimestamp) {
                            updateUserListSnippet(userListItem, {
                                 sender_id: senderId, content: newContent, media_url: null, timestamp: isoTimestamp, deleted_for_everyone: true
                            });
                         }
                     } catch(e) { console.error("Error updating snippet for deleted message:", e); }
                 }
            }
        });

        // --- Unread Count & Status ---
        socket.on('update_unread_count', (data) => {
             if (data && data.sender_id != null && data.unread_count != null) {
                 const userListItem = querySelector(`.user-list-item[data-user-id='${data.sender_id}']`);
                 if (userListItem) updateUserUnreadBadge(userListItem, data.unread_count);
             }
        });

         socket.on('initial_counts_response', (countsMap) => {
             if (countsMap && typeof countsMap === 'object') {
                 Object.entries(countsMap).forEach(([senderId, count]) => {
                     const userListItem = querySelector(`.user-list-item[data-user-id='${senderId}']`);
                     if (userListItem) updateUserUnreadBadge(userListItem, count);
                 });
             }
         });

         socket.on('initial_counts_error', (data) => {
             console.error("Error fetching initial counts:", data.error);
         });


        // --- Typing Indicators ---
        socket.on('user_typing', (data) => {
            if (chatUserStatusElement && currentReceiverUser && data.sender_id === currentReceiverUser.id) {
                if (!chatUserStatusElement.querySelector('.typing-indicator')) {
                    updateChatHeaderStatusUI(`<b><span class="text-${userColorScheme}-500 dark:text-${userColorScheme}-400 animate-pulse typing-indicator">typing...</span></b>`);
                }
            }
        });

        socket.on('user_stopped_typing', (data) => {
            if (chatUserStatusElement && currentReceiverUser && data.sender_id === currentReceiverUser.id) {
                if (chatUserStatusElement.querySelector('.typing-indicator')) {
                    updateChatHeaderStatusUI(originalStatusHTML); // Restore original status
                }
            }
        });


        // --- Ping Event ---
        socket.on('receive_ping', (data) => {
            if (pingSound) {
                 pingSound.currentTime = 0;
                 pingSound.play().catch(e => console.error("Ping sound error:", e));
            }
            showTemporaryPingNotification(data.sender_name || 'Someone');
        });

        // --- User seen Updates ---
socket.on('messages_marked_seen_by_recipient', (data) => {
    if (!data || !data.reader_id) {
        console.warn("[Seen Status] Received invalid 'messages_marked_seen_by_recipient' data:", data);
        return;
    }
    const readerId = data.reader_id;

    // Only update icons if the person who read the messages is the
    // person we are currently chatting with.
    if (readerId === receiverId && chatBox) {
        // Find all message elements sent BY the current user TO the reader
        const sentMessages = chatBox.querySelectorAll(`.message-container[data-sender-id='${currentUserId}']`);

        sentMessages.forEach(msgElement => {
            const msgId = msgElement.getAttribute('data-message-id');
            if (!msgId || msgId.startsWith('local_')) return; // Skip unconfirmed messages

            const statusIconSpan = msgElement.querySelector('.message-status-icon');
            if (statusIconSpan) {
                // Check if it's already blue (or whatever the 'seen' state is)
                // A simple check: if it doesn't contain 'blue', update it.
                // You could add a specific class later for better state tracking.
                const currentIconHTML = statusIconSpan.innerHTML;
                const seenIconHTML = getSeenIconHTML(true); // Get the 'seen' icon HTML

                if (currentIconHTML !== seenIconHTML) {
                     statusIconSpan.innerHTML = seenIconHTML;
                     // Optional: Add a subtle animation/transition class here
                     // statusIconSpan.classList.add('animate-fade-in'); // Example animation
                }
            }
        });
    }
});

// --- End of new listener ---
        // --- End of Socket.IO event listeners ---

    }


    // --- UI Event Listeners ---

    /** Sets up listeners for static elements (buttons, inputs, etc.). */
    function setupStaticEventListeners() {
        // Dark Mode Toggle
        if (darkModeToggle) {
            darkModeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.theme = isDark ? 'dark' : 'light';
            });
        }

        // User Info Modal Triggers & Close
        if (modalCloseBtn) modalCloseBtn.addEventListener('click', closeUserInfoModal);
        if (userInfoModal) userInfoModal.addEventListener('click', (event) => { if (event.target === userInfoModal) closeUserInfoModal(); }); // Overlay click
        if (chatUsernameElement) chatUsernameElement.addEventListener('click', openUserInfoModal);
        if (chatUserStatusElement) chatUserStatusElement.addEventListener('click', openUserInfoModal);

        // Chat Header Options Dropdown
        if (optionsDropdownButton) optionsDropdownButton.addEventListener('click', (event) => { event.stopPropagation(); toggleOptionsDropdown(); });

        // Emoji Picker Toggle & Tabs
        if (emojiButton) emojiButton.addEventListener('click', (event) => { event.stopPropagation(); toggleEmojiPicker(); });
        const emojiTabButtons = querySelectorAll('#emoji-picker-tabs button.emoji-tab-button');
        emojiTabButtons.forEach(button => {
             if (button.id) button.addEventListener('click', () => switchEmojiTab(button.id.substring(4)));
        });

        // *** NEW: Emoji Search Input Listener ***
        if (emojiSearchInput) {
            emojiSearchInput.addEventListener('input', debouncedFilterEmojis);
            // Prevent enter key in search from sending chat message
            emojiSearchInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                }
            });
        }

        // Sidebar Tabs & Floating Button
        const sidebarTabs = querySelectorAll('#sidebar-tabs button');
        sidebarTabs.forEach(button => {
            button.addEventListener('click', () => {
                sidebarTabs.forEach(btn => btn.classList.remove('active-tab'));
                button.classList.add('active-tab');
                const tabId = button.id;
                 if (userListContainer) {
                    userListContainer.innerHTML = `<p class="p-4 text-center text-gray-500 dark:text-gray-300 animate-pulse">Loading...</p>`;
                    if (tabId === 'tab-chats') {
                        if(socket.connected) loadUsersWithPreviews();
                        else userListContainer.innerHTML = '<p class="p-4 text-center text-gray-500">Connecting...</p>';
                    } else if (tabId === 'tab-connect') {
                        userListContainer.innerHTML = '<p class="p-4 text-center text-gray-500">Connect (Coming Soon)</p>';
                    } else if (tabId === 'tab-more') {
                         userListContainer.innerHTML = '<p class="p-4 text-center text-gray-500">More (Coming Soon)</p>';
                    }
                 }
                if (floatingConnectButton) floatingConnectButton.classList.toggle('hidden', tabId !== 'tab-chats');
            });
        });
        if (floatingConnectButton) floatingConnectButton.addEventListener('click', () => { getElement('tab-connect')?.click(); });

        // Send Button & Message Input Listeners
        if (sendButton) sendButton.addEventListener('click', sendMessage);
        if (messageInput) {
            // --- Standard Enter Key (modified slightly) ---
            messageInput.addEventListener('keydown', (event) => {
                 // Allow default Enter if Shift is pressed OR if suggestion popup handles it
                 if (event.key === 'Enter' && !event.shiftKey && !isSuggestionPopupVisible) {
                     event.preventDefault();
                     sendMessage();
                 }
                 // --- Let suggestion handler take priority for Enter ---
                 handleInlineEmojiKeyDown(event);
            });

            // --- Typing indicator listener (no change needed) ---
            messageInput.addEventListener('input', () => {
                if (!receiverId || !socket.connected) return;
                if (!isTyping) {
                    isTyping = true; socket.emit('typing', { receiver_id: receiverId });
                }
                clearTimeout(typingTimer);
                typingTimer = setTimeout(sendStopTypingEvent, TYPING_TIMER_LENGTH);

                 // --- Handle inline suggestions on input ---
                 handleInlineEmojiInput(event); // Check for suggestions on every input
            });

            // --- Stop typing on blur (no change needed) ---
            messageInput.addEventListener('blur', () => {
                 sendStopTypingEvent();
                 // Hide suggestions slight delay to allow clicking a suggestion
                 setTimeout(hideEmojiSuggestions, 150);
            });

             // --- Check suggestions on cursor move ---
             messageInput.addEventListener('keyup', checkCursorForSuggestions); // Arrow keys, backspace etc.
             messageInput.addEventListener('mouseup', checkCursorForSuggestions); // Mouse clicks
        }

        // Media Input Trigger
        const mediaAttachButton = querySelector('button[onclick*="media-input"]');
        if (mediaAttachButton) mediaAttachButton.onclick = () => mediaInput?.click(); // Re-assign cleaner trigger
        if (mediaInput) mediaInput.addEventListener('change', handleMediaFileSelect);

        // Media Preview Modal Buttons
        if(mediaPreviewSend) mediaPreviewSend.addEventListener('click', handlePreviewSend);
        if(mediaPreviewCancel) mediaPreviewCancel.addEventListener('click', closeMediaPreview);

        // Ping Button
        if (pingUserButton) pingUserButton.addEventListener('click', handlePingButtonClick);

        // Mobile Back Button
        if(backToUsersButton) {
             backToUsersButton.addEventListener('click', showNoChatState);
        }

        // Global Click Listener (Modified)
        document.addEventListener('click', (event) => {
            if (optionsDropdown && !optionsDropdown.contains(event.target) && event.target !== optionsDropdownButton) closeOptionsDropdown();
            if (emojiPicker && !emojiPicker.contains(event.target) && event.target !== emojiButton && !emojiButton?.contains(event.target) ) closeEmojiPicker();
            // --- Hide inline suggestions if click is outside input and popup ---
            if (emojiSuggestionPopup && !emojiSuggestionPopup.contains(event.target) && event.target !== messageInput) {
                 hideEmojiSuggestions();
            }
            // Message options dropdown closed by handleChatBoxClick or handleMessageOptionClick
        });
    }

    /** Sets up listeners related to window focus/blur events. */
    function setupWindowFocusListeners() {
        window.addEventListener('focus', () => {
            if (socket.connected) {
                if (receiverId) {
                    fetchAndUpdateStatus(receiverId);
                    startActiveChatStatusUpdates();
                    socket.emit('mark_chat_read', { sender_id: receiverId }); // Mark active chat read on focus
                }
                startAllUsersStatusUpdates();
                startChatPreviewPolling(); // Resume polling previews
            } else {
                // Optionally attempt connection or show disconnected state clearly
            }
        });

        window.addEventListener('blur', () => {
            stopActiveChatStatusUpdates();
            stopAllUsersStatusUpdates();
            stopChatPreviewPolling(); // Stop polling previews
            sendStopTypingEvent();
        });
    }

    /** Sets up the delegated event listener for the chat box area (messages, media). */
    function setupChatInteractionListener() {
        if (!chatBox) return;

        // Delegated listener for clicks within the chat box
        chatBox.addEventListener('click', (event) => {
            const clickedMediaViewerOverlay = event.target === mediaViewerModal;
            const clickedInsideMediaViewerContent = event.target.closest('#media-viewer-modal .relative');
            const clickedInsideOptionsDropdown = event.target.closest('#message-options-dropdown');

            // Handle Media Viewer clicks first
            if (mediaViewerModal && !mediaViewerModal.classList.contains('hidden')) {
                if (clickedMediaViewerOverlay) { closeMediaModal(); return; }
                if (clickedInsideMediaViewerContent) { return; } // Let internal elements handle it
            }

            // Ignore clicks inside the options dropdown itself
            if (clickedInsideOptionsDropdown) { return; }

            // Check for Media Trigger Click
            const mediaTrigger = event.target.closest('.media-trigger');
            if (mediaTrigger) {
                const type = mediaTrigger.dataset.mediaType;
                const src = mediaTrigger.dataset.mediaSrc;
                if (type && src) {
                    event.stopPropagation();
                    openMediaModal(src, type);
                    closeMessageOptionsDropdown(); // Close options if open
                    return;
                }
            }

            // Check for Message Options Trigger or Bubble Text Click
            const messageContainer = event.target.closest('.message-container');
            if (messageContainer) {
                 const optionsTrigger = event.target.closest('.message-options-trigger');
                 const bubbleClickTarget = event.target.closest('.message-bubble');
                 // Check if clicking the bubble itself (not media, links, or trigger)
                 const isBubbleTextClick = bubbleClickTarget && !mediaTrigger && !event.target.closest('a') && !optionsTrigger;

                 if (optionsTrigger || isBubbleTextClick) {
                      event.stopPropagation();
                      openMessageOptionsDropdown(event, messageContainer);
                      return;
                 }
            }

            // If click was outside any interactive element, close the message options dropdown
            closeMessageOptionsDropdown();
        });

        // Listener for clicks *inside* the options dropdown
        if (messageOptionsDropdown) {
            messageOptionsDropdown.addEventListener('click', handleMessageOptionClick);
        }

        // Listener for the media viewer close button
        if (mediaViewerCloseBtn) {
             mediaViewerCloseBtn.addEventListener('click', closeMediaModal);
        }
    }


    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        // Assign major DOM elements
        userListContainer = getElement('user-list');
        chatBox = getElement('chat-box');
        chatHeader = getElement('chat-header');
        chatInputBar = getElement('chat-input-bar');
        messageInput = getElement('message-input');
        sendButton = getElement('send-btn');
        chatUsernameElement = getElement('chat-username');
        chatUserPicElement = getElement('chat-user-pic');
        chatUserStatusElement = getElement('chat-user-status');
        noChatMessageElement = getElement('no-chat-message');
        backToUsersButton = getElement('backToUsers'); // Mobile only
        darkModeToggle = getElement('darkModeToggle');
        optionsDropdownButton = getElement('optionsDropdownButton');
        optionsDropdown = getElement('optionsDropdown');
        userInfoModal = getElement('user-info-modal');
        userInfoModalContent = getElement('user-info-modal-content');
        modalCloseBtn = getElement('modal-close-btn');
        emojiButton = getElement('emoji-button');
        emojiPicker = getElement('emoji-picker');
        mediaInput = getElement('media-input');
        mediaPreviewModal = getElement('media-preview-modal');
        mediaPreviewDialog = getElement('media-preview-dialog');
        mediaPreviewImage = getElement('media-preview-image');
        mediaPreviewVideo = getElement('media-preview-video');
        mediaPreviewError = getElement('media-preview-error');
        mediaPreviewCaption = getElement('media-preview-caption');
        mediaPreviewSend = getElement('media-preview-send');
        mediaPreviewCancel = getElement('media-preview-cancel');
        mediaViewerModal = getElement('media-viewer-modal');
        mediaViewerImage = getElement('media-viewer-image');
        mediaViewerVideo = getElement('media-viewer-video');
        mediaViewerCloseBtn = getElement('media-viewer-close');
        mediaViewerLoading = getElement('media-viewer-loading');
        messageOptionsDropdown = getElement('message-options-dropdown');
        notificationSound = getElement('notification-sound');
        pingSound = getElement('ping-sound');
        pingUserButton = getElement('pingUserButton');
        floatingConnectButton = getElement('switchToConnectBtn');
        chatAreaContainer = getElement('chat-area-container'); // Used for mobile view toggle
        sidebarContainer = querySelector('aside'); // Used for mobile view toggle
        emojiSearchInput = getElement('emoji-search-input'); 
        emojiSearchResultsPanel = getElement('panel-search-results'); 
        emojiNoResults = getElement('emoji-no-results'); 
        emojiSuggestionPopup = getElement('emoji-suggestion-popup'); 

        // Check for critical elements
        if (!chatBox || !userListContainer || !messageInput || !messageOptionsDropdown || !emojiPicker || !emojiSearchInput || !emojiSuggestionPopup) { // Added suggestion popup check
            console.error("CRITICAL INIT ERROR: Essential chat/emoji elements not found. Check IDs.");
            document.body.innerHTML = "<p style='color: red; padding: 20px;'>Error: Chat interface failed to load. Please refresh.</p>";
            return; // Stop further initialization
        }

        // Set Initial UI State
        showNoChatState();
        switchEmojiTab('smileys'); // Set initial emoji tab
        const initialActiveSidebarTab = querySelector('#sidebar-tabs button.active-tab');
        if (floatingConnectButton) floatingConnectButton.classList.toggle('hidden', initialActiveSidebarTab?.id !== 'tab-chats'); // Show/hide FAB

        // Setup Listeners
        setupStaticEventListeners();
        setupSocketEventListeners(); // Connects and loads initial data
        setupWindowFocusListeners();
        setupChatInteractionListener(); // For chat box interactions

        console.log("Chat UI Initialized. Waiting for socket connection...");
    });

</script>

</body>
</html>